using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
    #region HREmployeeContracts
    //-----------------------------------------------------------
    //Generated By: Expert Studio
    //Class:HREmployeeContractsController
    //Created Date:09 Tháng Giêng 2013
    //-----------------------------------------------------------

    public class HREmployeeContractsController : BaseBusinessController
    {
        public HREmployeeContractsController()
        {
            dal = new DALBaseProvider("HREmployeeContracts", typeof(HREmployeeContractsInfo));
        }

        #region Lấy tất cả các hợp đồng mà có ngày tạo, ngày bắt đầu, ngày kết thúc --Vinh --12/03/2013

        public DataSet GetAllEmployeeContractByCreateDateANDStartDateANDEndDate(String strNo, int iEmployeeID, DateTime? dtDateFrom, DateTime? dtDateTo, DateTime? dtStartFrom, DateTime? dtStartTo, DateTime? dtEndFrom, DateTime? dtEndTo)
        {
            String strContractNo = "";
            if (!String.IsNullOrEmpty(strNo))
            {
                strContractNo = String.Format(@" AND HREmployeeContractNo = '{0}'", strNo);
            }

            String strDate = "";
            if (dtDateFrom != null && dtDateTo != null && dtDateFrom.HasValue && dtDateTo.HasValue)
            {
                strDate = String.Format(@"  AND (CONVERT(VARCHAR(10), HREmployeeContractDate, 112)>= CONVERT(VARCHAR(10), '{0}', 112))
                                            AND (CONVERT(VARCHAR(10), HREmployeeContractDate, 112)<= CONVERT(VARCHAR(10), '{1}', 112))
                                            ", ((DateTime)dtDateFrom).ToString("yyyyMMdd"), ((DateTime)dtDateTo).ToString("yyyyMMdd"));
            }

            String strStart = "";
            if (dtStartFrom != null && dtStartTo != null && dtStartFrom.HasValue && dtStartTo.HasValue)
            {
                strStart = String.Format(@"  AND (CONVERT(VARCHAR(10), HREmployeeContractStartAppDate, 112)>= CONVERT(VARCHAR(10), '{0}', 112))
                                            AND (CONVERT(VARCHAR(10), HREmployeeContractStartAppDate, 112)<= CONVERT(VARCHAR(10), '{1}', 112))
                                            ", ((DateTime)dtStartFrom).ToString("yyyyMMdd"), ((DateTime)dtStartTo).ToString("yyyyMMdd"));
            }

            String strEnd = "";
            if (dtEndFrom != null && dtEndTo != null && dtEndFrom.HasValue && dtEndTo.HasValue)
            {
                strEnd = String.Format(@"  AND (CONVERT(VARCHAR(10), HREmployeeContractEndAppDate, 112)>= CONVERT(VARCHAR(10), '{0}', 112))
                                            AND (CONVERT(VARCHAR(10), HREmployeeContractEndAppDate, 112)<= CONVERT(VARCHAR(10), '{1}', 112))
                                            ", ((DateTime)dtEndFrom).ToString("yyyyMMdd"), ((DateTime)dtEndTo).ToString("yyyyMMdd"));
            }

            String str = String.Format(@"SELECT * FROM HREmployeeContracts WHERE AAStatus='Alive'
                                        {0}
                                        AND (FK_HREmployeeID = {1} OR {1} = 0)
                                        {2}
                                        {3}
                                        {4}", strContractNo, iEmployeeID, strDate, strStart, strEnd);

            return dal.GetDataSet(str);
        }

        #endregion

        #region Lấy tất cả các hợp đồng mà có ngày tạo, ngày bắt đầu, ngày kết thúc --Vinh --12/03/2013

        public HREmployeeContractsInfo GetEmployeeContractByDate(int iEmployeeID, DateTime dt)
        {
            String str = String.Format(@"   SELECT * FROM HREmployeeContracts WHERE AAStatus='Alive'
                                            AND (FK_HREmployeeID = {0} OR {0} = 0)
                                            AND 
                                            (
	                                            (
		                                            YEAR(HREmployeeContractStartAppDate) * 12 + MONTH(HREmployeeContractStartAppDate) <= {1}
		                                            AND
		                                            HREmployeeContractEndAppDate IS NULL
	                                            )
	                                            OR
	                                            (
		                                            YEAR(HREmployeeContractStartAppDate) * 12 + MONTH(HREmployeeContractStartAppDate) <= {1}
		                                            AND 
		                                            YEAR(HREmployeeContractEndAppDate) * 12 + MONTH(HREmployeeContractEndAppDate) >= {1}
	                                            )
                                            )
                                            ", iEmployeeID, dt.Year * 12 + dt.Month);

            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return (HREmployeeContractsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }
            return null;
        }

        #endregion

        #region Lấy tất cả các hợp đồng mà Active --Vinh --20/03/2013

        public HREmployeeContractsInfo GetEmployeeContractByActive(int iEmployeeID)
        {
            String str = String.Format(@"   SELECT * FROM HREmployeeContracts WHERE AAStatus='Alive'
                                            AND (FK_HREmployeeID = {0} OR {0} = 0)
                                            AND HREmployeeContractActiveCheck = 1
                                            ORDER BY HREmployeeContractID DESC
                                            ", iEmployeeID);

            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return (HREmployeeContractsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }
            return null;
        }

        #endregion
        
        public DataSet GetAllDataByContractAndStartDateAndEmployee(int iLoaiHopDong, DateTime dateFrom, DateTime dateTo, int iEmployee)
        {
            String strDate = DALUtil.GenerateBeetween("HREmployeeContractStartAppDate", dateFrom, dateTo);

            String strQuery = String.Format(@"SELECT * 
                                                FROM HREmployeeContracts 
                                                WHERE AAStatus='Alive'
                                                AND (FK_HREmployeeID={0} OR 0={0})
                                                AND (FK_HRContractID={1} OR 0={1})
                                                AND {2}", iEmployee, iLoaiHopDong, strDate);
            return GetDataSet(strQuery);

        }

        #region Tao ma hop dong --Trung--15/08/2013
        public int GetExtenNo(String strSuffix, int iExtenLenght)
        {
            String strQuery = String.Format(@"drop table Temp1
                                                
                                                SELECT ISNUMERIC( LEFT(HREmployeeContractNo, {0})) AS isNumber,  LEFT(HREmployeeContractNo, {0}) AS ExtenNo
                                                            into Temp1
                                                FROM HREmployeeContracts
                                                WHERE AAStatus = 'Alive'
                                                AND HREmployeeContractNo LIKE N'%{1}'

                                                select isNull(MAX(CAST(ExtenNo AS FLOAT)), 0) from Temp1
                                                WHERE isNumber = 1
                                            ", iExtenLenght, strSuffix);

            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToInt32(ds.Tables[0].Rows[0][0]);

            return 0;

        }
        #endregion

        #region Lấy hợp đồng nhân viên theo Loại Hợp đồng --Vinh --2013-11-06

        public HREmployeeContractsInfo GetAllDataByContractAndStartDateAndEmployee(String strHRContractType, DateTime dtFrom, DateTime dtTo, int iHREmployeeID)
        {
            String strDate = DALUtil.GenerateBeetween("HREmployeeContractStartAppDate", dtFrom, dtTo);

            String strQuery = String.Format(@"  SELECT * 
                                                FROM HREmployeeContracts 
                                                WHERE AAStatus='Alive'
                                                AND (FK_HREmployeeID={0} OR 0={0})
                                                AND FK_HRContractID IN (
							                                                SELECT HRContractID FROM dbo.HRContracts
                                                                            JOIN dbo.HRContractTypes ON 
                                                                            (HRContractTypes.AAStatus = HRContracts.AAStatus AND HRContractTypes.HRContractTypeID = HRContracts.FK_HRContractTypeID)
                                                                            WHERE HRContracts.AAStatus = 'Alive'
                                                                            AND HRContractTypes.HRContractTypeNo = '{1}'
						                                                )
                                                AND
                                                (
                                                    (
													    YEAR(HREmployeeContractStartAppDate)*12 + MONTH(HREmployeeContractStartAppDate) <= {2}
													    AND HREmployeeContractEndAppDate IS NULL
												    )
												    OR
												    (
													    YEAR(HREmployeeContractStartAppDate)*12 + MONTH(HREmployeeContractStartAppDate) <= {2}
													    AND
													    YEAR(HREmployeeContractEndAppDate)*12 + MONTH(HREmployeeContractEndAppDate) >= {3}
		                                            )
                                                )", iHREmployeeID, strHRContractType, dtFrom.Year * 12 + dtFrom.Month, dtTo.Year * 12 + dtTo.Month);

            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return (HREmployeeContractsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }

            return null;
        }

        #endregion
        //
        public DataSet GetContractByFDateTDateAndEmployee(int iEmployee,DateTime dateFrom, DateTime dateTo)
        {
            String strQuery = String.Format(@"SELECT *
                                             FROM   dbo.HREmployeeContracts
                                             WHERE  HREmployeeContracts.AAStatus = 'Alive'
                                                    AND FK_HREmployeeID = {0}
                                                    AND HREmployeeContractID =
									                                            (
									                                            SELECT ISNULL(MAX(ISNULL(HREmployeeContracts.HREmployeeContractID,0)), 0)
									                                            FROM   dbo.HREmployeeContracts
									                                            WHERE  HREmployeeContracts.AAStatus = 'Alive'
									                                            AND FK_HREmployeeID = {0}                           
									                                            AND CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) > '{1}'
									                                            AND CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}'
									                                            )", iEmployee, dateFrom.ToString("yyyyMMdd"), dateTo.ToString("yyyyMMdd"));
            return GetDataSet(strQuery);
        }
        public DataSet GetContractCurrentByFDateTDateAndEmployee(int iEmployee, DateTime dateFrom, DateTime dateTo)
        {
            String strQuery = String.Format(@"SELECT *
                                                 FROM   dbo.HREmployeeContracts
                                                 WHERE  HREmployeeContracts.AAStatus = 'Alive'
                                                        AND FK_HREmployeeID = {0}
                                                        AND HREmployeeContractID = ( SELECT ISNULL(MAX(ISNULL(HREmployeeContracts.HREmployeeContractID,
                                                                                                              0)), 0)
                                                                                     FROM   dbo.HREmployeeContracts
                                                                                     WHERE  HREmployeeContracts.AAStatus = 'Alive'
                                                                                            AND FK_HREmployeeID = {0}
                                                                                            AND ( ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}'
                                                                                                    AND HREmployeeContractEndAppDate IS NULL
                                                                                                  )
                                                                                                  OR ( ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{1}'
                                                                                                         AND CONVERT(NVARCHAR(10), HREmployeeContractEndAppDate, 112) >= '{1}'
                                                                                                       )
                                                                                                       OR ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}'
                                                                                                            AND CONVERT(NVARCHAR(10), HREmployeeContractEndAppDate, 112) >= '{2}'
                                                                                                          )
                                                                                                       OR ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) >= '{1}'
                                                                                                            AND CONVERT(NVARCHAR(10), HREmployeeContractEndAppDate, 112) <= '{2}'
                                                                                                          )
                                                                                                     )
                                                                                                )
                                                                                   )", iEmployee, dateFrom.ToString("yyyyMMdd"), dateTo.ToString("yyyyMMdd"));
            return GetDataSet(strQuery);
        }
        public DataSet GetNewContractInMonthByEmployeeAndDate(int iEmployee, DateTime dateFrom, DateTime dateTo)
        {
            String strQuery = String.Format(@"SELECT *
                                             FROM   dbo.HREmployeeContracts
                                             WHERE  HREmployeeContracts.AAStatus = 'Alive'
                                                    AND FK_HREmployeeID = {0}
                                                    AND HREmployeeContractID =
									                                            (
									                                            SELECT ISNULL(MAX(ISNULL(HREmployeeContracts.HREmployeeContractID,0)), 0)
									                                            FROM   dbo.HREmployeeContracts
									                                            WHERE  HREmployeeContracts.AAStatus = 'Alive'
									                                            AND FK_HREmployeeID = {0}                           
									                                            AND CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) >= '{1}'
									                                            AND CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}'
									                                            )", iEmployee, dateFrom.ToString("yyyyMMdd"), dateTo.ToString("yyyyMMdd"));
            return GetDataSet(strQuery);
        }
        public DataSet GetOldContractInMonthByEmployeeAndDate(int iEmployee, DateTime dateFrom, DateTime dateTo)
        {
            String strQuery = String.Format(@" SELECT *
                                             FROM   dbo.HREmployeeContracts
                                             WHERE  HREmployeeContracts.AAStatus = 'Alive'
                                                    AND HREmployeeContractID = ( SELECT ISNULL(MAX(ISNULL(HREmployeeContracts.HREmployeeContractID,
                                                                                                          0)), 0)
                                                                                 FROM   dbo.HREmployeeContracts
                                                                                 WHERE  HREmployeeContracts.AAStatus = 'Alive'
                                                                                        AND FK_HREmployeeID = {0}
											                                            AND HREmployeeContractID <> (SELECT ISNULL(MAX(ISNULL(HREmployeeContracts.HREmployeeContractID,0)), 0)
																		                                            FROM   dbo.HREmployeeContracts
																		                                            WHERE  HREmployeeContracts.AAStatus = 'Alive'
																		                                            AND FK_HREmployeeID = {0}                           
																		                                            AND CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) >= '{1}'
																		                                            AND CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}')
                                                                                        AND ( ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}'
                                                                                                AND HREmployeeContractEndAppDate IS NULL
                                                                                              )
                                                                                              OR ( ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{1}'
                                                                                                     AND CONVERT(NVARCHAR(10), HREmployeeContractEndAppDate, 112) >= '{1}'
                                                                                                   )
                                                                                                   OR ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) <= '{2}'
                                                                                                        AND CONVERT(NVARCHAR(10), HREmployeeContractEndAppDate, 112) >= '{2}'
                                                                                                      )
                                                                                                   OR ( CONVERT(NVARCHAR(10), HREmployeeContractStartAppDate, 112) >= '{1}'
                                                                                                        AND CONVERT(NVARCHAR(10), HREmployeeContractEndAppDate, 112) <= '{2}'
                                                                                                      )
                                                                                                 )
                                                                                            )
                                                                               )", iEmployee, dateFrom.ToString("yyyyMMdd"), dateTo.ToString("yyyyMMdd"));
            return GetDataSet(strQuery);
        }
    }
    #endregion
}