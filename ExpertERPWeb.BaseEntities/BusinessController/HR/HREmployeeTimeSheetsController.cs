using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region HREmployeeTimeSheets
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:HREmployeeTimeSheetsController
	//Created Date:19 Tháng Chín 2013
	//-----------------------------------------------------------
	
	public class HREmployeeTimeSheetsController:BaseBusinessController
	{
		public HREmployeeTimeSheetsController()
		{
			dal= new DALBaseProvider("HREmployeeTimeSheets",typeof(HREmployeeTimeSheetsInfo));
		}

        public HREmployeeTimeSheetsInfo GetDataByEmployeeANDShiftANDDate(int iEmployeeID, int iShiftID, int iPeriod, int iYear)
        {
            String str = String.Format(@"   SELECT TOP 1 * FROM dbo.HREmployeeTimeSheets
                                            WHERE FK_HREmployeeID = {0}
                                            AND FK_HRShiftID = {1}
                                            AND HREmployeeTimeSheetYear = {2}
                                            AND HREmployeeTimeSheetPeriod = {3}
                                            ORDER BY HREmployeeTimeSheetID DESC", iEmployeeID, iShiftID, iYear, iPeriod);
            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return (HREmployeeTimeSheetsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }
            return null;
        }

        public void DeleteDataByEmployeeANDShiftANDDate(int iEmployeeID, int iShiftID, int iPeriod, int iYear)
        {
            String str = String.Format(@"   DELETE dbo.HREmployeeTimeSheets
                                            WHERE (FK_HREmployeeID = {0} OR {0} = 0)
                                            AND (FK_HRShiftID = {1} OR {1} = 0)
                                            AND HREmployeeTimeSheetYear = {2}
                                            AND HREmployeeTimeSheetPeriod = {3}", iEmployeeID, iShiftID, iYear, iPeriod);
            dal.GetDataSet(str);            
        }

        #region Lấy tất cả các kỳ của bảng xếp ca theo chuỗi định dạng MM/yyyy --Vinh
        
        public List<String> LayCacKyBangXepCaCu()
        {
            List<String> lstResult = new List<String>();
            String str = String.Format(@"   SELECT (CONVERT(VARCHAR,HREmployeeTimeSheetPeriod) + '/' + CONVERT(VARCHAR,HREmployeeTimeSheetYear)) AS KyBangXepCa 
                                            FROM dbo.HREmployeeTimeSheets
                                            GROUP BY HREmployeeTimeSheetYear, HREmployeeTimeSheetPeriod
                                            ORDER BY HREmployeeTimeSheetYear ASC, HREmployeeTimeSheetPeriod ASC");
            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow dr in ds.Tables[0].Rows)
                {
                    try
                    {
                        String strValue = Convert.ToString(dr["KyBangXepCa"]);
                        lstResult.Add(strValue);
                    }
                    catch
                    {
                    }
                }
            }
            return lstResult;
        }

        #endregion

        #region Lấy danh sách bảng xếp ca theo điều kiện Tháng, Năm, Nhân Viên, Phòng Ban, Bộ Phận --Vinh

        public DataSet LayDanhSachXepCaTheoThoiGianVaThongTinNhanVien(int iYear, int iPeriod, int iEmployeeID, int iDepartmentID, int iSectionID)
        {
            String str = String.Format(@"   SELECT * FROM dbo.HREmployeeTimeSheets
                                            WHERE HREmployeeTimeSheetYear = {0}
                                            AND HREmployeeTimeSheetPeriod = {1}
                                            AND FK_HREmployeeID IN (
							                                            SELECT HREmployeeID FROM dbo.HREmployees
							                                            WHERE AAStatus = 'Alive'
							                                            AND (HREmployeeID = {2} OR {2} = 0)
							                                            AND (FK_HRDepartmentID = {3} OR {3} = 0)
							                                            AND (FK_HRSectionID = {4} OR {4} = 0)
						                                            )
                                        ", iYear, iPeriod, iEmployeeID, iDepartmentID, iSectionID);
            return dal.GetDataSet(str);           
        }

        #endregion

        #region Kiểm tra ngày hôm đó có xếp ca cho nhân viên này không --Vinh

        public Boolean KiemTraCoXepCaChoNhanVien(int iYear, int iPeriod, int iEmployeeID, String strColumnNameDay)
        {
            String str = String.Format(@"   SELECT * FROM dbo.HREmployeeTimeSheets
                                            WHERE HREmployeeTimeSheetYear = {0}
                                            AND HREmployeeTimeSheetPeriod = {1}
                                            AND FK_HREmployeeID = {2}
                                            AND {3} = 1
                                        ", iYear, iPeriod, iEmployeeID, strColumnNameDay);
            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return true;
            }
            return false;
        }

        public int LayMaCaLamViecBangXepCaTheoNgay(DateTime dteDate, int iEmployeeID)
        {
            String str = String.Format(@"   SELECT FK_HRShiftID FROM dbo.HREmployeeTimeSheets
                                            WHERE HREmployeeTimeSheetYear = {0}
                                            AND HREmployeeTimeSheetPeriod = {1}
                                            AND FK_HREmployeeID = {2}
                                            AND {3} = 1
                                        ", dteDate.Year, dteDate.Month, iEmployeeID, "HREmployeeTimeSheetD" + dteDate.Day);
            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return Convert.ToInt32(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }
        public DataSet LayDanhSachXepCa(int iYear, int iPeriod, string strEmployeeNo, int iDepartmentID, int iSectionID)
        {
            String str = String.Format(@"   SELECT * FROM dbo.HREmployeeTimeSheets
                                            WHERE HREmployeeTimeSheetYear = {0}
                                            AND HREmployeeTimeSheetPeriod = {1}
                                            AND FK_HREmployeeID IN (
							                                            SELECT HREmployeeID FROM dbo.HREmployees
							                                            WHERE AAStatus = 'Alive'
							                                            AND (HREmployeeNo like '%{2}%')
							                                            AND (FK_HRDepartmentID = {3} OR {3} = 0)
							                                            AND (FK_HRSectionID = {4} OR {4} = 0)
						                                            )
                                            AND( HREmployeeTimeSheetD1 =1
                                                OR HREmployeeTimeSheetD2=1
                                                OR HREmployeeTimeSheetD3=1
                                                OR HREmployeeTimeSheetD4=1
                                                OR HREmployeeTimeSheetD5=1
                                                OR HREmployeeTimeSheetD6=1
                                                OR HREmployeeTimeSheetD7=1
                                                OR HREmployeeTimeSheetD8=1
                                                OR HREmployeeTimeSheetD9=1
                                                OR HREmployeeTimeSheetD10=1
                                                OR HREmployeeTimeSheetD11=1
                                                OR HREmployeeTimeSheetD12=1
                                                OR HREmployeeTimeSheetD13=1
                                                OR HREmployeeTimeSheetD14=1
                                                OR HREmployeeTimeSheetD15=1
                                                OR HREmployeeTimeSheetD16=1
                                                OR HREmployeeTimeSheetD17=1
                                                OR HREmployeeTimeSheetD18=1
                                                OR HREmployeeTimeSheetD19=1
                                                OR HREmployeeTimeSheetD20=1
                                                OR HREmployeeTimeSheetD21=1
                                                OR HREmployeeTimeSheetD22=1
                                                OR HREmployeeTimeSheetD23=1
                                                OR HREmployeeTimeSheetD24=1
                                                OR HREmployeeTimeSheetD25=1
                                                OR HREmployeeTimeSheetD26=1
                                                OR HREmployeeTimeSheetD27=1
                                                OR HREmployeeTimeSheetD28=1
                                                OR HREmployeeTimeSheetD29=1
                                                OR HREmployeeTimeSheetD30=1
                                                OR HREmployeeTimeSheetD31=1)
                                        ", iYear, iPeriod, strEmployeeNo, iDepartmentID, iSectionID);
            return dal.GetDataSet(str);
        }
        public DataTable GetAllDataByEmployeeList(params string[] arrEmployeeID)
        {
            return this.GetDataTableByDataSet(GetDataSet(string.Format("SELECT * FROM HREmployeeTimeSheets WHERE FK_HREmployeeID IN({0})", string.Join(",", arrEmployeeID))));
        }
        #endregion
    }
	#endregion
}