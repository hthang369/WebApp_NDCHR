using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
using System.Transactions;
namespace ExpertERP.BusinessEntities
{
	#region GLJournals
	//-----------------------------------------------------------
	//Generated By: Expert Studio
	//Class:GLJournalsController
	//Created Date:Thursday, January 06, 2011
	//-----------------------------------------------------------

	public partial class GLJournalsController:BaseBusinessController
	{
        //(LINHCLH - 21/01/2014 - Viet lai ham moi cai thien toc do va xu ly bu tru cong no
        public void DeleteExcRateCostBySubLedgerAndDate(String psSubLedger,DateTime dtFrom,DateTime dtTo)
        {
            String strQuery = String.Format(@"DELETE FROM GLJournals WHERE GLJournalSubLedger = '{0}' AND  CAST(CONVERT(VARCHAR(20), GLJournalDate, 112) AS DATETIME) BETWEEN '{1}' AND '{2}'", psSubLedger, dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"));
            GetDataSet(strQuery);
        }
        public DataSet Calc_CongNoChiTiet(DateTime dtLastStartFiscalYear, DateTime dtFrom, DateTime dtTo, String[] lstAccountNo, int iCurrencyID, int iHomeCurrencyID ,int iARCustomerID,int iAPSupplierID, int iBranchID = 0)
        {
            String strquery_Group = String.Empty;

            if (iARCustomerID > 0 && iAPSupplierID == 0)
            {
                strquery_Group = String.Format(@"Where FK_ARCustomerGroupID = {0}", iARCustomerID);
            }
            else if (iARCustomerID == 0 && iAPSupplierID > 0)
            {
                strquery_Group = String.Format(@"Where FK_APSupplierGroupID = {0}", iAPSupplierID);
            }
            else if (iARCustomerID > 0 && iAPSupplierID > 0)
            {
                strquery_Group = String.Format(@"Where FK_APSupplierGroupID = {0} AND FK_ARCustomerGroupID = {1}", iAPSupplierID,iARCustomerID);
            }
            
            string strQueryAccount = string.Empty;
            strQueryAccount = String.Format(@"1=1");
            if (lstAccountNo.Length > 0)
            {
                strQueryAccount += String.Format(@" AND (GLAccountNo like '{0}%'", lstAccountNo[0]);
                for (int i = 1; i < lstAccountNo.Length; i++)
                    strQueryAccount += String.Format(@" OR GLAccountNo like '{0}%'", lstAccountNo[i]);
                strQueryAccount += String.Format(@")");
            }

            String strQuery = String.Format(
                @"
                    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
                    BEGIN TRANSACTION 
                       --BANG CAN DOI PHAT SINH
                        SET NOCOUNT ON
                        DECLARE @dStart as datetime,
		                        @dFrom as datetime,
		                        @dTo as datetime,
								@iBranchID as int,
								@iCurrencyID as int
/*
		                        @iViewLevel as int,
		                        @bViewObjects as bit,
		                        @bKoButru as bit,
                                @bNotKC911 as bit
*/
                        SET @dStart = '{1}'
                        SET @dFrom = '{2}'
                        SET @dTo = '{3}'
                        SET @iBranchID = {5}
                        SET @iCurrencyID = {6}

/*                      
                        SET @iViewLevel = 4
                        SET @bNotKC911 = 5
                        SET @bKoButru = 6                        
                        SET @bViewObjects = 7
*/                        
                        --(Loc du lieu ra de tang toc do truy van
                        SELECT  GLAccountID, GLAccountNO, GLAccountName, 
                                GLAccountLevel, GLAccountBalanceCombo,FK_GLAccountParentID
                        INTO #tGLAccounts
                        FROM dbo.GLAccounts 
                        WHERE AAStatus = 'Alive' AND (GLAccountBalanceCombo = 'NC' OR GLAccountTypeCombo IN ('AR','AP'))

                        --(Dau nam tai chinh
                        SELECT	FK_GLDebitAccountID,FK_GLCreditAccountID,
		                        GLJournalAmt,
		                        GLJournalFAmt,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
		                INTO #tSDDK
                        FROM dbo.GLJournals
                        WHERE GLJournalPeriod = 0 AND GLJournalYear = Year(@dStart)
                            AND (FK_GLDebitAccountID > 0 OR FK_GLCreditAccountID > 0)
                            AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
                            AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
                        --)
                        --(PS tu dau nam
                        SELECT	FK_GLDebitAccountID,FK_GLCreditAccountID,
		                        GLJournalAmt,
		                        GLJournalFAmt,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID,
                                FK_ARCustomerIDCredit,
		                        FK_APSupplierIDCredit,
		                        FK_HREmployeeIDCredit,
                                0 as isBTCN
		                INTO #tPSDK
                        FROM dbo.GLJournals
                        WHERE GLJournalPeriod <> 0 
                            AND CONVERT(VARCHAR(20), GLJournalDate, 112) between CONVERT(VARCHAR(20),@dStart,112) and CONVERT(VARCHAR(20),@dFrom - 1,112)
                            AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
                            AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
                        --)
                        --(PS Trong ky                   
                        SELECT	FK_GLDebitAccountID,FK_GLCreditAccountID,
                                GLSourceLedger,
		                        GLJournalAmt,
		                        GLJournalFAmt,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID,
		                        FK_ARCustomerIDCredit,
		                        FK_APSupplierIDCredit,
		                        FK_HREmployeeIDCredit,
                                0 as isBTCN
		                INTO #tPSTK
                        FROM dbo.GLJournals
                        WHERE GLJournalPeriod <> 0 --AND GLJournalDate BETWEEN @dFrom AND @dTo
	                        AND CONVERT(VARCHAR(20), GLJournalDate, 112) between CONVERT(VARCHAR(20),@dFrom,112) and CONVERT(VARCHAR(20),@dTo,112)
                            AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
                            AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
/*						IF @bNotKC911 = 1
							DELETE FROM #tPSTK 
								WHERE	FK_GLDebitAccountID IN (SELECT GLAccountID FROM #t911) OR
										FK_GLCreditAccountID IN (SELECT GLAccountID FROM #t911)
*/
                        --)
                        --(Xu ly du lieu BTCN
                        UPDATE #tPSDK SET isBTCN = 1 
                            FROM #tPSDK a 
                            INNER JOIN #tGLAccounts b ON a.FK_GLDebitAccountID = b.GLAccountID
                            INNER JOIN #tGLAccounts c ON a.FK_GLCreditAccountID = c.GLAccountID
                        UPDATE #tPSTK SET isBTCN = 1 
                            FROM #tPSTK a 
                            INNER JOIN #tGLAccounts b ON a.FK_GLDebitAccountID = b.GLAccountID
                            INNER JOIN #tGLAccounts c ON a.FK_GLCreditAccountID = c.GLAccountID
                        UPDATE #tPSDK SET 
							FK_ARCustomerIDCredit = FK_ARCustomerID,
							FK_APSupplierIDCredit = FK_APSupplierID,
							FK_HREmployeeIDCredit = FK_HREmployeeID
							WHERE	isBTCN = 1 
									AND FK_ARCustomerIDCredit = 0
									AND FK_APSupplierIDCredit = 0
									AND FK_HREmployeeIDCredit = 0
                        UPDATE #tPSTK SET 
							FK_ARCustomerIDCredit = FK_ARCustomerID,
							FK_APSupplierIDCredit = FK_APSupplierID,
							FK_HREmployeeIDCredit = FK_HREmployeeID
							WHERE	isBTCN = 1 
									AND FK_ARCustomerIDCredit = 0
									AND FK_APSupplierIDCredit = 0
									AND FK_HREmployeeIDCredit = 0
                        --)
                        --(Tao bang du lieu chi tiet
                        --DuN dau nam tai chinh
                        SELECT	FK_GLDebitAccountID as FK_GLAccountID, 
		                        GLJournalAmt as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        GLJournalFAmt as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        INTO #tData
                        FROM #tSDDK
                        WHERE FK_GLDebitAccountID > 0 AND FK_GLDebitAccountID is not null
                        UNION ALL
                        --DuC dau nam tai chinh
                        SELECT	FK_GLCreditAccountID, 
		                        0 as DK_No0,
		                        GLJournalAmt as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        GLJournalFAmt as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        FROM #tSDDK
                        WHERE FK_GLCreditAccountID > 0 AND FK_GLCreditAccountID is not null
                        UNION ALL
                        --PSN luy ke tu dau nam den dau ngay bao cao
                        SELECT	FK_GLDebitAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        GLJournalAmt as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        GLJournalFAmt as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        FROM #tPSDK
                        UNION ALL
                        --PSC luy ke tu dau nam den dau ngay bao cao
                        SELECT	FK_GLCreditAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        GLJournalAmt as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        GLJournalFAmt as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        CASE isBTCN WHEN 1 THEN FK_ARCustomerIDCredit ELSE FK_ARCustomerID END as FK_ARCustomerID,
		                        CASE isBTCN WHEN 1 THEN FK_APSupplierIDCredit ELSE FK_APSupplierID END as FK_APSupplierID,
		                        CASE isBTCN WHEN 1 THEN FK_HREmployeeIDCredit ELSE FK_HREmployeeID END as FK_HREmployeeID
                        FROM #tPSDK
                        UNION ALL
                        --PSN trong ky bao cao
                        SELECT	FK_GLDebitAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        GLJournalAmt as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        GLJournalFAmt as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        FROM #tPSTK
                        UNION ALL
                        --PSC trong ky bao cao
                        SELECT	FK_GLCreditAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        GLJournalAmt as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        GLJournalFAmt as Ps_co_NT,
                                CASE isBTCN WHEN 1 THEN FK_ARCustomerIDCredit ELSE FK_ARCustomerID END as FK_ARCustomerID,
		                        CASE isBTCN WHEN 1 THEN FK_APSupplierIDCredit ELSE FK_APSupplierID END as FK_APSupplierID,
		                        CASE isBTCN WHEN 1 THEN FK_HREmployeeIDCredit ELSE FK_HREmployeeID END as FK_HREmployeeID
                        FROM #tPSTK
                        --)

                        --(Tinh tong theo doi tuong
                        SELECT FK_GLAccountID,
		                        SUM(DK_No0) as DK_No0,
		                        SUM(DK_Co0) as DK_Co0,
		                        SUM(PS_no0) as PS_NO0,
		                        SUM(PS_co0) as PS_Co0,
		                        cast (0 as float) as Dk_No,
		                        cast (0 as float) as Dk_Co,
		                        SUM(PS_no) as PS_NO,
		                        SUM(PS_co) as PS_Co,
		                        cast (0 as float) as ck_No,
		                        cast (0 as float) as Ck_Co,
		                        SUM(DK_No0_NT) as DK_No0_NT,
		                        SUM(DK_Co0_NT) as DK_Co0_NT,
		                        SUM(PS_no0_NT) as PS_NO0_NT,
		                        SUM(PS_co0_NT) as PS_Co0_NT,
		                        cast (0 as float) as Dk_No_NT,
		                        cast (0 as float) as Dk_Co_NT,
		                        SUM(PS_no_NT) as PS_NO_NT,
		                        SUM(PS_co_NT) as PS_Co_NT,
		                        cast (0 as float) as ck_No_NT,
		                        cast (0 as float) as Ck_Co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        INTO #tKQ
                        FROM #tData a
                        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID 
                        WHERE {0}
                        GROUP BY	FK_GLAccountID,
			                        FK_ARCustomerID,
			                        FK_APSupplierID,
			                        FK_HREmployeeID
                        --)


                        --(Tinh lai so du dau nam va dau ky chi tiet dau nam tai chinh
                        UPDATE #tKQ set 
		                        dk_no0 = dk_no0 - dk_co0,
		                        dk_co0 = 0
	                        WHERE dk_co0 <> 0 AND dk_no0 >= dk_co0
	                    
	                    UPDATE #tKQ set 
		                        dk_no0_NT = dk_no0_NT - dk_co0_NT,
		                        dk_co0_NT = 0
	                        WHERE dk_co0_NT <> 0 AND dk_no0_NT >= dk_co0_NT

                        UPDATE #tKQ set 
		                        dk_co0 = dk_co0 - dk_no0,
		                        dk_no0 = 0
	                        WHERE dk_no0 <> 0 AND dk_co0 >= dk_no0
	                     
	                     UPDATE #tKQ set 
		                        dk_co0_NT = dk_co0_NT - dk_no0_NT,
		                        dk_no0_NT = 0
	                        WHERE dk_no0_NT <> 0 AND dk_co0_NT >= dk_no0_NT
						--)
						--(TInh so du dau ky
                        UPDATE #tKQ set 
		                        dk_no = dk_no0 - dk_co0 + ps_no0 - ps_co0
		                        
		                UPDATE #tKQ set 
		                        dk_no_NT = dk_no0_NT - dk_co0_NT + ps_no0_NT - ps_co0_NT
		
                        UPDATE #tKQ set 
		                        dk_co = ABS(dk_no),
		                        dk_no = 0
	                        WHERE dk_no < 0
	                    
	                    UPDATE #tKQ set 
		                        dk_co_NT = ABS(dk_no_NT),
		                        dk_no_NT = 0
	                        WHERE dk_no_NT < 0
                        --)
						--(TInh so du cuoi ky
                        UPDATE #tKQ set 
		                        ck_no = dk_no - dk_co + ps_no - ps_co
		
                        UPDATE #tKQ set 
		                        ck_no_NT = dk_no_NT - dk_co_NT + ps_no_NT - ps_co_NT
		                        
                        UPDATE #tKQ set 
		                        ck_co = ABS(ck_no),
		                        ck_no = 0
	                        WHERE ck_no < 0
	                    
	                    UPDATE #tKQ set 
		                        ck_co_NT = ABS(ck_no_NT),
		                        ck_no_NT = 0
	                        WHERE ck_no_NT < 0
                        --)
                        --(Xoa du lieu ko phat sinh
                        DELETE FROM #tKQ 
                            WHERE   dk_no = 0 AND dk_co = 0 AND ps_no = 0 AND ps_co = 0 AND ck_no = 0 AND ck_co = 0 AND
                                    dk_no_nt = 0 AND dk_co_nt = 0 AND ps_no_nt = 0 AND ps_co_nt = 0 AND ck_no_nt = 0 AND ck_co_nt = 0
                        --)
                        --(Ket qua cuoi cung
                        SELECT 
	                        b.GLAccountID as FK_GLAccountID,
	                        b.GLAccountNo,
	                        b.GLAccountName,
	                        b.GLAccountLevel,
                            CASE    WHEN a.FK_ARCustomerID > 0 THEN ARCustomerNo
                                    WHEN a.FK_APSupplierID > 0 THEN APSupplierNo
                                    WHEN a.FK_HREmployeeID > 0 THEN HREmployeeNo END as ObjectNo,
                            CASE    WHEN a.FK_ARCustomerID > 0 THEN ARCustomerName
                                    WHEN a.FK_APSupplierID > 0 THEN APSupplierName
                                    WHEN a.FK_HREmployeeID > 0 THEN HREmployeeName END as ObjectName,
	                        DK_No0 as GLAccountBeginFYDebitAmt,
	                        DK_Co0 as GLAccountBeginFYCreditAmt,
	                        PS_NO0 as GLAccountAccumDebitAmt,
	                        PS_Co0 as GLAccountAccumCreditAmt,
	                        DK_No as GLAccountBeginDebitAmt,
	                        DK_Co as GLAccountBeginCreditAmt,
	                        PS_NO as GLAccountDebitAmt,
	                        PS_Co as GLAccountCreditAmt,
	                        CK_No as GLAccountEndDebitAmt,
	                        CK_Co as GLAccountEndCreditAmt,
	                        
	                        DK_No0_NT as GLAccountBeginFYDebitFAmt,
	                        DK_Co0_NT as GLAccountBeginFYCreditFAmt,
	                        PS_NO0_NT as GLAccountAccumDebitFAmt,
	                        PS_Co0_NT as GLAccountAccumCreditFAmt,
	                        DK_No_NT as GLAccountBeginDebitFAmt,
	                        DK_Co_NT as GLAccountBeginCreditFAmt,
	                        PS_NO_NT as GLAccountDebitFAmt,
	                        PS_Co_NT as GLAccountCreditFAmt,
	                        CK_No_NT as GLAccountEndDebitFAmt,
	                        CK_Co_NT as GLAccountEndCreditFAmt,
	                        a.FK_ARCustomerID,
	                        a.FK_APSupplierID,
	                        a.FK_HREmployeeID
                        FROM #tKQ a
                        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
                        LEFT JOIN ARCustomers c ON a.FK_ARCustomerID = c.ARCustomerID AND c.AAStatus = 'Alive'
                        LEFT JOIN APSuppliers d ON a.FK_APSupplierID = d.APSupplierID AND d.AAStatus = 'Alive'
                        LEFT JOIN HREmployees e ON a.FK_HREmployeeID = e.HREmployeeID AND e.AAStatus = 'Alive'
                        {4}
                        ORDER BY GLAccountNo,ObjectNo
                    ROLLBACK TRANSACTION
                        --)
", strQueryAccount, dtLastStartFiscalYear.ToString("yyyyMMdd"), dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"),strquery_Group
, iBranchID, iCurrencyID);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            ds = GetDataSet(strQuery);

            return ds;
        }
        //)
        public DataSet Calc_CongNoChiTietOld(DateTime dtLastStartFiscalYear, DateTime dtFrom, DateTime dtTo, String[] lstAccountNo, int iCurrencyID, int iHomeCurrencyID)
        {
            String strDtFrom = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtFrom.Year, dtFrom.Month, dtFrom.Day);
            String strDtTo = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtTo.Year, dtTo.Month, dtTo.Day);

            String strBeginFromCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String strBeginToCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeginTimeRange = String.Format(@"{0} AND {1}", strBeginFromCond, strBeginToCond);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);

            #region Prepair Query

            String strQueryAccount = String.Empty;
            if (lstAccountNo.Length == 0)
                strQueryAccount = String.Format(@"SELECT GLAccountNo AS AccountNo FROM GLAccounts WHERE AAStatus = 'Alive'");
            else
            {
                strQueryAccount = String.Format(@"SELECT '{0}' AS AccountNo", lstAccountNo[0]);
                for (int i = 1; i < lstAccountNo.Length; i++)
                {
                    strQueryAccount += String.Format(@" UNION ALL SELECT '{0}' AS AccountNo", lstAccountNo[i]);
                }
            }

            strQueryAccount = String.Format(@"SELECT * INTO Account FROM ({0}) AS Temp", strQueryAccount);

            #region Delete Temp Table
            String strDeleteTempTable = String.Format(@"IF OBJECT_ID('Objects') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Objects
                                                    END

                                                    IF OBJECT_ID('Account') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Account
                                                    END


                                                    IF OBJECT_ID('Journals') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Journals
                                                    END

                                                    IF OBJECT_ID('ObjectJournals') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE ObjectJournals
                                                    END
                                                    IF OBJECT_ID('CongNo') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE CongNo
                                                    END

                                                    IF OBJECT_ID('CongNoChiTiet') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE CongNoChiTiet
                                                    END
                                                    ");
            #endregion

            #region Tap hop doi tuong
            String strQueryAllObjects = String.Format(@"SELECT * INTO Objects
                                                        FROM 
                                                        (select 'Cust' + CAST(ARCustomerID AS nvarchar(50)) AS ObjectID,
                                                        ARCustomerNo as ObjectNo,
                                                        ARCustomerName as ObjectName
                                                        FROM ARCustomers 
                                                        WHERE AAStatus = 'Alive' 

                                                        UNION ALL 

                                                        select 'Sup' + CAST(APSUpplierID AS nvarchar(50)) AS ObjectID,
                                                        APSUpplierNo as ObjectNo,
                                                        APSupplierName as ObjectName
                                                        FROM APSuppliers 
                                                        WHERE AAStatus = 'Alive' 

                                                        UNION ALL

                                                        select 'Emp' + CAST(HREmployeeID AS nvarchar(50)) AS ObjectID,
                                                        HREmployeeNo as ObjectNo,
                                                        HREmployeeName as ObjectName
                                                        FROM HREmployees 
                                                        WHERE AAStatus = 'Alive'

                                                        UNION ALL

                                                        SELECT 'Unknow' AS ObjectID,
                                                        'Unknow' AS ObjectNo,
                                                        N'Không rõ đối tượng' AS ObjectName
                                                        ) AS TEMP");
            #endregion

            #region Tap hop Journal va cac doi tuong
            String strCollectJournalAndObjects
                            = String.Format(@"SELECT * INTO Journals
                                            FROM
                                            (
                                                SELECT Objects.*,
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear
                                                FROM GLJournals, Objects
                                                WHERE 
                                                ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                                                AND {0} --InRange

                                                UNION ALL

                                                SELECT Objects.*, 
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear
                                                FROM GLJournals, Objects
                                                WHERE 
                                                ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                                                AND {0} --InRange

                                                UNION ALL

                                                SELECT Objects.*, 
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear
                                                FROM GLJournals, Objects
                                                WHERE 
                                                ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                                                AND {0} --InRange

                                                UNION ALL

                                                SELECT Objects.*, 
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear
                                                FROM GLJournals, Objects
                                                WHERE ObjectNo = 'Unknow'
                                                AND FK_APSupplierID = 0
                                                AND FK_ARCustomerID = 0
                                                AND FK_HREmployeeID = 0
                                                AND {0} --InRange

                                            ) AS Temp
                                            ", strAllRange);
            #endregion

            #region Tong hop so du dau ky, phat sinh...
            String strQueryCategory
                = String.Format(@"SELECT * INTO ObjectJournals
                                    FROM
                                    (
                                    -- No dau ky
                                    SELECT 
                                    ObjectID, ObjectNo, ObjectName, 
                                    GLAccounts.GLAccountID, GLAccountNo, GLAccountName,
                                    SUM(Journals.GLJournalAmt) AS BeginDebitAmt,
                                    SUM(Journals.GLJournalFAmt) AS BeginDebitFAmt,
                                    0 AS BeginCreditAmt,
                                    0 AS BeginCreditFAmt,
                                    0 AS ArisingDebitAmt,
                                    0 AS ArisingDebitFAmt,
                                    0 AS ArisingCreditAmt,
                                    0 AS ArisingCreditFAmt,
                                    0 AS AccumDebitAmt,
                                    0 AS AccumDebitFAmt,
                                    0 AS AccumCreditAmt,
                                    0 AS AccumCreditFAmt
                                    FROM Journals, GLAccounts, Account
                                    WHERE
                                    Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                                    AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                                    AND GLAccounts.AAStatus = 'Alive'
                                    AND ( {0} OR GLJournalPeriod = 0 )
                                    AND (Journals.FK_GECurrencyID = {2} OR 0 = {2} OR {2} = {3})
                                    GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                                    UNION ALL

                                    --Co dau ky
                                    SELECT 
                                    ObjectID, ObjectNo, ObjectName, 
                                    GLAccountID, GLAccountNo, GLAccountName,
                                    0 AS BeginDebitAmt,
                                    0 AS BeginDebitFAmt,
                                    SUM(Journals.GLJournalAmt) AS BeginCreditAmt,
                                    SUM(Journals.GLJournalFAmt) AS BeginCreditFAmt,
                                    0 AS ArisingDebitAmt,
                                    0 AS ArisingDebitFAmt,
                                    0 AS ArisingCreditAmt,
                                    0 AS ArisingCreditFAmt,
                                    0 AS AccumDebitAmt,
                                    0 AS AccumDebitFAmt,
                                    0 AS AccumCreditAmt,
                                    0 AS AccumCreditFAmt
                                    FROM Journals, GLAccounts, Account
                                    WHERE
                                    Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                                    AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                                    AND GLAccounts.AAStatus = 'Alive'
                                    AND ( {0} OR GLJournalPeriod = 0 )
                                    AND (Journals.FK_GECurrencyID = {2} OR 0 = {2} OR {2} = {3})
                                    GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                                    UNION ALL

                                    -- No phat sinh
                                    SELECT 
                                    ObjectID, ObjectNo, ObjectName, 
                                    GLAccountID, GLAccountNo, GLAccountName,
                                    0 AS BeginDebitAmt,
                                    0 AS BeginDebitFAmt,
                                    0 AS BeginCreditAmt,
                                    0 AS BeginCreditFAmt,
                                    SUM(Journals.GLJournalAmt) AS ArisingDebitAmt,
                                    SUM(Journals.GLJournalFAmt) AS ArisingDebitFAmt,
                                    0 AS ArisingCreditAmt,
                                    0 AS ArisingCreditFAmt,
                                    0 AS AccumDebitAmt,
                                    0 AS AccumDebitFAmt,
                                    0 AS AccumCreditAmt,
                                    0 AS AccumCreditFAmt
                                    FROM Journals, GLAccounts, Account
                                    WHERE
                                    Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                                    AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                                    AND GLAccounts.AAStatus = 'Alive'
                                    AND {1}
                                    AND GLJournalPeriod <> 0
                                    AND (Journals.FK_GECurrencyID = {2} OR 0 = {2} OR {2} = {3})
                                    GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                                    UNION ALL

                                    -- Co phat sinh
                                    SELECT 
                                    ObjectID, ObjectNo, ObjectName, 
                                    GLAccountID, GLAccountNo, GLAccountName,
                                    0 AS BeginDebitAmt,
                                    0 AS BeginDebitFAmt,
                                    0 AS BeginCreditAmt,
                                    0 AS BeginCreditFAmt,
                                    0 AS ArisingDebitAmt,
                                    0 AS ArisingDebitFAmt,
                                    SUM(Journals.GLJournalAmt) AS ArisingCreditAmt,
                                    SUM(Journals.GLJournalFAmt) AS ArisingCreditFAmt,
                                    0 AS AccumDebitAmt,
                                    0 AS AccumDebitFAmt,
                                    0 AS AccumCreditAmt,
                                    0 AS AccumCreditFAmt
                                    FROM Journals, GLAccounts, Account
                                    WHERE
                                    Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                                    AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                                    AND GLAccounts.AAStatus = 'Alive'
                                    AND {1}
                                    AND GLJournalPeriod <> 0
                                    AND (Journals.FK_GECurrencyID = {2} OR 0 = {2} OR {2} = {3})
                                    GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName


                                    ) AS Temp


                                    SELECT 
                                    GLAccountID, GLAccountNo, ObjectID, ObjectNo, ObjectName,
                                    SUM(BeginDebitAmt) - SUM(BeginCreditAmt) AS BeginAmt,
                                    SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) AS BeginFAmt,
                                    SUM(ArisingDebitAmt) AS ArisingDebAmt,
                                    SUM(ArisingDebitFAmt) AS ArisingDebFAmt,
                                    SUM(ArisingCreditAmt) AS ArisingCreAmt,
                                    SUM(ArisingCreditFAmt) AS ArisingCreFAmt,
                                    SUM(BeginDebitAmt) - SUM(BeginCreditAmt) + SUM(ArisingDebitAmt) - SUM(ArisingCreditAmt) AS EndAmt,
                                    SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt)  + SUM(ArisingDebitFAmt) - SUM(ArisingCreditFAmt) AS EndFAmt

                                    INTO CongNo
                                    FROM ObjectJournals
                                    --WHERE GLAccountNo LIKE '331%'
                                    Group By GLAccountID, GLAccountNo, ObjectID ,ObjectNo, ObjectName
                                    ", strBeginTimeRange, strInRange, iCurrencyID, iHomeCurrencyID);
            #endregion

            #region Query Conng No theo tai khoan va object
            String strQueryCongno
                = String.Format(@"  SELECT  
                                    CongNo.ObjectID AS ObjectIDRef,
                                    CongNo.GLAccountID AS FK_GLAccountID,
                                    CAST('{0}' AS DateTime) AS GLTrialBalanceFromDate,
                                    CAST('{1}' AS DateTime) AS GLTrialBalanceToDate,
                                    {2} AS FK_GECurrencyID,
                                    Account.AccountNo AS GLAccountNo,  ObjectNo, ObjectName,
                                    CASE WHEN SUM(BeginAmt) >= 0 then SUM(BeginAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                                    CASE WHEN SUM(BeginFAmt) >= 0 then SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                                    CASE WHEN SUM(BeginAmt) < 0 then -SUM(BeginAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                                    CASE WHEN SUM(BeginFAmt) < 0 then -SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                                    SUM(ArisingDebAmt) AS GLAccountDebitAmt,
                                    SUM(ArisingDebFAmt) AS GLAccountDebitFAmt,
                                    SUM(ArisingCreAmt) AS GLAccountCreditAmt,
                                    SUM(ArisingCreFAmt) AS GLAccountCreditFAmt,
                                    CASE WHEN SUM(EndAmt) >= 0 then SUM(EndAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                                    CASE WHEN SUM(EndFAmt) >= 0 then SUM(EndFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                                    CASE WHEN SUM(EndAmt) < 0 then -SUM(EndAmt) ELSE 0 END AS GLAccountEndCreditAmt,
                                    CASE WHEN SUM(EndFAmt) < 0 then -SUM(EndFAmt) ELSE 0 END AS GLAccountEndCreditFAmt
                                    FROM CongNo,Account
                                    WHERE GLAccountNo like Account.AccountNo + '%'
                                    GROUP BY CongNo.ObjectID, CongNo.GLAccountID, Account.AccountNo, ObjectNo, ObjectName", strDtFrom, strDtTo, iCurrencyID);

            #endregion

            #endregion

            #region RUN

            String strQuery = String.Format(@"{0}
                                              {1}
                                              {2}
                                              {3}
                                              {4}
                                              ",strQueryAllObjects, strQueryAccount,
                                                  strCollectJournalAndObjects, strQueryCategory,
                                                  strQueryCongno);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            using (TransactionScope tranScope = new TransactionScope())
            {
                GetDataSet(strDeleteTempTable);
                ds = GetDataSet(strQuery);
                GetDataSet(strDeleteTempTable);
            }
            #endregion
            
            return ds;
        }

        public DataSet GetAllAccountDoiungs(String strAccountNo, DateTime dtFrom, DateTime dtTo, String ObjectNo, int iCurrencyID, int iHomeCurrencyID)
        {
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);

            #region Prepair Query

            #region Delete Temp Table
            String strPrepairQuery = String.Format(@"IF OBJECT_ID('Objects') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Objects
                                                    END

                                                    IF OBJECT_ID('Account') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Account
                                                    END


                                                    IF OBJECT_ID('Journals') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Journals
                                                    END

                                                    IF OBJECT_ID('ObjectJournals') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE ObjectJournals
                                                    END
                                                    IF OBJECT_ID('CongNo') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE CongNo
                                                    END

                                                    IF OBJECT_ID('CongNoChiTiet') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE CongNoChiTiet
                                                    END
                                                    ");
            dal.GetDataSet(strPrepairQuery);
            #endregion

            #region Tap hop doi tuong
            String strQueryAllObjects = String.Format(@"SELECT * INTO Objects
                                                        FROM 
                                                        (select 'Cust' + CAST(ARCustomerID AS nvarchar(50)) AS ObjectID,
                                                        ARCustomerNo as ObjectNo,
                                                        ARCustomerName as ObjectName
                                                        FROM ARCustomers 
                                                        WHERE AAStatus = 'Alive' 

                                                        UNION ALL 

                                                        select 'Sup' + CAST(APSUpplierID AS nvarchar(50)) AS ObjectID,
                                                        APSUpplierNo as ObjectNo,
                                                        APSupplierName as ObjectName
                                                        FROM APSuppliers 
                                                        WHERE AAStatus = 'Alive' 

                                                        UNION ALL

                                                        select 'Emp' + CAST(HREmployeeID AS nvarchar(50)) AS ObjectID,
                                                        HREmployeeNo as ObjectNo,
                                                        HREmployeeName as ObjectName
                                                        FROM HREmployees 
                                                        WHERE AAStatus = 'Alive'

                                                        UNION ALL

                                                        SELECT 'Unknow' AS ObjectID,
                                                        'Unknow' AS ObjectNo,
                                                        N'Không rõ đối tượng' AS ObjectName
                                                        ) AS TEMP");
            #endregion

            #region Tap hop Journal va cac doi tuong
            String strCollectJournalAndObjects
                            = String.Format(@"SELECT * INTO Journals
                                            FROM
                                            (
                                                SELECT Objects.*,
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear,
                                                GLSourceLedger,
                                                GLJournalDesc,
                                                GLJournalHDesc,
                                                GLJournalNo,
                                                GLJournalDocumentNo
                                                FROM GLJournals, Objects
                                                WHERE 
                                                ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                                                AND {0} --InRange
                                                AND Objects.ObjectID = '{1}'

                                                UNION ALL

                                                SELECT Objects.*, 
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear,
                                                GLSourceLedger,
                                                GLJournalDesc,
                                                GLJournalHDesc,
                                                GLJournalNo,
                                                GLJournalDocumentNo
                                                FROM GLJournals, Objects
                                                WHERE 
                                                ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                                                AND {0} --InRange
                                                AND Objects.ObjectID = '{1}'

                                                UNION ALL

                                                SELECT Objects.*, 
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear,
                                                GLSourceLedger,
                                                GLJournalDesc,
                                                GLJournalHDesc,
                                                GLJournalNo,
                                                GLJournalDocumentNo
                                                FROM GLJournals, Objects
                                                WHERE 
                                                ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                                                AND {0} --InRange
                                                AND Objects.ObjectID = '{1}'

                                                UNION ALL

                                                SELECT Objects.*, 
                                                GLJournals.GLJournalID,
                                                GLJournals.FK_GLDebitAccountID,
                                                GLJournals.FK_GLCreditAccountID,
                                                GLJournals.GLJournalAmt,
                                                GLJournals.GLJournalFAmt,
                                                GLJournals.FK_GECurrencyID,
                                                GLJournals.GLJournalExRate,
                                                GLJournals.FK_APSupplierID,
                                                GLJournals.FK_ARCustomerID,
                                                GLJournals.FK_HREmployeeID,
                                                GLJournals.GLJournalDate,
                                                GLJournalPeriod,
                                                GLJournalYear,
                                                GLSourceLedger,
                                                GLJournalDesc,
                                                GLJournalHDesc,
                                                GLJournalNo,
                                                GLJournalDocumentNo
                                                FROM GLJournals, Objects
                                                WHERE ObjectNo = 'Unknow'
                                                AND FK_APSupplierID = 0
                                                AND FK_ARCustomerID = 0
                                                AND FK_HREmployeeID = 0
                                                AND {0} --InRange
                                                AND Objects.ObjectID = '{1}'

                                            ) AS Temp
                                            ", strInRange, ObjectNo);
            #endregion

            #region Get All Journals
            String strQueryJournal
                = String.Format(@" SELECT * FROM
                                    (
                                    -- No phat sinh
                                    SELECT 
                                    0 AS ViewAccountDoiUngID,
                                    DebitAccount.GLAccountID AS AccountID,
                                    DebitAccount.GLAccountNo AS AccountNo,
                                    CreditAccount.GLAccountName AS AccountDoiUngName,
                                    SUM(GLJournalAmt) AS DebitAmt,
                                    SUM(GLJournalFAmt) AS DebitFAmt,
                                    0 as CreditAmt,
                                    0 AS CreditFAmt,
                                    Journals.GLJournalDate  AS  JournalDate,
                                    Journals.GLJournalDocumentNo AS DocumentNo,
                                    Journals.GLSourceLedger AS SourceLedger,
                                    CreditAccount.GLAccountNo AS AccountDoiUngNo,
                                    Journals.FK_GECurrencyID AS FK_GECurrencyID,
                                    Journals.GLJournalExRate AS ExcRate,
                                    Journals.GLJournalHDesc AS JournalHDesc
                                    FROM Journals, GLAccounts AS DebitAccount, GLAccounts AS CreditAccount
                                    WHERE
                                    Journals.FK_GLDebitAccountID = DebitAccount.GLAccountID
                                    AND Journals.FK_GLCreditAccountID = CreditAccount.GLAccountID
                                    AND DebitAccount.GLAccountID > 0
                                    AND CreditAccount.GLAccountID > 0
                                    AND {0}
                                    AND DebitAccount.GLAccountNo like '{1}%'
                                    AND (Journals.FK_GECurrencyID = {2} OR 0 = {2} OR {2} = {3})
                                    GROUP BY
                                    DebitAccount.GLAccountID,
                                    DebitAccount.GLAccountNo,
                                    CreditAccount.GLAccountName,
                                    Journals.GLJournalDate,
                                    Journals.GLJournalDocumentNo,
                                    Journals.GLSourceLedger,
                                    CreditAccount.GLAccountNo,
                                    Journals.FK_GECurrencyID,
                                    Journals.GLJournalExRate,
                                    Journals.GLJournalHDesc


                                    UNION ALL

                                    -- Co phat sinh
                                    SELECT 
                                    0 AS ViewAccountDoiUngID,
                                    CreditAccount.GLAccountID AS AccountID,
                                    CreditAccount.GLAccountNo AS AccountNo,
                                    CreditAccount.GLAccountName AS AccountDoiUngName,
                                    0 AS DebitAmt,
                                    0 AS DebitFAmt,
                                    SUM(GLJournalAmt) AS CreditAmt,
                                    SUM(GLJournalFAmt) AS CreditFAmt,
                                    Journals.GLJournalDate  AS  JournalDate,
                                    Journals.GLJournalDocumentNo AS DocumentNo,
                                    Journals.GLSourceLedger AS SourceLedger,
                                    DebitAccount.GLAccountNo AS AccountDoiUngNo,
                                    Journals.FK_GECurrencyID AS FK_GECurrencyID,
                                    Journals.GLJournalExRate AS ExcRate,
                                    Journals.GLJournalHDesc AS JournalHDesc
                                    FROM Journals, GLAccounts AS DebitAccount, GLAccounts AS CreditAccount
                                    WHERE
                                    Journals.FK_GLDebitAccountID = DebitAccount.GLAccountID
                                    AND Journals.FK_GLCreditAccountID = CreditAccount.GLAccountID
                                    AND DebitAccount.GLAccountID > 0
                                    AND CreditAccount.GLAccountID > 0
                                    AND {0}
                                    AND CreditAccount.GLAccountNo like '{1}%'
                                    AND (Journals.FK_GECurrencyID = {2} OR 0 = {2} OR {2} = {3})
                                    GROUP BY
                                    CreditAccount.GLAccountID,
                                    CreditAccount.GLAccountNo,
                                    CreditAccount.GLAccountName,
                                    Journals.GLJournalDate,
                                    Journals.GLJournalDocumentNo,
                                    Journals.GLSourceLedger,
                                    DebitAccount.GLAccountNo,
                                    Journals.FK_GECurrencyID,
                                    Journals.GLJournalExRate,
                                    Journals.GLJournalHDesc
                                    ) AS TEMP
                                    ORDER BY JournalDate
                                    ", strInRange, strAccountNo, iCurrencyID, iHomeCurrencyID);
            #endregion

            #endregion

            String strQuery = String.Format(@"{0}
                                              {1}
                                              {2}", strQueryAllObjects, strCollectJournalAndObjects,
                                                  strQueryJournal);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            using (TransactionScope tranScope = new TransactionScope())
            {
                ds = GetDataSet(strQuery);
            }

            return ds;
        }

        public DataSet GetAllAccountDoiungs(String strAccountNo, DateTime dtFrom, DateTime dtTo, String strObjKey = "")
        {
            //(LINHCLH - 14/11/2013 - Bo sung dieu kien
            if (strObjKey.Trim().Length > 0)
                strObjKey = " AND " + strObjKey;
            //)
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);

            #region Prepair Query

            #region Get All Journals
            String strQueryJournal
                = String.Format(@"-- No phat sinh
                                    SELECT 
                                    0 AS ViewAccountDoiUngID,
                                    DebitAccount.GLAccountID AS AccountID,
                                    DebitAccount.GLAccountNo AS AccountNo,
                                    CreditAccount.GLAccountName AS AccountDoiUngName,
                                    SUM(GLJournalAmt) AS DebitAmt,
                                    SUM(GLJournalFAmt) AS DebitFAmt,
                                    0 as CreditAmt,
                                    0 AS CreditFAmt,
                                    GLJournals.GLJournalDate  AS  JournalDate,
                                    GLJournals.GLJournalDocDate  AS  JournalDocDate,
                                    GLJournals.GLJournalDocumentNo AS DocumentNo,
                                    GLJournals.GLSourceLedger AS SourceLedger,
                                    CreditAccount.GLAccountNo AS AccountDoiUngNo,
                                    GLJournals.FK_GECurrencyID AS FK_GECurrencyID,
                                    GLJournals.GLJournalExRate AS ExcRate,
                                    GLJournals.FK_ICProductID AS FK_ICProductID,
                                    MAX(GLJournals.GLJournalDesc) as JournalDesc,
                                    MAX(GLJournals.GLJournalHDesc) as JournalHDesc
                                    FROM GLJournals, GLAccounts AS DebitAccount, GLAccounts AS CreditAccount
                                    WHERE
                                    GLJournals.FK_GLDebitAccountID = DebitAccount.GLAccountID
                                    AND GLJournals.FK_GLCreditAccountID = CreditAccount.GLAccountID
                                    AND DebitAccount.GLAccountID > 0
                                    AND CreditAccount.GLAccountID > 0
                                    AND {0}
                                    AND DebitAccount.GLAccountNo like '{1}%'
                                    {2}
                                    GROUP BY 
                                    DebitAccount.GLAccountID ,
                                    DebitAccount.GLAccountNo,
                                    CreditAccount.GLAccountName,
                                    GLJournals.GLJournalDate  ,
                                    GLJournals.GLJournalDocDate  ,
                                    GLJournals.GLJournalDocumentNo,
                                    GLJournals.GLSourceLedger,
                                    CreditAccount.GLAccountNo,
                                    GLJournals.FK_GECurrencyID,
                                    GLJournals.GLJournalExRate,
                                    GLJournals.FK_ICProductID

                                    UNION ALL

                                    -- Co phat sinh
                                    SELECT 
                                    0 AS ViewAccountDoiUngID,
                                    CreditAccount.GLAccountID AS AccountID,
                                    CreditAccount.GLAccountNo AS AccountNo,
                                    DebitAccount.GLAccountName AS AccountDoiUngName,
                                    0 AS DebitAmt,
                                    0 AS DebitFAmt,
                                    SUM(GLJournalAmt) AS CreditAmt,
                                    SUM(GLJournalFAmt) AS CreditFAmt,
                                    GLJournals.GLJournalDate  AS  JournalDate,
                                    GLJournals.GLJournalDocDate  AS  JournalDocDate,
                                    GLJournals.GLJournalDocumentNo AS DocumentNo,
                                    GLJournals.GLSourceLedger AS SourceLedger,
                                    DebitAccount.GLAccountNo AS AccountDoiUngNo,
                                    GLJournals.FK_GECurrencyID AS FK_GECurrencyID,
                                    GLJournals.GLJournalExRate AS ExcRate,
                                    GLJournals.FK_ICProductID AS FK_ICProductID,
                                    MAX(GLJournals.GLJournalDesc) as JournalDesc,
                                    MAX(GLJournals.GLJournalHDesc) as JournalHDesc
                                    FROM GLJournals, GLAccounts AS DebitAccount, GLAccounts AS CreditAccount
                                    WHERE
                                    GLJournals.FK_GLDebitAccountID = DebitAccount.GLAccountID
                                    AND GLJournals.FK_GLCreditAccountID = CreditAccount.GLAccountID
                                    AND DebitAccount.GLAccountID > 0
                                    AND CreditAccount.GLAccountID > 0
                                    AND {0}
                                    AND CreditAccount.GLAccountNo like '{1}%'
                                    {2}
                                    GROUP BY 
                                    CreditAccount.GLAccountID,
                                    CreditAccount.GLAccountNo,
                                    DebitAccount.GLAccountName,
                                    GLJournals.GLJournalDate,
                                    GLJournals.GLJournalDocDate,
                                    GLJournals.GLJournalDocumentNo,
                                    GLJournals.GLSourceLedger,
                                    DebitAccount.GLAccountNo,
                                    GLJournals.FK_GECurrencyID,
                                    GLJournals.GLJournalExRate,
                                    GLJournals.FK_ICProductID
                                    ", strInRange, strAccountNo, strObjKey);
            #endregion


            #endregion

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());
            using (TransactionScope tranScope = new TransactionScope())
            {
                ds = GetDataSet(strQueryJournal);
            }

            return ds;
        }

        public DataSet GetAllAccountDoiungs(String strAccountNo, int iProductID, DateTime dtFrom, DateTime dtTo)
        {
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);

            #region Prepair Query

            #region Get All Journals
            String strQueryJournal
                = String.Format(@"-- No phat sinh
                                    SELECT ViewAccountDoiUngID, AccountID, AccountNo, DocumentNo, SUM(DebitAmt) AS DebitAmt, SUM(DebitFAmt) AS DebitFAmt, SUM(CreditAmt) AS CreditAmt, SUM(CreditFAmt) AS CreditFAmt, FK_ICProductID
                                    FROM (
                                    SELECT 
                                    0 AS ViewAccountDoiUngID,
                                    DebitAccount.GLAccountID AS AccountID,
                                    DebitAccount.GLAccountNo AS AccountNo,
                                    CreditAccount.GLAccountName AS AccountDoiUngName,
                                    SUM(GLJournalAmt) AS DebitAmt,
                                    SUM(GLJournalFAmt) AS DebitFAmt,
                                    0 as CreditAmt,
                                    0 AS CreditFAmt,
                                    GLJournals.GLJournalDate  AS  JournalDate,
                                    GLJournals.GLJournalDocumentNo AS DocumentNo,
                                    GLJournals.GLSourceLedger AS SourceLedger,
                                    CreditAccount.GLAccountNo AS AccountDoiUngNo,
                                    GLJournals.FK_GECurrencyID AS FK_GECurrencyID,
                                    GLJournals.GLJournalExRate AS ExcRate,
                                    GLJournals.FK_ICProductID AS FK_ICProductID
                                    FROM GLJournals, GLAccounts AS DebitAccount, GLAccounts AS CreditAccount
                                    WHERE
                                    GLJournals.FK_GLDebitAccountID = DebitAccount.GLAccountID
                                    AND GLJournals.FK_GLCreditAccountID = CreditAccount.GLAccountID
                                    AND DebitAccount.GLAccountID > 0
                                    AND CreditAccount.GLAccountID > 0
                                    AND GLJournals.FK_ICProductID = {2}
                                    AND {0}
                                    AND DebitAccount.GLAccountNo like '{1}%'
                                    GROUP BY 
                                    DebitAccount.GLAccountID ,
                                    DebitAccount.GLAccountNo,
                                    CreditAccount.GLAccountName,
                                    GLJournals.GLJournalDate  ,
                                    GLJournals.GLJournalDocumentNo,
                                    GLJournals.GLSourceLedger,
                                    CreditAccount.GLAccountNo,
                                    GLJournals.FK_GECurrencyID,
                                    GLJournals.GLJournalExRate,
                                    GLJournals.FK_ICProductID

                                    UNION ALL

                                    -- Co phat sinh
                                    SELECT 
                                    0 AS ViewAccountDoiUngID,
                                    CreditAccount.GLAccountID AS AccountID,
                                    CreditAccount.GLAccountNo AS AccountNo,
                                    DebitAccount.GLAccountName AS AccountDoiUngName,
                                    0 AS DebitAmt,
                                    0 AS DebitFAmt,
                                    SUM(GLJournalAmt) AS CreditAmt,
                                    SUM(GLJournalFAmt) AS CreditFAmt,
                                    GLJournals.GLJournalDate  AS  JournalDate,
                                    GLJournals.GLJournalDocumentNo AS DocumentNo,
                                    GLJournals.GLSourceLedger AS SourceLedger,
                                    DebitAccount.GLAccountNo AS AccountDoiUngNo,
                                    GLJournals.FK_GECurrencyID AS FK_GECurrencyID,
                                    GLJournals.GLJournalExRate AS ExcRate,
                                    GLJournals.FK_ICProductID AS FK_ICProductID
                                    FROM GLJournals, GLAccounts AS DebitAccount, GLAccounts AS CreditAccount
                                    WHERE
                                    GLJournals.FK_GLDebitAccountID = DebitAccount.GLAccountID
                                    AND GLJournals.FK_GLCreditAccountID = CreditAccount.GLAccountID
                                    AND DebitAccount.GLAccountID > 0
                                    AND CreditAccount.GLAccountID > 0
                                    AND GLJournals.FK_ICProductID = {2}
                                    AND {0}
                                    AND CreditAccount.GLAccountNo like '{1}%'
                                    GROUP BY 
                                    CreditAccount.GLAccountID,
                                    CreditAccount.GLAccountNo,
                                    DebitAccount.GLAccountName,
                                    GLJournals.GLJournalDate,
                                    GLJournals.GLJournalDocumentNo,
                                    GLJournals.GLSourceLedger,
                                    DebitAccount.GLAccountNo,
                                    GLJournals.FK_GECurrencyID,
                                    GLJournals.GLJournalExRate,
                                    GLJournals.FK_ICProductID
                                    ) AS TB
                                    GROUP BY 
                                    ViewAccountDoiUngID,
                                    AccountID,
                                    AccountNo,
                                    DocumentNo,
                                    FK_ICProductID
                                    ", strInRange, strAccountNo, iProductID);
            #endregion


            #endregion

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());
            using (TransactionScope tranScope = new TransactionScope())
            {
                ds = GetDataSet(strQueryJournal);
            }

            return ds;
        }
        //(LINHCLH - 01/11/2013 - Lay phat sinh theo tk, tk du
        public double CalcAmtByDebitAndCredit(String strDebitAccountNos, String strCreditAccountNos, DateTime dtFrom, DateTime dtTo)
        {
            double _dRet = 0;
            strDebitAccountNos = strDebitAccountNos.Replace("*", "");
            strCreditAccountNos = strCreditAccountNos.Replace("*", "");

            String strKeyDebit = String.Format(@"b.AAStatus = 'Alive' AND (b.GLAccountNo like '{0}%')"
                , strDebitAccountNos.Replace(",", "%' OR b.GLAccountNo like '"));

            String strKeyCredit = String.Format(@"c.AAStatus = 'Alive' AND (c.GLAccountNo like '{0}%')"
                , strCreditAccountNos.Replace(",", "%' OR c.GLAccountNo like '"));

            String strQuery = String.Format(@"SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
                BEGIN TRANSACTION
                    SELECT SUM(GLJournalAmt) FROM GLJournals a 
                        INNER JOIN GLAccounts b ON a.FK_GLDebitAccountID = b.GLAccountID
                        INNER JOIN GLAccounts c ON a.FK_GLCreditAccountID = c.GLAccountID
                        WHERE {0} AND {1} AND {2}
                ROLLBACK TRANSACTION"
                , DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo), strKeyDebit, strKeyCredit);
            DataSet ds = GetDataSet(strQuery);


            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                _dRet = Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return _dRet;
        }
        public double CalcAmtByCashFlowNo(String strCashFlowNo, DateTime dtFrom, DateTime dtTo)
        {
            double _dRet = 0;

            String strQuery = String.Format(@"SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
                BEGIN TRANSACTION
                    SELECT SUM(GLJournalAmt) FROM GLJournals a 
                        INNER JOIN GLCashFlows b ON a.FK_GLCashFlowID = b.GLCashFlowID AND b.AAStatus = 'Alive'
                            AND GLCashFlowNo IN ('{1}')
						INNER JOIN GLAccounts c ON a.FK_GLDebitAccountID = c.GLAccountID
						INNER JOIN GLAccounts d ON a.FK_GLCreditAccountID = d.GLAccountID
                        WHERE (c.GLAccountTypeCombo = 'CM' OR d.GLAccountTypeCombo = 'CM') AND {0}
                ROLLBACK TRANSACTION"
                , DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo), strCashFlowNo.Replace(",","','"));
            DataSet ds = GetDataSet(strQuery);


            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                _dRet = Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return _dRet;
        }
        //Len bang CDPS co SD dau nam, PS luy ke tu dau nam, khong bi gioi gian 4 cap tk
        public DataSet CalcTrialBalance(String strAccountNo, DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, int iLevel, bool bNotKC911 = false, bool bKoButruSDTH = true, bool bDetailObj = false, bool bDelEmptyData = true, int iBranchID = 0, int iCurrencyID = 0)
        {
            //return CalcTrialBalanceOld(strAccountNo, dtFrom, dtTo, dtLastStartFiscalYear, iLevel);
            String strQuery = String.Format(
                @"
                    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
                        --BANG CAN DOI PHAT SINH
                        SET NOCOUNT ON
                        DECLARE @sAccountNo as nvarchar(50),
		                        @dStart as datetime,
		                        @dFrom as datetime,
		                        @dTo as datetime,
		                        @iViewLevel as int,
		                        @bViewObjects as bit,
		                        @bKoButru as bit,
                                @bNotKC911 as bit,
                                @bDelEmptyData as bit,
								@iBranchID as int,
                                @iCurrencyID as int

                        SET @sAccountNo = '{0}%'
                        SET @dStart = '{1}'
                        SET @dFrom = '{2}'
                        SET @dTo = '{3}'
                        SET @iViewLevel = {4}
                        SET @bNotKC911 = {5}
                        SET @bKoButru = {6}                        
                        SET @bViewObjects = {7}
                        SET @bDelEmptyData = {8}
						SET @iBranchID = {9}
						SET @iCurrencyID = {10}
                        --(Loc du lieu ra de tang toc do truy van
                        SELECT  GLAccountID, GLAccountNO, GLAccountName, 
                                GLAccountLevel, GLAccountBalanceCombo,FK_GLAccountParentID, GLAccountTypeCombo
                        INTO #tGLAccounts
                        FROM dbo.GLAccounts 
                        WHERE AAStatus = 'Alive' AND GLAccountNo LIKE @sAccountNo 

                        SELECT GLAccountID INTO #tGLAccountsNC
	                        FROM #tGLAccounts 
	                        WHERE (GLAccountBalanceCombo = 'NC' OR GLAccountTypeCombo IN ('AR','AP'))

						SELECT GLAccountID INTO #tGLAccountsNotNC
	                        FROM #tGLAccounts 
	                        WHERE NOT (GLAccountBalanceCombo = 'NC' OR GLAccountTypeCombo IN ('AR','AP'))

                        SELECT GLAccountID INTO #t911 
                            FROM dbo.GLAccounts 
                            WHERE LEFT(GLAccountNo,3) = '911'

                        --(Dau nam tai chinh
                        SELECT	FK_GLDebitAccountID,FK_GLCreditAccountID,
		                        GLJournalAmt,
		                        GLJournalFAmt,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
		                INTO #tSDDK
                        FROM dbo.GLJournals
                        WHERE GLJournalPeriod = 0 AND GLJournalYear = Year(@dStart)
                                AND (FK_GLDebitAccountID > 0 OR FK_GLCreditAccountID > 0)
								AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
								AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
                        --)
                        --(PS tu dau nam
                        SELECT	FK_GLDebitAccountID,FK_GLCreditAccountID,
		                        GLJournalAmt,
		                        GLJournalFAmt,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID,
                                FK_ARCustomerIDCredit,
		                        FK_APSupplierIDCredit,
		                        FK_HREmployeeIDCredit,
                                0 as isBTCN
		                INTO #tPSDK
                        FROM dbo.GLJournals
                        WHERE GLJournalPeriod <> 0 
                            AND CONVERT(VARCHAR(20), GLJournalDate, 112) between CONVERT(VARCHAR(20),@dStart,112) and CONVERT(VARCHAR(20),@dFrom - 1,112)
							AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
							AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
                        --)
                        --(PS Trong ky                   
                        SELECT	FK_GLDebitAccountID,FK_GLCreditAccountID,
		                        GLJournalAmt,
		                        GLJournalFAmt,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID,
		                        FK_ARCustomerIDCredit,
		                        FK_APSupplierIDCredit,
		                        FK_HREmployeeIDCredit,
                                0 as isBTCN,
								GLSourceLedger
		                INTO #tPSTK
                        FROM dbo.GLJournals
                        WHERE GLJournalPeriod <> 0 --AND GLJournalDate BETWEEN @dFrom AND @dTo
	                        AND CONVERT(VARCHAR(20), GLJournalDate, 112) between CONVERT(VARCHAR(20),@dFrom,112) and CONVERT(VARCHAR(20),@dTo,112)
	                        AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
							AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
						IF @bNotKC911 = 1
                            DELETE FROM #tPSTK 
								WHERE	GLSourceLedger = 'PeriodTransfer'
/*
						IF @bNotKC911 = 1
							DELETE FROM #tPSTK 
								WHERE	FK_GLDebitAccountID IN (SELECT GLAccountID FROM #t911) OR
										FK_GLCreditAccountID IN (SELECT GLAccountID FROM #t911)
*/
                        --)
                        --(Xu ly du lieu BTCN
                        UPDATE #tPSDK SET isBTCN = 1 
                            FROM #tPSDK a 
                            INNER JOIN #tGLAccountsNC b ON a.FK_GLDebitAccountID = b.GLAccountID
                            INNER JOIN #tGLAccountsNC c ON a.FK_GLCreditAccountID = c.GLAccountID
                        UPDATE #tPSTK SET isBTCN = 1 
                            FROM #tPSTK a 
                            INNER JOIN #tGLAccountsNC b ON a.FK_GLDebitAccountID = b.GLAccountID
                            INNER JOIN #tGLAccountsNC c ON a.FK_GLCreditAccountID = c.GLAccountID
                        UPDATE #tPSDK SET 
							FK_ARCustomerIDCredit = FK_ARCustomerID,
							FK_APSupplierIDCredit = FK_APSupplierID,
							FK_HREmployeeIDCredit = FK_HREmployeeID
							WHERE	isBTCN = 1 
									AND FK_ARCustomerIDCredit = 0
									AND FK_APSupplierIDCredit = 0
									AND FK_HREmployeeIDCredit = 0
                        UPDATE #tPSTK SET 
							FK_ARCustomerIDCredit = FK_ARCustomerID,
							FK_APSupplierIDCredit = FK_APSupplierID,
							FK_HREmployeeIDCredit = FK_HREmployeeID
							WHERE	isBTCN = 1 
									AND FK_ARCustomerIDCredit = 0
									AND FK_APSupplierIDCredit = 0
									AND FK_HREmployeeIDCredit = 0

                        --)
                        --(Tao bang du lieu chi tiet
                        --DuN dau nam tai chinh
                        SELECT	FK_GLDebitAccountID as FK_GLAccountID, 
		                        GLJournalAmt as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        GLJournalFAmt as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        INTO #tData
                        FROM #tSDDK
                        WHERE FK_GLDebitAccountID > 0 AND FK_GLDebitAccountID is not null
                        UNION ALL
                        --DuC dau nam tai chinh
                        SELECT	FK_GLCreditAccountID, 
		                        0 as DK_No0,
		                        GLJournalAmt as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        GLJournalFAmt as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        FROM #tSDDK
                        WHERE FK_GLCreditAccountID > 0 AND FK_GLCreditAccountID is not null
                        UNION ALL
                        --PSN luy ke tu dau nam den dau ngay bao cao
                        SELECT	FK_GLDebitAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        GLJournalAmt as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        GLJournalFAmt as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        FROM #tPSDK
                        UNION ALL
                        --PSC luy ke tu dau nam den dau ngay bao cao
                        SELECT	FK_GLCreditAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        GLJournalAmt as Ps_co0,
		                        0 as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        GLJournalFAmt as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        CASE isBTCN WHEN 1 THEN FK_ARCustomerIDCredit ELSE FK_ARCustomerID END as FK_ARCustomerID,
		                        CASE isBTCN WHEN 1 THEN FK_APSupplierIDCredit ELSE FK_APSupplierID END as FK_APSupplierID,
		                        CASE isBTCN WHEN 1 THEN FK_HREmployeeIDCredit ELSE FK_HREmployeeID END as FK_HREmployeeID
                        FROM #tPSDK
                        UNION ALL
                        --PSN trong ky bao cao
                        SELECT	FK_GLDebitAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        GLJournalAmt as Ps_no,
		                        0 as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        GLJournalFAmt as Ps_no_NT,
		                        0 as Ps_co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        FROM #tPSTK
                        UNION ALL
                        --PSC trong ky bao cao
                        SELECT	FK_GLCreditAccountID, 
		                        0 as DK_No0,
		                        0 as DK_Co0,
		                        0 as Ps_no0,
		                        0 as Ps_co0,
		                        0 as Ps_no,
		                        GLJournalAmt as Ps_co,
		                        0 as DK_No0_NT,
		                        0 as DK_Co0_NT,
		                        0 as Ps_no0_NT,
		                        0 as Ps_co0_NT,
		                        0 as Ps_no_NT,
		                        GLJournalFAmt as Ps_co_NT,
                                CASE isBTCN WHEN 1 THEN FK_ARCustomerIDCredit ELSE FK_ARCustomerID END as FK_ARCustomerID,
		                        CASE isBTCN WHEN 1 THEN FK_APSupplierIDCredit ELSE FK_APSupplierID END as FK_APSupplierID,
		                        CASE isBTCN WHEN 1 THEN FK_HREmployeeIDCredit ELSE FK_HREmployeeID END as FK_HREmployeeID
                        FROM #tPSTK
                        --)

                        --(Bo doi tuong cac tai khoan khong theo doi doi tuong
                        UPDATE #tData
                            set FK_ARCustomerID = 0,
	                            FK_APSupplierID = 0,
	                            FK_HREmployeeID = 0
                        FROM #tData a 
                        INNER JOIN #tGLAccountsNotNC b ON a.FK_GLAccountID = b.GLAccountID
                        --)

                        --(Tinh tong theo doi tuong
                        SELECT FK_GLAccountID,
		                        SUM(DK_No0) as DK_No0,
		                        SUM(DK_Co0) as DK_Co0,
		                        SUM(PS_no0) as PS_NO0,
		                        SUM(PS_co0) as PS_Co0,
		                        cast (0 as float) as Dk_No,
		                        cast (0 as float) as Dk_Co,
		                        SUM(PS_no) as PS_NO,
		                        SUM(PS_co) as PS_Co,
		                        cast (0 as float) as ck_No,
		                        cast (0 as float) as Ck_Co,
		                        SUM(DK_No0_NT) as DK_No0_NT,
		                        SUM(DK_Co0_NT) as DK_Co0_NT,
		                        SUM(PS_no0_NT) as PS_NO0_NT,
		                        SUM(PS_co0_NT) as PS_Co0_NT,
		                        cast (0 as float) as Dk_No_NT,
		                        cast (0 as float) as Dk_Co_NT,
		                        SUM(PS_no_NT) as PS_NO_NT,
		                        SUM(PS_co_NT) as PS_Co_NT,
		                        cast (0 as float) as ck_No_NT,
		                        cast (0 as float) as Ck_Co_NT,
		                        FK_ARCustomerID,
		                        FK_APSupplierID,
		                        FK_HREmployeeID
                        INTO #tKQ
                        FROM #tData a
                        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID 
                        GROUP BY	FK_GLAccountID,
			                        FK_ARCustomerID,
			                        FK_APSupplierID,
			                        FK_HREmployeeID
                        --)


                        --(Tinh lai so du dau nam va dau ky chi tiet dau nam tai chinh
                        UPDATE #tKQ set 
		                        dk_no0 = dk_no0 - dk_co0,
		                        dk_co0 = 0
	                        WHERE dk_co0 <> 0 AND dk_no0 >= dk_co0
	                    
	                    UPDATE #tKQ set 
		                        dk_no0_NT = dk_no0_NT - dk_co0_NT,
		                        dk_co0_NT = 0
	                        WHERE dk_co0_NT <> 0 AND dk_no0_NT >= dk_co0_NT

                        UPDATE #tKQ set 
		                        dk_co0 = dk_co0 - dk_no0,
		                        dk_no0 = 0
	                        WHERE dk_no0 <> 0 AND dk_co0 >= dk_no0
	                     
	                     UPDATE #tKQ set 
		                        dk_co0_NT = dk_co0_NT - dk_no0_NT,
		                        dk_no0_NT = 0
	                        WHERE dk_no0_NT <> 0 AND dk_co0_NT >= dk_no0_NT
						--)
						--(TInh so du dau ky
                        UPDATE #tKQ set 
		                        dk_no = dk_no0 - dk_co0 + ps_no0 - ps_co0
		                        
		                UPDATE #tKQ set 
		                        dk_no_NT = dk_no0_NT - dk_co0_NT + ps_no0_NT - ps_co0_NT
		
                        UPDATE #tKQ set 
		                        dk_co = ABS(dk_no),
		                        dk_no = 0
	                        WHERE dk_no < 0
	                    
	                    UPDATE #tKQ set 
		                        dk_co_NT = ABS(dk_no_NT),
		                        dk_no_NT = 0
	                        WHERE dk_no_NT < 0
                        --)
						--(TInh so du cuoi ky
                        UPDATE #tKQ set 
		                        ck_no = dk_no - dk_co + ps_no - ps_co
		
                        UPDATE #tKQ set 
		                        ck_no_NT = dk_no_NT - dk_co_NT + ps_no_NT - ps_co_NT
		                        
                        UPDATE #tKQ set 
		                        ck_co = ABS(ck_no),
		                        ck_no = 0
	                        WHERE ck_no < 0
	                    
	                    UPDATE #tKQ set 
		                        ck_co_NT = ABS(ck_no_NT),
		                        ck_no_NT = 0
	                        WHERE ck_no_NT < 0
                        --)

                        --(Xoa du lieu ko phat sinh
                        if @bDelEmptyData = 1
                            DELETE FROM #tKQ 
                                WHERE   dk_no = 0 AND dk_co = 0 AND ps_no = 0 AND ps_co = 0 AND ck_no = 0 AND ck_co = 0 AND
                                        dk_no_nt = 0 AND dk_co_nt = 0 AND ps_no_nt = 0 AND ps_co_nt = 0 AND ck_no_nt = 0 AND ck_co_nt = 0
                        --)

                        --(Tinh tong cac tk theo doi chi tiet doi tuong
                        SELECT FK_GLAccountID,
		                        SUM(DK_No0) as DK_No0,
		                        SUM(DK_Co0) as DK_Co0,
		                        SUM(PS_no0) as PS_NO0,
		                        SUM(PS_co0) as PS_Co0,
		                        SUM(DK_No) as DK_No,
		                        SUM(DK_Co) as DK_Co,
		                        SUM(PS_no) as PS_NO,
		                        SUM(PS_co) as PS_Co,
		                        SUM(ck_No) as ck_No,
		                        SUM(ck_Co) as ck_Co,
		                        SUM(DK_No0_NT) as DK_No0_NT,
		                        SUM(DK_Co0_NT) as DK_Co0_NT,
		                        SUM(PS_no0_NT) as PS_NO0_NT,
		                        SUM(PS_co0_NT) as PS_Co0_NT,
		                        SUM(DK_No_NT) as DK_No_NT,
		                        SUM(DK_Co_NT) as DK_Co_NT,
		                        SUM(PS_no_NT) as PS_NO_NT,
		                        SUM(PS_co_NT) as PS_Co_NT,
		                        SUM(ck_No_NT) as ck_No_NT,
		                        SUM(ck_Co_NT) as ck_Co_NT,
		                        0 as FK_ARCustomerID,
		                        0 as FK_APSupplierID,
		                        0 as FK_HREmployeeID
                        INTO #tKQCN
                        FROM #tKQ a
                        INNER JOIN #tGLAccountsNC b ON a.FK_GLAccountID = b.GLAccountID 
                        --WHERE b.GLAccountBalanceCombo = 'NC' --FK_ARCustomerID + FK_APSupplierID + FK_HREmployeeID > 0
                        GROUP BY	FK_GLAccountID

                        --)
                        
                        --(CHi tiet doi tuong
						SELECT * INTO #tKQCTCN 
							FROM #tKQ a 
							INNER JOIN #tGLAccountsNC b ON a.FK_GLAccountID = b.GLAccountID
							WHERE @bViewObjects = 1
                        --)
											
						DELETE FROM #tKQ 
							WHERE FK_GLAccountID IN (SELECT GLAccountID 
								FROM #tGLAccountsNC)
		
                        INSERT INTO #tKQ 
	                        SELECT * FROM #tKQCN

                        --(Tinh cac toai khoan cha
                        
                        DECLARE @iLevel as int
                        SELECT @iLevel = max(GLAccountLevel)
	                        FROM #tGLAccounts a INNER JOIN #tKQ b ON a.GLACCountID = b.FK_GLAccountID
	
                        WHILE @iLevel > 1
                        BEGIN

	                        SELECT c.GLAccountID,
		                        SUM(DK_No0) as DK_No0,
		                        SUM(DK_Co0) as DK_Co0,
		                        SUM(PS_NO0) as PS_NO0,
		                        SUM(PS_Co0) as PS_Co0,
		                        SUM(DK_No) as DK_No,
		                        SUM(DK_Co) as DK_Co,
		                        SUM(PS_NO) as PS_NO,
		                        SUM(PS_Co) as PS_Co,
		                        SUM(CK_No) as CK_No,
		                        SUM(CK_Co) as CK_Co,
		                        SUM(DK_No0_NT) as DK_No0_NT,
		                        SUM(DK_Co0_NT) as DK_Co0_NT,
		                        SUM(PS_NO0_NT) as PS_NO0_NT,
		                        SUM(PS_Co0_NT) as PS_Co0_NT,
		                        SUM(DK_No_NT) as DK_No_NT,
		                        SUM(DK_Co_NT) as DK_Co_NT,
		                        SUM(PS_NO_NT) as PS_NO_NT,
		                        SUM(PS_Co_NT) as PS_Co_NT,
		                        SUM(CK_No_NT) as CK_No_NT,
		                        SUM(CK_Co_NT) as CK_Co_NT,
		                        0 as FK_ARCustomerID,
		                        0 as FK_APSupplierID,
		                        0 as FK_HREmployeeID
	                        into #tAppend
	                        FROM #tKQ a INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
		                        INNER JOIN #tGLAccounts c ON b.FK_GLAccountParentID = c.GLAccountID
	                        WHERE b.GLAccountLevel = @iLevel
	                        GROUP BY c.GLAccountID
	
	                        if @bKoButru = 0
	                        BEGIN
		                        UPDATE #tAppend SET 
				                        dk_no0 = dk_no0 - dk_co0,
				                        dk_co0 = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_co0 <> 0 AND dk_no0 >= dk_co0
			
		                        UPDATE #tAppend SET 
				                        dk_co0 = dk_co0 - dk_no0,
				                        dk_no0 = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_no0 <> 0 AND dk_co0 >= dk_no0
			                        		
		                        UPDATE #tAppend SET 
				                        dk_no = dk_no - dk_co,
				                        dk_co = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_co <> 0 AND dk_no >= dk_co

		                        UPDATE #tAppend set 
				                        dk_co = dk_co - dk_no,
				                        dk_no = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_no <> 0 AND dk_co >= dk_no
		                        --)

		                        --(Tinh lai so du dau ky va cuoi ky chi tiet 

		                        UPDATE #tAppend SET 
				                        ck_no = ck_no - ck_co,
				                        ck_co = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE ck_co <> 0 AND ck_no >= ck_co			                        

		                        UPDATE #tAppend SET 
				                        ck_co = ck_co - ck_no,
				                        ck_no = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE ck_no <> 0 AND ck_co >= ck_no

		                        --)		
		                        
		                        
		                        --(NT
		                        UPDATE #tAppend SET 
				                        dk_no0_NT = dk_no0_NT - dk_co0_NT,
				                        dk_co0_NT = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_co0_NT <> 0 AND dk_no0_NT >= dk_co0_NT

		                        UPDATE #tAppend SET 
				                        dk_co0_NT = dk_co0_NT - dk_no0_NT,
				                        dk_no0_NT = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_no0_NT <> 0 AND dk_co0_NT >= dk_no0_NT
		
		                        UPDATE #tAppend SET 
				                        dk_no_NT = dk_no_NT - dk_co_NT,
				                        dk_co_NT = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_co_NT <> 0 AND dk_no_NT >= dk_co_NT

		                        UPDATE #tAppend SET 
				                        dk_co_NT = dk_co_NT - dk_no_NT,
				                        dk_no_NT = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE dk_no_NT <> 0 AND dk_co_NT >= dk_no_NT
		                        --)

		                        --(Tinh lai so du dau ky va cuoi ky chi tiet 

		                        UPDATE #tAppend SET 
				                        ck_no_NT = ck_no_NT - ck_co_NT,
				                        ck_co_NT = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE ck_co_NT <> 0 AND ck_no_NT >= ck_co_NT

		                        UPDATE #tAppend SET 
				                        ck_co_NT = ck_co_NT - ck_no_NT,
				                        ck_no_NT = 0
				                    FROM #tAppend a INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
			                        WHERE ck_no_NT <> 0 AND ck_co_NT >= ck_no_NT
		                        --)		
		                        
		                        
	                        END
	                        INSERT INTO #tKQ 
		                        SELECT * FROM #tAppend
	                        DROP TABLE #tAppend
	                        SET @iLevel = @iLevel - 1			
                        END

                        --(TInh tong cong
                        SELECT 
		                        0 as GLAccountID,
		                        'Total' as GLAccountNo,
		                        'Total' as GLAccountName,
		                        0 as GLAccountLevel,
		                        SUM(DK_No0) as DK_No0,
		                        SUM(DK_Co0) as DK_Co0,
		                        SUM(PS_NO0) as PS_NO0,
		                        SUM(PS_Co0) as PS_Co0,
		                        SUM(DK_No) as DK_No,
		                        SUM(DK_Co) as DK_Co,
		                        SUM(PS_NO) as PS_NO,
		                        SUM(PS_Co) as PS_Co,
		                        SUM(CK_No) as CK_No,
		                        SUM(CK_Co) as CK_Co,
		                        SUM(DK_No0_NT) as DK_No0_NT,
		                        SUM(DK_Co0_NT) as DK_Co0_NT,
		                        SUM(PS_NO0_NT) as PS_NO0_NT,
		                        SUM(PS_Co0_NT) as PS_Co0_NT,
		                        SUM(DK_No_NT) as DK_No_NT,
		                        SUM(DK_Co_NT) as DK_Co_NT,
		                        SUM(PS_NO_NT) as PS_NO_NT,
		                        SUM(PS_Co_NT) as PS_Co_NT,
		                        SUM(CK_No_NT) as CK_No_NT,
		                        SUM(CK_Co_NT) as CK_Co_NT,
		                        0 as FK_ARCustomerID,
		                        0 as FK_APSupplierID,
		                        0 as FK_HREmployeeID
                        INTO #tTotal
                        FROM #tKQ a
                        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
                        WHERE b.GLAccountLevel = 1
                        --)

                        --(Ket qua cuoi cung
                        SELECT *,
                            0 as FK_ICProductID,
					        0 as FK_FAAssetID,
					        0 as FK_GECurrencyID,
                            N'A. Tài khoản trong bảng' as GLTrialBalanceAccountType FROM (
                        SELECT 
	                        b.GLAccountID as FK_GLAccountID,
	                        b.GLAccountNo,
	                        b.GLAccountName,
	                        b.GLAccountLevel,
	                        DK_No0 as GLAccountBeginFYDebitAmt,
	                        DK_Co0 as GLAccountBeginFYCreditAmt,
	                        PS_NO0 as GLAccountAccumDebitAmt,
	                        PS_Co0 as GLAccountAccumCreditAmt,
	                        DK_No as GLAccountBeginDebitAmt,
	                        DK_Co as GLAccountBeginCreditAmt,
	                        PS_NO as GLAccountDebitAmt,
	                        PS_Co as GLAccountCreditAmt,
	                        CK_No as GLAccountEndDebitAmt,
	                        CK_Co as GLAccountEndCreditAmt,
	                        
	                        DK_No0_NT as GLAccountBeginFYDebitFAmt,
	                        DK_Co0_NT as GLAccountBeginFYCreditFAmt,
	                        PS_NO0_NT as GLAccountAccumDebitFAmt,
	                        PS_Co0_NT as GLAccountAccumCreditFAmt,
	                        DK_No_NT as GLAccountBeginDebitFAmt,
	                        DK_Co_NT as GLAccountBeginCreditFAmt,
	                        PS_NO_NT as GLAccountDebitFAmt,
	                        PS_Co_NT as GLAccountCreditFAmt,
	                        CK_No_NT as GLAccountEndDebitFAmt,
	                        CK_Co_NT as GLAccountEndCreditFAmt,
	                        FK_ARCustomerID,
	                        FK_APSupplierID,
	                        FK_HREmployeeID
                        FROM #tKQ a
                        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = GLAccountID
                        WHERE (@iViewLevel = 0 OR b.GLAccountLevel <= @iViewLevel)
                        
                        UNION ALL 
                        --(CHi tiet doi tuong
						SELECT b.GLAccountID,
								b.GLAccountNo + '.' + CASE WHEN a.FK_ARCustomerID > 0 AND c.AAStatus = 'Alive' THEN c.ARCustomerNo 
									WHEN a.FK_APSupplierID > 0 AND d.AAStatus = 'Alive' THEN d.APSupplierNo
									WHEN a.FK_HREmployeeID > 0 AND e.AAStatus = 'Alive' THEN e.HREmployeeNo 
									ELSE '<NULL>' END as GLAccountNo,
								CASE WHEN a.FK_ARCustomerID > 0 THEN c.ARCustomerName 
									WHEN a.FK_APSupplierID > 0 THEN d.APSupplierName
									WHEN a.FK_HREmployeeID > 0 THEN e.HREmployeeName 
									ELSE '<NULL>' END as GLAccountName,
								b.GLAccountLevel + 1,
								DK_No0 as GLAccountBeginFYDebitAmt,
								DK_Co0 as GLAccountBeginFYCreditAmt,
								PS_NO0 as GLAccountAccumDebitAmt,
								PS_Co0 as GLAccountAccumCreditAmt,
								DK_No as GLAccountBeginDebitAmt,
								DK_Co as GLAccountBeginCreditAmt,
								PS_NO as GLAccountDebitAmt,
								PS_Co as GLAccountCreditAmt,
								CK_No as GLAccountEndDebitAmt,
								CK_Co as GLAccountEndCreditAmt,
								
								DK_No0_NT as GLAccountBeginFYDebitFAmt,
								DK_Co0_NT as GLAccountBeginFYCreditFAmt,
								PS_NO0_NT as GLAccountAccumDebitFAmt,
								PS_Co0_NT as GLAccountAccumCreditFAmt,
								DK_No_NT as GLAccountBeginDebitFAmt,
								DK_Co_NT as GLAccountBeginCreditFAmt,
								PS_NO_NT as GLAccountDebitFAmt,
								PS_Co_NT as GLAccountCreditFAmt,
								CK_No_NT as GLAccountEndDebitFAmt,
								CK_Co_NT as GLAccountEndCreditFAmt,
								a.FK_ARCustomerID,
								a.FK_APSupplierID,
								a.FK_HREmployeeID
							FROM #tKQCTCN a 
								INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID 
								LEFT JOIN ARCustomers c ON a.FK_ARCustomerID = c.ARCustomerID 
								LEFT JOIN APSuppliers d ON a.FK_APSupplierID = d.APSupplierID 
								LEFT JOIN HREmployees e ON a.FK_HREmployeeID = e.HREmployeeID 
                        --)
                        --UNION ALL SELECT * FROM #tToTal
                        ) as a
                        ORDER BY GLAccountNo
                        --)                    
", strAccountNo, dtLastStartFiscalYear.ToString("yyyyMMdd"), dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"), iLevel
 , Convert.ToSByte(bNotKC911), Convert.ToSByte(bKoButruSDTH), Convert.ToSByte(bDetailObj), Convert.ToSByte(bDelEmptyData)
 ,iBranchID, iCurrencyID);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            ds = GetDataSet(strQuery);
            DataSet dsEx = new DataSet();
            dsEx = CalcTrialBalanceEx(strAccountNo, dtFrom, dtTo, dtLastStartFiscalYear, iLevel, bNotKC911, bKoButruSDTH, bDetailObj, bDelEmptyData,iBranchID);
            if (dsEx!=null && dsEx.Tables.Count > 0)
                ds.Tables[0].Merge(dsEx.Tables[0]);
            return ds;
        }
        public DataSet CalcTrialBalanceEx(String strAccountNo, DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, int iLevel, bool bNotKC911 = false, bool bKoButruSDTH = true, bool bDetailObj = false, bool bDelEmptyData = true, int iBranchID = 0, int iCurrencyID = 0)
        {
            //return CalcTrialBalanceOld(strAccountNo, dtFrom, dtTo, dtLastStartFiscalYear, iLevel);
            String strQuery = String.Format(@"
--BANG CAN DOI PHAT SINH
SET NOCOUNT ON
DECLARE @sAccountNo AS NVARCHAR(50) ,
    @dStart AS DATETIME ,
    @dFrom AS DATETIME ,
    @dTo AS DATETIME ,
    @iViewLevel AS INT ,
    @bViewObjects AS BIT ,
    @bKoButru AS BIT ,    
    @bDelEmptyData AS BIT,
	@iBranchID as int,
	@iCurrencyID as int

SET @sAccountNo = '{0}%'
SET @dStart = '{1}'
SET @dFrom = '{2}'
SET @dTo = '{3}'
SET @iViewLevel = {4}
SET @bKoButru = {5}                        
SET @bViewObjects = {6}
SET @bDelEmptyData = {7}
SET @iBranchID = {8}
SET @iCurrencyID = {9}
--(Loc du lieu ra de tang toc do truy van
SELECT  GLAccountID ,
        GLAccountNO ,
        GLAccountName ,
        GLAccountLevel ,
        GLAccountBalanceCombo ,
		GLAccountTypeCombo ,
        FK_GLAccountParentID
INTO    #tGLAccounts
FROM    dbo.GLAccounts
WHERE   AAStatus = 'Alive'
        AND GLAccountTypeCombo = 'OBS'
        AND GLAccountNo LIKE @sAccountNo 

SELECT  GLAccountID
INTO    #tGLAccountsNC
FROM    #tGLAccounts
WHERE   (GLAccountBalanceCombo = 'NC'OR GLAccountTypeCombo IN ('AR','AP'))

SELECT  GLAccountID
INTO    #tGLAccountsNotNC
FROM    #tGLAccounts
WHERE   NOT (GLAccountBalanceCombo = 'NC'OR GLAccountTypeCombo IN ('AR','AP'))

--(So du dau nam
SELECT  FK_GLAccountID ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID ,
        SUM(GLVoucherExItemDebitAmt - GLVoucherExItemCreditAmt) AS DK_NO0 ,
        CAST(0 AS FLOAT) AS DK_CO0 ,
        SUM(GLVoucherExItemDebitFAmt - GLVoucherExItemCreditFAmt) AS DK_NO0_NT ,
        CAST(0 AS FLOAT) AS DK_CO0_NT
INTO    #tSDDN
FROM    dbo.GLVoucherExItems
WHERE   AAStatus = 'Alive' AND CAST(CONVERT(VARCHAR(20), GLVoucherExItemDate, 112) AS DATETIME) < @dStart
		AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
		AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
GROUP BY FK_GLAccountID ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID

--(Tao bang du lieu chi tiet
--Du dau nam tai chinh
SELECT  FK_GLAccountID AS FK_GLAccountID ,
        CASE WHEN DK_No0 < 0 THEN CAST (0 AS FLOAT)
             ELSE DK_No0
        END AS DK_No0 ,
        CASE WHEN DK_No0 < 0 THEN ABS(DK_No0)
             ELSE CAST (0 AS FLOAT)
        END AS DK_Co0 ,
        CAST (0 AS FLOAT) AS Ps_no0 ,
        CAST (0 AS FLOAT) AS Ps_co0 ,
        CAST (0 AS FLOAT) AS Ps_no ,
        CAST (0 AS FLOAT) AS Ps_co ,
        CASE WHEN DK_No0_NT < 0 THEN CAST (0 AS FLOAT)
             ELSE DK_No0_NT
        END AS DK_No0_NT ,
        CASE WHEN DK_No0_NT < 0 THEN ABS(DK_No0_NT)
             ELSE CAST (0 AS FLOAT)
        END AS DK_Co0_NT ,
        CAST (0 AS FLOAT) AS Ps_no0_NT ,
        CAST (0 AS FLOAT) AS Ps_co0_NT ,
        CAST (0 AS FLOAT) AS Ps_no_NT ,
        CAST (0 AS FLOAT) AS Ps_co_NT ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID
INTO    #tData
FROM    #tSDDN
UNION ALL
--(PS TU DAU NAM
SELECT  FK_GLAccountID ,
        0 AS DK_No0 ,
        0 AS DK_Co0 ,
        GLVoucherExItemDebitAmt AS PS_NO0 ,
        GLVoucherExItemCreditAmt AS PS_CO0 ,
        0 AS Ps_no ,
        0 AS Ps_co ,
        0 AS DK_No0_NT ,
        0 AS DK_Co0_NT ,
        GLVoucherExItemDebitFAmt AS PS_NO0_NT ,
        GLVoucherExItemCreditFAmt AS PS_CO0_NT ,
        0 AS Ps_no_NT ,
        0 AS Ps_co_NT ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID
FROM    dbo.GLVoucherExItems
WHERE   AAStatus = 'Alive' AND CAST(CONVERT(VARCHAR(20), GLVoucherExItemDate, 112) AS DATETIME) BETWEEN @dStart AND @dFrom - 1
		AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
		AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
--)
UNION ALL
--(PS TRONG KY
SELECT  FK_GLAccountID ,
        0 AS DK_No0 ,
        0 AS DK_Co0 ,
        0 AS PS_NO0 ,
        0 AS PS_CO0 ,
        GLVoucherExItemDebitAmt AS PS_NO ,
        GLVoucherExItemCreditAmt AS PS_CO ,
        0 AS DK_No0_NT ,
        0 AS DK_Co0_NT ,
        0 AS PS_no0_NT ,
        0 AS PS_co0_NT ,
        GLVoucherExItemDebitFAmt AS PS_NO_NT ,
        GLVoucherExItemCreditFAmt AS PS_CO_NT ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID
FROM    dbo.GLVoucherExItems
WHERE   AAStatus = 'Alive' AND CAST(CONVERT(VARCHAR(20), GLVoucherExItemDate, 112) AS DATETIME) BETWEEN @dFrom AND @dTo
		AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
		AND (FK_GECurrencyID = @iCurrencyID OR @iCurrencyID = 0)
--)

--(Bo doi tuong cac tai khoan khong theo doi doi tuong
UPDATE  #tData
SET     FK_ARCustomerID = 0 ,
        FK_APSupplierID = 0 ,
        FK_HREmployeeID = 0 ,
        FK_ICProductID = 0 ,
        FK_FAAssetID = 0 ,
        FK_GECurrencyID = 0
FROM    #tData a
        INNER JOIN #tGLAccountsNotNC b ON a.FK_GLAccountID = b.GLAccountID
--)

--(Tinh tong theo doi tuong
SELECT  FK_GLAccountID ,
        SUM(DK_No0) AS DK_No0 ,
        SUM(DK_Co0) AS DK_Co0 ,
        SUM(PS_no0) AS PS_NO0 ,
        SUM(PS_co0) AS PS_Co0 ,
        CAST (0 AS FLOAT) AS Dk_No ,
        CAST (0 AS FLOAT) AS Dk_Co ,
        SUM(PS_no) AS PS_NO ,
        SUM(PS_co) AS PS_Co ,
        CAST (0 AS FLOAT) AS ck_No ,
        CAST (0 AS FLOAT) AS Ck_Co ,
        SUM(DK_No0_NT) AS DK_No0_NT ,
        SUM(DK_Co0_NT) AS DK_Co0_NT ,
        SUM(PS_no0_NT) AS PS_NO0_NT ,
        SUM(PS_co0_NT) AS PS_Co0_NT ,
        CAST (0 AS FLOAT) AS Dk_No_NT ,
        CAST (0 AS FLOAT) AS Dk_Co_NT ,
        SUM(PS_no_NT) AS PS_NO_NT ,
        SUM(PS_co_NT) AS PS_Co_NT ,
        CAST (0 AS FLOAT) AS ck_No_NT ,
        CAST (0 AS FLOAT) AS Ck_Co_NT ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID
INTO    #tKQ
FROM    #tData a
        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
GROUP BY FK_GLAccountID ,
        FK_ARCustomerID ,
        FK_APSupplierID ,
        FK_HREmployeeID ,
        FK_ICProductID ,
        FK_FAAssetID ,
        FK_GECurrencyID
--)


--(Tinh lai so du dau nam va dau ky chi tiet dau nam tai chinh
UPDATE  #tKQ
SET     dk_no0 = dk_no0 - dk_co0 ,
        dk_co0 = 0
WHERE   dk_co0 <> 0
        AND dk_no0 >= dk_co0

UPDATE  #tKQ
SET     dk_no0_NT = dk_no0_NT - dk_co0_NT ,
        dk_co0_NT = 0
WHERE   dk_co0_NT <> 0
        AND dk_no0_NT >= dk_co0_NT

UPDATE  #tKQ
SET     dk_co0 = dk_co0 - dk_no0 ,
        dk_no0 = 0
WHERE   dk_no0 <> 0
        AND dk_co0 >= dk_no0

UPDATE  #tKQ
SET     dk_co0_NT = dk_co0_NT - dk_no0_NT ,
        dk_no0_NT = 0
WHERE   dk_no0_NT <> 0
        AND dk_co0_NT >= dk_no0_NT
--)
--(TInh so du dau ky
UPDATE  #tKQ
SET     dk_no = dk_no0 - dk_co0 + ps_no0 - ps_co0

UPDATE  #tKQ
SET     dk_no_NT = dk_no0_NT - dk_co0_NT + ps_no0_NT - ps_co0_NT

UPDATE  #tKQ
SET     dk_co = ABS(dk_no) ,
        dk_no = 0
WHERE   dk_no < 0

UPDATE  #tKQ
SET     dk_co_NT = ABS(dk_no_NT) ,
        dk_no_NT = 0
WHERE   dk_no_NT < 0
--)
--(TInh so du cuoi ky
UPDATE  #tKQ
SET     ck_no = dk_no - dk_co + ps_no - ps_co

UPDATE  #tKQ
SET     ck_no_NT = dk_no_NT - dk_co_NT + ps_no_NT - ps_co_NT

UPDATE  #tKQ
SET     ck_co = ABS(ck_no) ,
        ck_no = 0
WHERE   ck_no < 0

UPDATE  #tKQ
SET     ck_co_NT = ABS(ck_no_NT) ,
        ck_no_NT = 0
WHERE   ck_no_NT < 0
--)


--(Tinh tong cac tk theo doi chi tiet doi tuong
SELECT  FK_GLAccountID ,
        SUM(DK_No0) AS DK_No0 ,
        SUM(DK_Co0) AS DK_Co0 ,
        SUM(PS_no0) AS PS_NO0 ,
        SUM(PS_co0) AS PS_Co0 ,
        SUM(DK_No) AS DK_No ,
        SUM(DK_Co) AS DK_Co ,
        SUM(PS_no) AS PS_NO ,
        SUM(PS_co) AS PS_Co ,
        SUM(ck_No) AS ck_No ,
        SUM(ck_Co) AS ck_Co ,
        SUM(DK_No0_NT) AS DK_No0_NT ,
        SUM(DK_Co0_NT) AS DK_Co0_NT ,
        SUM(PS_no0_NT) AS PS_NO0_NT ,
        SUM(PS_co0_NT) AS PS_Co0_NT ,
        SUM(DK_No_NT) AS DK_No_NT ,
        SUM(DK_Co_NT) AS DK_Co_NT ,
        SUM(PS_no_NT) AS PS_NO_NT ,
        SUM(PS_co_NT) AS PS_Co_NT ,
        SUM(ck_No_NT) AS ck_No_NT ,
        SUM(ck_Co_NT) AS ck_Co_NT ,
        0 AS FK_ARCustomerID ,
        0 AS FK_APSupplierID ,
        0 AS FK_HREmployeeID ,
        0 AS FK_ICProductID ,
        0 AS FK_FAAssetID ,
        0 AS FK_GECurrencyID
INTO    #tKQCN
FROM    #tKQ a
        INNER JOIN #tGLAccountsNC b ON a.FK_GLAccountID = b.GLAccountID 
--WHERE b.GLAccountBalanceCombo = 'NC' --FK_ARCustomerID + FK_APSupplierID + FK_HREmployeeID > 0
GROUP BY FK_GLAccountID

--)
--(Xoa du lieu ko phat sinh
IF @bDelEmptyData = 1 
    DELETE  FROM #tKQ
    WHERE   dk_no = 0
            AND dk_co = 0
            AND ps_no = 0
            AND ps_co = 0
            AND ck_no = 0
            AND ck_co = 0
            AND dk_no_nt = 0
            AND dk_co_nt = 0
            AND ps_no_nt = 0
            AND ps_co_nt = 0
            AND ck_no_nt = 0
            AND ck_co_nt = 0
--)
--(CHi tiet doi tuong
SELECT  *
INTO    #tKQCTCN
FROM    #tKQ a
        INNER JOIN #tGLAccountsNC b ON a.FK_GLAccountID = b.GLAccountID
WHERE   @bViewObjects = 1
--)
		
DELETE  FROM #tKQ
WHERE   FK_GLAccountID IN ( SELECT  GLAccountID
                            FROM    #tGLAccountsNC )

INSERT  INTO #tKQ
        SELECT  *
        FROM    #tKQCN

--(Tinh cac toai khoan cha

DECLARE @iLevel AS INT
SELECT  @iLevel = MAX(GLAccountLevel)
FROM    #tGLAccounts a
        INNER JOIN #tKQ b ON a.GLACCountID = b.FK_GLAccountID

WHILE @iLevel > 1 
    BEGIN

        SELECT  c.GLAccountID ,
                SUM(DK_No0) AS DK_No0 ,
                SUM(DK_Co0) AS DK_Co0 ,
                SUM(PS_NO0) AS PS_NO0 ,
                SUM(PS_Co0) AS PS_Co0 ,
                SUM(DK_No) AS DK_No ,
                SUM(DK_Co) AS DK_Co ,
                SUM(PS_NO) AS PS_NO ,
                SUM(PS_Co) AS PS_Co ,
                SUM(CK_No) AS CK_No ,
                SUM(CK_Co) AS CK_Co ,
                SUM(DK_No0_NT) AS DK_No0_NT ,
                SUM(DK_Co0_NT) AS DK_Co0_NT ,
                SUM(PS_NO0_NT) AS PS_NO0_NT ,
                SUM(PS_Co0_NT) AS PS_Co0_NT ,
                SUM(DK_No_NT) AS DK_No_NT ,
                SUM(DK_Co_NT) AS DK_Co_NT ,
                SUM(PS_NO_NT) AS PS_NO_NT ,
                SUM(PS_Co_NT) AS PS_Co_NT ,
                SUM(CK_No_NT) AS CK_No_NT ,
                SUM(CK_Co_NT) AS CK_Co_NT ,
                0 AS FK_ARCustomerID ,
                0 AS FK_APSupplierID ,
                0 AS FK_HREmployeeID ,
                0 AS FK_ICProductID ,
                0 AS FK_FAAssetID ,
                0 AS FK_GECurrencyID
        INTO    #tAppend
        FROM    #tKQ a
                INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
                INNER JOIN #tGLAccounts c ON b.FK_GLAccountParentID = c.GLAccountID
        WHERE   b.GLAccountLevel = @iLevel
        GROUP BY c.GLAccountID

        IF @bKoButru = 0 
            BEGIN
                UPDATE  #tAppend
                SET     dk_no0 = dk_no0 - dk_co0 ,
                        dk_co0 = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_co0 <> 0
                        AND dk_no0 >= dk_co0

                UPDATE  #tAppend
                SET     dk_co0 = dk_co0 - dk_no0 ,
                        dk_no0 = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_no0 <> 0
                        AND dk_co0 >= dk_no0
		
                UPDATE  #tAppend
                SET     dk_no = dk_no - dk_co ,
                        dk_co = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_co <> 0
                        AND dk_no >= dk_co

                UPDATE  #tAppend
                SET     dk_co = dk_co - dk_no ,
                        dk_no = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_no <> 0
                        AND dk_co >= dk_no
--)

--(Tinh lai so du dau ky va cuoi ky chi tiet 

                UPDATE  #tAppend
                SET     ck_no = ck_no - ck_co ,
                        ck_co = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   ck_co <> 0
                        AND ck_no >= ck_co			                        

                UPDATE  #tAppend
                SET     ck_co = ck_co - ck_no ,
                        ck_no = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   ck_no <> 0
                        AND ck_co >= ck_no

--)		


--(NT
                UPDATE  #tAppend
                SET     dk_no0_NT = dk_no0_NT - dk_co0_NT ,
                        dk_co0_NT = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_co0_NT <> 0
                        AND dk_no0_NT >= dk_co0_NT

                UPDATE  #tAppend
                SET     dk_co0_NT = dk_co0_NT - dk_no0_NT ,
                        dk_no0_NT = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_no0_NT <> 0
                        AND dk_co0_NT >= dk_no0_NT

                UPDATE  #tAppend
                SET     dk_no_NT = dk_no_NT - dk_co_NT ,
                        dk_co_NT = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_co_NT <> 0
                        AND dk_no_NT >= dk_co_NT

                UPDATE  #tAppend
                SET     dk_co_NT = dk_co_NT - dk_no_NT ,
                        dk_no_NT = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   dk_no_NT <> 0
                        AND dk_co_NT >= dk_no_NT
--)

--(Tinh lai so du dau ky va cuoi ky chi tiet 

                UPDATE  #tAppend
                SET     ck_no_NT = ck_no_NT - ck_co_NT ,
                        ck_co_NT = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   ck_co_NT <> 0
                        AND ck_no_NT >= ck_co_NT

                UPDATE  #tAppend
                SET     ck_co_NT = ck_co_NT - ck_no_NT ,
                        ck_no_NT = 0
                FROM    #tAppend a
                        INNER JOIN #tGLAccountsNotNC b ON a.GLAccountID = b.GLAccountID
                WHERE   ck_no_NT <> 0
                        AND ck_co_NT >= ck_no_NT
--)		


            END
        INSERT  INTO #tKQ
                SELECT  *
                FROM    #tAppend
        DROP TABLE #tAppend
        SET @iLevel = @iLevel - 1			
    END

--(TInh tong cong
SELECT  0 AS GLAccountID ,
        'Total' AS GLAccountNo ,
        'Total' AS GLAccountName ,
        0 AS GLAccountLevel ,
        SUM(DK_No0) AS DK_No0 ,
        SUM(DK_Co0) AS DK_Co0 ,
        SUM(PS_NO0) AS PS_NO0 ,
        SUM(PS_Co0) AS PS_Co0 ,
        SUM(DK_No) AS DK_No ,
        SUM(DK_Co) AS DK_Co ,
        SUM(PS_NO) AS PS_NO ,
        SUM(PS_Co) AS PS_Co ,
        SUM(CK_No) AS CK_No ,
        SUM(CK_Co) AS CK_Co ,
        SUM(DK_No0_NT) AS DK_No0_NT ,
        SUM(DK_Co0_NT) AS DK_Co0_NT ,
        SUM(PS_NO0_NT) AS PS_NO0_NT ,
        SUM(PS_Co0_NT) AS PS_Co0_NT ,
        SUM(DK_No_NT) AS DK_No_NT ,
        SUM(DK_Co_NT) AS DK_Co_NT ,
        SUM(PS_NO_NT) AS PS_NO_NT ,
        SUM(PS_Co_NT) AS PS_Co_NT ,
        SUM(CK_No_NT) AS CK_No_NT ,
        SUM(CK_Co_NT) AS CK_Co_NT ,
        0 AS FK_ARCustomerID ,
        0 AS FK_APSupplierID ,
        0 AS FK_HREmployeeID ,
        0 AS FK_ICProductID ,
        0 AS FK_FAAssetID ,
        0 AS FK_GECurrencyID
INTO    #tTotal
FROM    #tKQ a
        INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
WHERE   b.GLAccountLevel = 1
--)

--(Ket qua cuoi cung
SELECT  *,
        N'B. Tài khoản ngoài bảng' as GLTrialBalanceAccountType
FROM    ( SELECT    b.GLAccountID AS FK_GLAccountID ,
                    b.GLAccountNo ,
                    b.GLAccountName ,
                    b.GLAccountLevel ,
                    DK_No0 AS GLAccountBeginFYDebitAmt ,
                    DK_Co0 AS GLAccountBeginFYCreditAmt ,
                    PS_NO0 AS GLAccountAccumDebitAmt ,
                    PS_Co0 AS GLAccountAccumCreditAmt ,
                    DK_No AS GLAccountBeginDebitAmt ,
                    DK_Co AS GLAccountBeginCreditAmt ,
                    PS_NO AS GLAccountDebitAmt ,
                    PS_Co AS GLAccountCreditAmt ,
                    CK_No AS GLAccountEndDebitAmt ,
                    CK_Co AS GLAccountEndCreditAmt ,
                    DK_No0_NT AS GLAccountBeginFYDebitFAmt ,
                    DK_Co0_NT AS GLAccountBeginFYCreditFAmt ,
                    PS_NO0_NT AS GLAccountAccumDebitFAmt ,
                    PS_Co0_NT AS GLAccountAccumCreditFAmt ,
                    DK_No_NT AS GLAccountBeginDebitFAmt ,
                    DK_Co_NT AS GLAccountBeginCreditFAmt ,
                    PS_NO_NT AS GLAccountDebitFAmt ,
                    PS_Co_NT AS GLAccountCreditFAmt ,
                    CK_No_NT AS GLAccountEndDebitFAmt ,
                    CK_Co_NT AS GLAccountEndCreditFAmt ,
                    FK_ARCustomerID ,
                    FK_APSupplierID ,
                    FK_HREmployeeID ,
                    FK_ICProductID ,
                    FK_FAAssetID ,
                    FK_GECurrencyID
          FROM      #tKQ a
                    INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = GLAccountID
          WHERE     ( @iViewLevel = 0
                      OR b.GLAccountLevel <= @iViewLevel
                    )
          UNION ALL 
--(CHi tiet doi tuong
          SELECT    b.GLAccountID ,
                    b.GLAccountNo + '.'
                    + CASE WHEN a.FK_ARCustomerID > 0
                                AND c.AAStatus = 'Alive' THEN c.ARCustomerNo
                           WHEN a.FK_APSupplierID > 0
                                AND d.AAStatus = 'Alive' THEN d.APSupplierNo
                           WHEN a.FK_HREmployeeID > 0
                                AND e.AAStatus = 'Alive' THEN e.HREmployeeNo
                           WHEN a.FK_ICProductID > 0
                                AND f.AAStatus = 'Alive' THEN f.ICProductNo
                           WHEN a.FK_FAAssetID > 0
                                AND g.AAStatus = 'Alive' THEN g.FAAssetNo
                           WHEN a.FK_GECurrencyID > 0
                                AND h.AAStatus = 'Alive' THEN h.GECurrencyNo
                           ELSE '<NULL>'
                      END AS GLAccountNo ,
                    CASE WHEN a.FK_ARCustomerID > 0 THEN c.ARCustomerName
                         WHEN a.FK_APSupplierID > 0 THEN d.APSupplierName
                         WHEN a.FK_HREmployeeID > 0 THEN e.HREmployeeName
                         WHEN a.FK_ICProductID > 0 THEN f.ICProductName
                         WHEN a.FK_FAAssetID > 0 THEN g.FAAssetName
                         WHEN a.FK_GECurrencyID > 0 THEN h.GECurrencyName
                         ELSE '<NULL>'
                    END AS GLAccountName ,
                    b.GLAccountLevel + 1 ,
                    DK_No0 AS GLAccountBeginFYDebitAmt ,
                    DK_Co0 AS GLAccountBeginFYCreditAmt ,
                    PS_NO0 AS GLAccountAccumDebitAmt ,
                    PS_Co0 AS GLAccountAccumCreditAmt ,
                    DK_No AS GLAccountBeginDebitAmt ,
                    DK_Co AS GLAccountBeginCreditAmt ,
                    PS_NO AS GLAccountDebitAmt ,
                    PS_Co AS GLAccountCreditAmt ,
                    CK_No AS GLAccountEndDebitAmt ,
                    CK_Co AS GLAccountEndCreditAmt ,
                    DK_No0_NT AS GLAccountBeginFYDebitFAmt ,
                    DK_Co0_NT AS GLAccountBeginFYCreditFAmt ,
                    PS_NO0_NT AS GLAccountAccumDebitFAmt ,
                    PS_Co0_NT AS GLAccountAccumCreditFAmt ,
                    DK_No_NT AS GLAccountBeginDebitFAmt ,
                    DK_Co_NT AS GLAccountBeginCreditFAmt ,
                    PS_NO_NT AS GLAccountDebitFAmt ,
                    PS_Co_NT AS GLAccountCreditFAmt ,
                    CK_No_NT AS GLAccountEndDebitFAmt ,
                    CK_Co_NT AS GLAccountEndCreditFAmt ,
                    a.FK_ARCustomerID ,
                    a.FK_APSupplierID ,
                    a.FK_HREmployeeID ,
                    a.FK_ICProductID ,
                    a.FK_FAAssetID ,
                    a.FK_GECurrencyID
          FROM      #tKQCTCN a
                    INNER JOIN #tGLAccounts b ON a.FK_GLAccountID = b.GLAccountID
                    LEFT JOIN dbo.ARCustomers c ON a.FK_ARCustomerID = c.ARCustomerID
                    LEFT JOIN dbo.APSuppliers d ON a.FK_APSupplierID = d.APSupplierID
                    LEFT JOIN dbo.HREmployees e ON a.FK_HREmployeeID = e.HREmployeeID
                    LEFT JOIN dbo.ICProducts f ON a.FK_ICProductID = f.ICProductID
                    LEFT JOIN dbo.FAAssets g ON a.FK_FAAssetID = g.FAAssetID
                    LEFT JOIN dbo.GECurrencys h ON a.FK_GECurrencyID = h.GECurrencyID 
--)
--UNION ALL SELECT * FROM #tToTal
--(TKNB

--)
          
        ) AS a
ORDER BY GLAccountNo

DROP TABLE #tGLAccountsNC
DROP TABLE #tGLAccountsNotNC
DROP TABLE #tGLAccounts
DROP TABLE #tSDDN
DROP TABLE #tData
DROP TABLE #tKQ
DROP TABLE #tKQCN
DROP TABLE #tKQCTCN
DROP TABLE #tTotal
", strAccountNo, dtLastStartFiscalYear.ToString("yyyyMMdd"), dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"), iLevel
 , Convert.ToSByte(bKoButruSDTH), Convert.ToSByte(bDetailObj), Convert.ToSByte(bDelEmptyData)
 ,iBranchID, iCurrencyID);
            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            ds = GetDataSet(strQuery);            
            return ds;
        }
        //)
        public DataSet CalcTrialBalanceOld(String strAccountNo, DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, int iLevel)
        {
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            string str1 = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String str2 = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeforeStart = String.Format(@"({0} AND {1})", str1, str2);
            String strStartFiscalYear = DALUtil.GennerateCondition("GLJournalDate", CompareType.Equal, dtLastStartFiscalYear);

            String strDeleteTempTable = String.Format(
                @"
                    -----------------------------------------------------------
                        --Delete cac table tam cho viec tinh cac TK Luong tinh
                        -----------------------------------------------------------

                        IF OBJECT_ID('TrialBalance') IS NOT NULL
                        BEGIN
                        DROP TABLE TrialBalance
                        END
	
                        IF OBJECT_ID('Objects') IS NOT NULL
                        BEGIN
                        DROP TABLE Objects
                        END

                        IF OBJECT_ID('Account') IS NOT NULL
                        BEGIN
                        DROP TABLE Account
                        END


                        IF OBJECT_ID('Journals') IS NOT NULL
                        BEGIN
                        DROP TABLE Journals
                        END

                        IF OBJECT_ID('ObjectJournals') IS NOT NULL
                        BEGIN
                        DROP TABLE ObjectJournals
                        END
                        IF OBJECT_ID('CongNo') IS NOT NULL
                        BEGIN
                        DROP TABLE CongNo
                        END

                        IF OBJECT_ID('CongNoChiTiet') IS NOT NULL
                        BEGIN
                        DROP TABLE CongNoChiTiet
                        END
	
                        IF OBJECT_ID('DATA_LT4') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT4
                        END
	
                        IF OBJECT_ID('DATA_LT3') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT3
                        END
	
                        IF OBJECT_ID('Data_LT2') IS NOT NULL
                        BEGIN
                        DROP TABLE Data_LT2
                        END
	
                        IF OBJECT_ID('DATA_LT1') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT1
                        END
	
                        IF OBJECT_ID('DATA_LT0') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT0
                        END
	
                        IF OBJECT_ID('DATA_LT') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT
                        END
	
                        IF OBJECT_ID('BANGCANDOI_LUONGTINH') IS NOT NULL
                        BEGIN
                        DROP TABLE BANGCANDOI_LUONGTINH
                        END
	
                        -----------------------------------------------------------
                        --Delete cac table tam cho viec tinh cac TK No, Co
                        -----------------------------------------------------------

                        IF OBJECT_ID('Data4') IS NOT NULL
                        BEGIN
                        DROP TABLE Data4
                        END

                        IF OBJECT_ID('Data3') IS NOT NULL
                        BEGIN
                        DROP TABLE Data3
                        END

                        IF OBJECT_ID('Data2') IS NOT NULL
                        BEGIN
                        DROP TABLE Data2
                        END

                        IF OBJECT_ID('Data1') IS NOT NULL
                        BEGIN
                        DROP TABLE Data1
                        END

                        IF OBJECT_ID('Data0') IS NOT NULL
                        BEGIN
                        DROP TABLE Data0
                        END

                        IF OBJECT_ID('Data') IS NOT NULL
                        BEGIN
                        DROP TABLE Data
                        END

                        IF OBJECT_ID('BANGCANDOI') IS NOT NULL
                        BEGIN
                        DROP TABLE BANGCANDOI
                        END

                ");
            String strQuery =
               String.Format(@"
                        -----------------------------------------------------------
                        --Lấy về các Đối tượng
                        -----------------------------------------------------------

                        SELECT * INTO Objects
                        FROM 
                        (select 'Cust' + CAST(ARCustomerID AS nvarchar(50)) AS ObjectID,
                        ARCustomerNo as ObjectNo,
                        ARCustomerName as ObjectName
                        FROM ARCustomers 
                        WHERE AAStatus = 'Alive' 

                        UNION ALL 

                        select 'Sup' + CAST(APSUpplierID AS nvarchar(50)) AS ObjectID,
                        APSUpplierNo as ObjectNo,
                        APSupplierName as ObjectName
                        FROM APSuppliers 
                        WHERE AAStatus = 'Alive' 

                        UNION ALL

                        select 'Emp' + CAST(HREmployeeID AS nvarchar(50)) AS ObjectID,
                        HREmployeeNo as ObjectNo,
                        HREmployeeName as ObjectName
                        FROM HREmployees 
                        WHERE AAStatus = 'Alive'

                        UNION ALL

                        SELECT 'Unknow' AS ObjectID,
                        'Unknow' AS ObjectNo,
                        N'Không rõ đối tượng' AS ObjectName
                        ) AS TEMP
	
	
                        -----------------------------------------------------------
                        --Lấy về các Tài khoản con lưỡng tính
                        -----------------------------------------------------------
                        SELECT * INTO Account 
                        FROM (
                        SELECT 
                        GLAccountNo AS AccountNo,
                        GLAccountName AS AccountName,
                        FK_GLAccountParentID AS AccountParentID,
                        GLAccountLevel AS GLAccountLevel
                        FROM GLAccounts 
                        WHERE AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccountBalanceCombo = 'NC'
                        AND GLAccountID NOT IN(SELECT FK_GLAccountParentID FROM GLAccounts WHERE AAStatus = 'Alive')
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về Journals và các đối tượng
                        -----------------------------------------------------------

                        SELECT * INTO Journals
                        FROM
                        (
                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE ObjectNo = 'Unknow'
                        AND FK_APSupplierID = 0
                        AND FK_ARCustomerID = 0
                        AND FK_HREmployeeID = 0
                        AND {0} --AllRange

                        ) AS Temp
        
                        -----------------------------------------------------------
                        --Lấy về Dữ liệu Đầu kỳ , trong kỳ
                        -----------------------------------------------------------                                
                        SELECT * INTO ObjectJournals
                        FROM
                        (
                        -- No dau ky
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccounts.GLAccountID, GLAccountNo, GLAccountName,
                        SUM(Journals.GLJournalAmt) AS BeginDebitAmt,
                        SUM(Journals.GLJournalFAmt) AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                        )
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        --Co dau ky
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        SUM(Journals.GLJournalAmt) AS BeginCreditAmt,
                        SUM(Journals.GLJournalFAmt) AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                            )
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        -- No phat sinh
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        SUM(Journals.GLJournalAmt) AS ArisingDebitAmt,
                        SUM(Journals.GLJournalFAmt) AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND {2} -- InRange
                        AND GLJournalPeriod <> 0
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        -- Co phat sinh
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        SUM(Journals.GLJournalAmt) AS ArisingCreditAmt,
                        SUM(Journals.GLJournalFAmt) AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND {2} -- InRange
                        AND GLJournalPeriod <> 0
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName


                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về Journals và các đối tượng
                        -----------------------------------------------------------
                        SELECT 
                        GLAccountID, GLAccountNo, ObjectID, ObjectNo, ObjectName,
                        SUM(BeginDebitAmt) - SUM(BeginCreditAmt) AS BeginAmt,
                        SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) AS BeginFAmt,
                        SUM(ArisingDebitAmt) AS ArisingDebAmt,
                        SUM(ArisingDebitFAmt) AS ArisingDebFAmt,
                        SUM(ArisingCreditAmt) AS ArisingCreAmt,
                        SUM(ArisingCreditFAmt) AS ArisingCreFAmt,
                        SUM(BeginDebitAmt) - SUM(BeginCreditAmt) + SUM(ArisingDebitAmt) - SUM(ArisingCreditAmt) AS EndAmt,
                        SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt)  + SUM(ArisingDebitFAmt) - SUM(ArisingCreditFAmt) AS EndFAmt

                        INTO CongNo
                        FROM ObjectJournals
                        Group By GLAccountID, GLAccountNo, ObjectID ,ObjectNo, ObjectName
	
                        -----------------------------------------------------------
                        --Tổng hợp công nợ theo đối tượng
                        -----------------------------------------------------------                                  
                        SELECT  
                        CongNo.ObjectID AS ObjectIDRef,
                        CongNo.GLAccountID AS FK_GLAccountID,
                        Account.AccountParentID AS AccountParentID,
                        CAST('2012-12-1 00:00:00.000' AS DateTime) AS GLTrialBalanceFromDate,
                        CAST('2012-12-31 00:00:00.000' AS DateTime) AS GLTrialBalanceToDate,
                        100002 AS FK_GECurrencyID,
                        Account.AccountNo AS GLAccountNo,
                        Account.AccountName AS GLAccountName,
                        Account.GLAccountLevel,
                        ObjectNo, ObjectName,
                        CASE WHEN SUM(BeginAmt) >= 0 then SUM(BeginAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                        CASE WHEN SUM(BeginFAmt) >= 0 then SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                        CASE WHEN SUM(BeginAmt) < 0 then -SUM(BeginAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                        CASE WHEN SUM(BeginFAmt) < 0 then -SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                        SUM(ArisingDebAmt) AS GLAccountDebitAmt,
                        SUM(ArisingDebFAmt) AS GLAccountDebitFAmt,
                        SUM(ArisingCreAmt) AS GLAccountCreditAmt,
                        SUM(ArisingCreFAmt) AS GLAccountCreditFAmt,
                        CASE WHEN SUM(EndAmt) >= 0 then SUM(EndAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                        CASE WHEN SUM(EndFAmt) >= 0 then SUM(EndFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                        CASE WHEN SUM(EndAmt) < 0 then -SUM(EndAmt) ELSE 0 END AS GLAccountEndCreditAmt,
                        CASE WHEN SUM(EndFAmt) < 0 then -SUM(EndFAmt) ELSE 0 END AS GLAccountEndCreditFAmt
                        INTO CongNoChiTiet
                        FROM CongNo,Account
                        WHERE GLAccountNo like Account.AccountNo + '%'
                        GROUP BY CongNo.ObjectID, CongNo.GLAccountID, Account.AccountNo,
                        Account.AccountName, ObjectNo, ObjectName,Account.AccountParentID,Account.GLAccountLevel
   

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất
                        ----------------------------------------------------------- 
                        SELECT 
                        FK_GLAccountID AS GLAccountID,
                        CongNoChitiet.AccountParentID AS AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT4
                        FROM CongNoChitiet
                        Group By
                        FK_GLAccountID,
                        CongNoChitiet.AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất -1
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT3
                        FROM DATA_LT4, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND DATA_LT4.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 2
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO Data_LT2
                        FROM DATA_LT3, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND DATA_LT3.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 3
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT1
                        FROM Data_LT2, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data_LT2.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 4
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT0
                        FROM Data_LT1, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data_LT1.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Tổng hợp view theo TK 
                        ----------------------------------------------------------- 
                        SELECT * INTO DATA_LT
                        FROM
                        (
                        SELECT * FROM Data_LT4
                        UNION ALL
                        SELECT * FROM Data_LT3
                        UNION ALL
                        SELECT * FROM Data_LT2
                        UNION ALL
                        SELECT * FROM Data_LT1
                        UNION ALL
                        SELECT * FROM Data_LT0
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về view 
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO BANGCANDOI_LUONGTINH
                        FROM DATA_LT
                        WHERE
                        GLAccountLevel <= {4}
                        GROUP BY GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất
                        -----------------------------------------------------------

                        SELECT * INTO Data4
                        FROM
                        (
                        -- No Dau ky
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLJournals.GLJournalAmt) AS BeginDebitAmt,
                        SUM(GLJournals.GLJournalFAmt) AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                        )
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL

                        -- Co Dau ky
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        SUM(GLJournals.GLJournalAmt) AS BeginCreditAmt,
                        SUM(GLJournals.GLJournalFAmt) AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                            )
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL

                        -- No Phat sinh
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        SUM(GLJournalAmt) AS DebitAmt,
                        SUM(GLJournalFAmt) AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND {2}
                        AND GLJournalPeriod <> 0
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL 

                        -- Co phat sinh
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        SUM(GLJournalAmt)AS CreditAmt,
                        SUM(GLJournalFAmt) AS CreditFAmt

                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND {2}
                        AND GLJournalPeriod <> 0
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 1
                        -----------------------------------------------------------
                        SELECT * INTO DATA3
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data4, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data4.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 2
                        -----------------------------------------------------------
                        SELECT * INTO DATA2
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data3, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data3.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 3
                        -----------------------------------------------------------
                        SELECT * INTO DATA1
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data2, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data2.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 4
                        -----------------------------------------------------------
                        SELECT * INTO DATA0
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data1, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data1.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy View tổng hợp
                        -----------------------------------------------------------
                        SELECT * INTO Data
                        FROM
                        (
                        SELECT * FROM Data4
                        UNION ALL
                        SELECT * FROM Data3
                        UNION ALL
                        SELECT * FROM Data2
                        UNION ALL
                        SELECT * FROM Data1
                        UNION ALL
                        SELECT * FROM Data0
                        ) AS Temp

                        -----------------------------------------------------------
                        --Tính toán cân đối
                        -----------------------------------------------------------
                        SELECT 
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        CASE WHEN SUM(BeginDebitAmt) - SUM(BeginCreditAmt) > 0 THEN SUM(BeginDebitAmt) - SUM(BeginCreditAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                        CASE WHEN SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) > 0 then SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                        CASE WHEN SUM(BeginCreditAmt) - SUM(BeginDebitAmt) > 0 then SUM(BeginCreditAmt) - SUM(BeginDebitAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                        CASE WHEN SUM(BeginCreditFAmt) - SUM(BeginDebitFAmt) > 0 then SUM(BeginCreditFAmt) - SUM(BeginDebitFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                        SUM(DebitAmt) AS GLAccountDebitAmt,
                        SUM(DebitFAmt) AS GLAccountDebitFAmt,
                        SUM(CreditAmt) AS GLAccountCreditAmt,
                        SUM(CreditFAmt) AS GLAccountCreditFAmt,
                        CASE WHEN (SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt)) > 0 
					                        THEN SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                        CASE WHEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) > 0 
					                        THEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                        CASE WHEN SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt) < 0 
					                        THEN -SUM(BeginDebitAmt) - SUM(DebitAmt) + SUM(BeginCreditAmt)+ SUM(CreditAmt) ELSE 0 END AS  GLAccountEndCreditAmt,
                        CASE WHEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) < 0 
					                        THEN -SUM(BeginDebitFAmt) - SUM(DebitFAmt) + SUM(BeginCreditFAmt)+ SUM(CreditFAmt) ELSE 0 END AS GLAccountEndCreditFAmt

                        INTO BANGCANDOI
                        FROM DATA
                        WHERE 
                        GLAccountLevel <= {4}
                        GROUP BY
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel


                        -----------------------------------------------------------
                        --Tạo bản cân đối
                        -----------------------------------------------------------
                        SELECT 
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,

                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt

                        INTO TrialBalance
                        FROM
                        (
                        SELECT * FROM BANGCANDOI
                        UNION ALl
                        SELECT * FROM BANGCANDOI_LUONGTINH
                        ) AS Temp                        
                        GROUP BY 
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel

                        -----------------------------------------------------------
                        --View bản cân đối
                        -----------------------------------------------------------
                        SELECT * 
                        FROM TrialBalance
                        ORDER BY GLAccountNo
	
                ", strAllRange, strBeforeStart, strInRange, strStartFiscalYear, iLevel, strAccountNo);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            using (TransactionScope tranScope = new TransactionScope())
            {
                GetDataSet(strDeleteTempTable);
                GetDataSet(strDeleteTempTable);
                GetDataSet(strDeleteTempTable);
                ds = GetDataSet(strQuery);
                GetDataSet(strDeleteTempTable);
            }

            return ds;

        }

        public DataSet CalcTrialBalance(String strAccountNo, DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, int iLevel, bool isExcept911)
        {
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            string str1 = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String str2 = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeforeStart = String.Format(@"({0} AND {1})", str1, str2);
            String strStartFiscalYear = DALUtil.GennerateCondition("GLJournalDate", CompareType.Equal, dtLastStartFiscalYear);

            String strDebitExcept911 = String.Empty;
            String strCreditExcept911 = String.Empty;
            if (isExcept911 == true)
            {
                strDebitExcept911 = String.Format(@" AND FK_GLDebitAccountID NOT IN (SELECT GLAccountID FROM Account911)");
                strCreditExcept911 = String.Format(@" AND FK_GLCreditAccountID NOT IN (SELECT GLAccountID FROM Account911)");
            }

            String strDeleteTempTable = String.Format(
                @"
                    -----------------------------------------------------------
                        --Delete cac table tam cho viec tinh cac TK Luong tinh
                        -----------------------------------------------------------

                        IF OBJECT_ID('TrialBalance') IS NOT NULL
                        BEGIN
                        DROP TABLE TrialBalance
                        END
	
                        IF OBJECT_ID('Objects') IS NOT NULL
                        BEGIN
                        DROP TABLE Objects
                        END

                        IF OBJECT_ID('Account') IS NOT NULL
                        BEGIN
                        DROP TABLE Account
                        END

                        IF OBJECT_ID('Account911') IS NOT NULL
                        BEGIN
                        DROP TABLE Account911
                        END


                        IF OBJECT_ID('Journals') IS NOT NULL
                        BEGIN
                        DROP TABLE Journals
                        END

                        IF OBJECT_ID('ObjectJournals') IS NOT NULL
                        BEGIN
                        DROP TABLE ObjectJournals
                        END
                        IF OBJECT_ID('CongNo') IS NOT NULL
                        BEGIN
                        DROP TABLE CongNo
                        END

                        IF OBJECT_ID('CongNoChiTiet') IS NOT NULL
                        BEGIN
                        DROP TABLE CongNoChiTiet
                        END
	
                        IF OBJECT_ID('DATA_LT4') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT4
                        END
	
                        IF OBJECT_ID('DATA_LT3') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT3
                        END
	
                        IF OBJECT_ID('Data_LT2') IS NOT NULL
                        BEGIN
                        DROP TABLE Data_LT2
                        END
	
                        IF OBJECT_ID('DATA_LT1') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT1
                        END
	
                        IF OBJECT_ID('DATA_LT0') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT0
                        END
	
                        IF OBJECT_ID('DATA_LT') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT
                        END
	
                        IF OBJECT_ID('BANGCANDOI_LUONGTINH') IS NOT NULL
                        BEGIN
                        DROP TABLE BANGCANDOI_LUONGTINH
                        END
	
                        -----------------------------------------------------------
                        --Delete cac table tam cho viec tinh cac TK No, Co
                        -----------------------------------------------------------

                        IF OBJECT_ID('Data4') IS NOT NULL
                        BEGIN
                        DROP TABLE Data4
                        END

                        IF OBJECT_ID('Data3') IS NOT NULL
                        BEGIN
                        DROP TABLE Data3
                        END

                        IF OBJECT_ID('Data2') IS NOT NULL
                        BEGIN
                        DROP TABLE Data2
                        END

                        IF OBJECT_ID('Data1') IS NOT NULL
                        BEGIN
                        DROP TABLE Data1
                        END

                        IF OBJECT_ID('Data0') IS NOT NULL
                        BEGIN
                        DROP TABLE Data0
                        END

                        IF OBJECT_ID('Data') IS NOT NULL
                        BEGIN
                        DROP TABLE Data
                        END

                        IF OBJECT_ID('BANGCANDOI') IS NOT NULL
                        BEGIN
                        DROP TABLE BANGCANDOI
                        END

                ");
            String strQuery =
               String.Format(@"
                        -----------------------------------------------------------
                        --Lấy về các Đối tượng
                        -----------------------------------------------------------

                        SELECT * INTO Objects
                        FROM 
                        (select 'Cust' + CAST(ARCustomerID AS nvarchar(50)) AS ObjectID,
                        ARCustomerNo as ObjectNo,
                        ARCustomerName as ObjectName
                        FROM ARCustomers 
                        WHERE AAStatus = 'Alive' 

                        UNION ALL 

                        select 'Sup' + CAST(APSUpplierID AS nvarchar(50)) AS ObjectID,
                        APSUpplierNo as ObjectNo,
                        APSupplierName as ObjectName
                        FROM APSuppliers 
                        WHERE AAStatus = 'Alive' 

                        UNION ALL

                        select 'Emp' + CAST(HREmployeeID AS nvarchar(50)) AS ObjectID,
                        HREmployeeNo as ObjectNo,
                        HREmployeeName as ObjectName
                        FROM HREmployees 
                        WHERE AAStatus = 'Alive'

                        UNION ALL

                        SELECT 'Unknow' AS ObjectID,
                        'Unknow' AS ObjectNo,
                        N'Không rõ đối tượng' AS ObjectName
                        ) AS TEMP
	
                        
                        -----------------------------------------------------------
                        --Lấy về các Tài khoản 911
                        -----------------------------------------------------------
                        SELECT * INTO Account911
                        FROM (
                        SELECT 
                        GLAccountID AS GLAccountID
                        FROM GLAccounts 
                        WHERE AAStatus = 'Alive'
                        AND GLAccountNo like '911%'
                        ) AS Temp	

                        -----------------------------------------------------------
                        --Lấy về các Tài khoản con lưỡng tính
                        -----------------------------------------------------------
                        SELECT * INTO Account 
                        FROM (
                        SELECT 
                        GLAccountNo AS AccountNo,
                        GLAccountName AS AccountName,
                        FK_GLAccountParentID AS AccountParentID,
                        GLAccountLevel AS GLAccountLevel
                        FROM GLAccounts 
                        WHERE AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccountBalanceCombo = 'NC'
                        AND GLAccountID NOT IN(SELECT FK_GLAccountParentID FROM GLAccounts WHERE AAStatus = 'Alive')
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về Journals và các đối tượng
                        -----------------------------------------------------------

                        SELECT * INTO Journals
                        FROM
                        (
                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE ObjectNo = 'Unknow'
                        AND FK_APSupplierID = 0
                        AND FK_ARCustomerID = 0
                        AND FK_HREmployeeID = 0
                        AND {0} --AllRange

                        ) AS Temp
        
                        -----------------------------------------------------------
                        --Lấy về Dữ liệu Đầu kỳ , trong kỳ
                        -----------------------------------------------------------                                
                        SELECT * INTO ObjectJournals
                        FROM
                        (
                        -- No dau ky
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccounts.GLAccountID, GLAccountNo, GLAccountName,
                        SUM(Journals.GLJournalAmt) AS BeginDebitAmt,
                        SUM(Journals.GLJournalFAmt) AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        {7}-- Credit Except 911
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                        )
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        --Co dau ky
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        SUM(Journals.GLJournalAmt) AS BeginCreditAmt,
                        SUM(Journals.GLJournalFAmt) AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        {6} --Debit Except 911
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                            )
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        -- No phat sinh
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        SUM(Journals.GLJournalAmt) AS ArisingDebitAmt,
                        SUM(Journals.GLJournalFAmt) AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        {7}-- Credit Except 911
                        AND {2} -- InRange
                        AND GLJournalPeriod <> 0
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        -- Co phat sinh
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        SUM(Journals.GLJournalAmt) AS ArisingCreditAmt,
                        SUM(Journals.GLJournalFAmt) AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        {6}-- Debit Except 911
                        AND {2} -- InRange
                        AND GLJournalPeriod <> 0
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName


                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về Journals và các đối tượng
                        -----------------------------------------------------------
                        SELECT 
                        GLAccountID, GLAccountNo, ObjectID, ObjectNo, ObjectName,
                        SUM(BeginDebitAmt) - SUM(BeginCreditAmt) AS BeginAmt,
                        SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) AS BeginFAmt,
                        SUM(ArisingDebitAmt) AS ArisingDebAmt,
                        SUM(ArisingDebitFAmt) AS ArisingDebFAmt,
                        SUM(ArisingCreditAmt) AS ArisingCreAmt,
                        SUM(ArisingCreditFAmt) AS ArisingCreFAmt,
                        SUM(BeginDebitAmt) - SUM(BeginCreditAmt) + SUM(ArisingDebitAmt) - SUM(ArisingCreditAmt) AS EndAmt,
                        SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt)  + SUM(ArisingDebitFAmt) - SUM(ArisingCreditFAmt) AS EndFAmt

                        INTO CongNo
                        FROM ObjectJournals
                        Group By GLAccountID, GLAccountNo, ObjectID ,ObjectNo, ObjectName
	
                        -----------------------------------------------------------
                        --Tổng hợp công nợ theo đối tượng
                        -----------------------------------------------------------                                  
                        SELECT  
                        CongNo.ObjectID AS ObjectIDRef,
                        CongNo.GLAccountID AS FK_GLAccountID,
                        Account.AccountParentID AS AccountParentID,
                        CAST('2012-12-1 00:00:00.000' AS DateTime) AS GLTrialBalanceFromDate,
                        CAST('2012-12-31 00:00:00.000' AS DateTime) AS GLTrialBalanceToDate,
                        100002 AS FK_GECurrencyID,
                        Account.AccountNo AS GLAccountNo,
                        Account.AccountName AS GLAccountName,
                        Account.GLAccountLevel,
                        ObjectNo, ObjectName,
                        CASE WHEN SUM(BeginAmt) >= 0 then SUM(BeginAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                        CASE WHEN SUM(BeginFAmt) >= 0 then SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                        CASE WHEN SUM(BeginAmt) < 0 then -SUM(BeginAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                        CASE WHEN SUM(BeginFAmt) < 0 then -SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                        SUM(ArisingDebAmt) AS GLAccountDebitAmt,
                        SUM(ArisingDebFAmt) AS GLAccountDebitFAmt,
                        SUM(ArisingCreAmt) AS GLAccountCreditAmt,
                        SUM(ArisingCreFAmt) AS GLAccountCreditFAmt,
                        CASE WHEN SUM(EndAmt) >= 0 then SUM(EndAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                        CASE WHEN SUM(EndFAmt) >= 0 then SUM(EndFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                        CASE WHEN SUM(EndAmt) < 0 then -SUM(EndAmt) ELSE 0 END AS GLAccountEndCreditAmt,
                        CASE WHEN SUM(EndFAmt) < 0 then -SUM(EndFAmt) ELSE 0 END AS GLAccountEndCreditFAmt
                        INTO CongNoChiTiet
                        FROM CongNo,Account
                        WHERE GLAccountNo like Account.AccountNo + '%'
                        GROUP BY CongNo.ObjectID, CongNo.GLAccountID, Account.AccountNo,
                        Account.AccountName, ObjectNo, ObjectName,Account.AccountParentID,Account.GLAccountLevel
   

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất
                        ----------------------------------------------------------- 
                        SELECT 
                        FK_GLAccountID AS GLAccountID,
                        CongNoChitiet.AccountParentID AS AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT4
                        FROM CongNoChitiet
                        Group By
                        FK_GLAccountID,
                        CongNoChitiet.AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất -1
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT3
                        FROM DATA_LT4, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND DATA_LT4.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 2
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO Data_LT2
                        FROM DATA_LT3, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND DATA_LT3.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 3
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT1
                        FROM Data_LT2, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data_LT2.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 4
                        ----------------------------------------------------------- 
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT0
                        FROM Data_LT1, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data_LT1.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Tổng hợp view theo TK 
                        ----------------------------------------------------------- 
                        SELECT * INTO DATA_LT
                        FROM
                        (
                        SELECT * FROM Data_LT4
                        UNION ALL
                        SELECT * FROM Data_LT3
                        UNION ALL
                        SELECT * FROM Data_LT2
                        UNION ALL
                        SELECT * FROM Data_LT1
                        UNION ALL
                        SELECT * FROM Data_LT0
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về view 
                        ----------------------------------------------------------- 
                        SELECT
                        * 
                        INTO BANGCANDOI_LUONGTINH
                        FROM DATA_LT
                        WHERE
                        GLAccountLevel <= {4}


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất
                        -----------------------------------------------------------

                        SELECT * INTO Data4
                        FROM
                        (
                        -- No Dau ky
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLJournals.GLJournalAmt) AS BeginDebitAmt,
                        SUM(GLJournals.GLJournalFAmt) AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        {7}-- Credit Except 911
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                        )
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL

                        -- Co Dau ky
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        SUM(GLJournals.GLJournalAmt) AS BeginCreditAmt,
                        SUM(GLJournals.GLJournalFAmt) AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        {6}-- Debit Except 911
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                            )
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL

                        -- No Phat sinh
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        SUM(GLJournalAmt) AS DebitAmt,
                        SUM(GLJournalFAmt) AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        {7}-- Credit Except 911
                        AND {2}
                        AND GLJournalPeriod <> 0
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL 

                        -- Co phat sinh
                        SELECT
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        SUM(GLJournalAmt)AS CreditAmt,
                        SUM(GLJournalFAmt) AS CreditFAmt

                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        {6}-- Debit Except 911
                        AND {2}
                        AND GLJournalPeriod <> 0
                        GROUP BY 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 1
                        -----------------------------------------------------------
                        SELECT * INTO DATA3
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data4, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data4.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 2
                        -----------------------------------------------------------
                        SELECT * INTO DATA2
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data3, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data3.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 3
                        -----------------------------------------------------------
                        SELECT * INTO DATA1
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data2, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data2.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 4
                        -----------------------------------------------------------
                        SELECT * INTO DATA0
                        FROM
                        (
                        select 
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data1, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data1.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy View tổng hợp
                        -----------------------------------------------------------
                        SELECT * INTO Data
                        FROM
                        (
                        SELECT * FROM Data4
                        UNION ALL
                        SELECT * FROM Data3
                        UNION ALL
                        SELECT * FROM Data2
                        UNION ALL
                        SELECT * FROM Data1
                        UNION ALL
                        SELECT * FROM Data0
                        ) AS Temp

                        -----------------------------------------------------------
                        --Tính toán cân đối
                        -----------------------------------------------------------
                        SELECT 
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        CASE WHEN SUM(BeginDebitAmt) - SUM(BeginCreditAmt) > 0 THEN SUM(BeginDebitAmt) - SUM(BeginCreditAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                        CASE WHEN SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) > 0 then SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                        CASE WHEN SUM(BeginCreditAmt) - SUM(BeginDebitAmt) > 0 then SUM(BeginCreditAmt) - SUM(BeginDebitAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                        CASE WHEN SUM(BeginCreditFAmt) - SUM(BeginDebitFAmt) > 0 then SUM(BeginCreditFAmt) - SUM(BeginDebitFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                        SUM(DebitAmt) AS GLAccountDebitAmt,
                        SUM(DebitFAmt) AS GLAccountDebitFAmt,
                        SUM(CreditAmt) AS GLAccountCreditAmt,
                        SUM(CreditFAmt) AS GLAccountCreditFAmt,
                        CASE WHEN (SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt)) > 0 
					                        THEN SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                        CASE WHEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) > 0 
					                        THEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                        CASE WHEN SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt) < 0 
					                        THEN -SUM(BeginDebitAmt) - SUM(DebitAmt) + SUM(BeginCreditAmt)+ SUM(CreditAmt) ELSE 0 END AS  GLAccountEndCreditAmt,
                        CASE WHEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) < 0 
					                        THEN -SUM(BeginDebitFAmt) - SUM(DebitFAmt) + SUM(BeginCreditFAmt)+ SUM(CreditFAmt) ELSE 0 END AS GLAccountEndCreditFAmt

                        INTO BANGCANDOI
                        FROM DATA
                        WHERE 
                        GLAccountLevel <= {4}
                        GROUP BY
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel


                        -----------------------------------------------------------
                        --Tạo bản cân đối
                        -----------------------------------------------------------
                        SELECT * INTO TrialBalance
                        FROM
                        (
                        SELECT * FROM BANGCANDOI
                        UNION ALl
                        SELECT * FROM BANGCANDOI_LUONGTINH
                        ) AS Temp

                        -----------------------------------------------------------
                        --View bản cân đối
                        -----------------------------------------------------------
                        SELECT * 
                        FROM TrialBalance
                        ORDER BY GLAccountNo
	
                ", strAllRange, strBeforeStart, strInRange, strStartFiscalYear, iLevel, strAccountNo, strDebitExcept911, strCreditExcept911);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            using (TransactionScope tranScope = new TransactionScope())
            {
                GetDataSet(strDeleteTempTable);
                GetDataSet(strDeleteTempTable);
                GetDataSet(strDeleteTempTable);
                ds = GetDataSet(strQuery);
                GetDataSet(strDeleteTempTable);
            }

            return ds;

        }

        public DataSet CalcVATStatistics(DateTime dtFrom, DateTime dtTo,  List<String> lstAccountVATNo, String VATType, string sKey = "")
        {
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            if (sKey != "")
                strInRange = "(" + strInRange + ") AND " + sKey;
            String strQueryJournals = "";
            //Tạo table Journals
            //Lấy dữ liệu trong Journal theo thời gian mà có cột FK_GLAccountID = FK_GLDebitAccountID trong Journal -- Hóa đơn đầu vào
            if (VATType.Contains("In"))
            {
                strQueryJournals = String.Format(@"SELECT 
                                                        GLJournalDocumentNo AS GLJournalDocumentNo,
                                                        GLJournalDocDate AS GLJournalDocDate,
                                                        dbo.PadString(GLJournalInvNo, '0', 7) AS GLJournalInvNo,
                                                        FK_GEInvTypeID AS FK_GEInvTypeID,
                                                        GLJournalInvForm AS GLJournalInvForm,
                                                        GLJournalInvSerie AS GLJournalInvSerie,
                                                        GLJournalInvDate AS GLJournalInvDate,
                                                        GLJournalHDesc AS GLJournalHDesc,
                                                        GLJournalDesc AS GLJournalDesc,
                                                        GLJournalObjectName AS GLJournalObjectName,
                                                        GLJournalObjectTaxCode AS GLJournalObjectTaxCode,
                                                        GLJournalObjectAdd AS GLJournalObjectAdd,
                                                        FK_TXTaxCodeID AS FK_TXTaxCodeID,
                                                        GLJournalItemAmt AS GLJournalItemAmt,
                                                        GLJournalAmt AS GLJournalAmt,
                                                        GLJournalPeriod AS GLJournalPeriod,
                                                        GLJournalDate AS GLJournalDate,
                                                        FK_GLDebitAccountID AS FK_GLAccountID,
                                                        GLSourceLedger
                                                        INTO #Journals
                                                        FROM GLJournals
                                                        WHERE {0}", strInRange);
            }
            //Lấy dữ liệu trong Journal theo thời gian mà có cột FK_GLAccountID = FK_GLCreditAccountID trong Journal -- Hóa đơn đầu ra
            else
            {
                strQueryJournals = String.Format(@"SELECT 
                                                        GLJournalDocumentNo AS GLJournalDocumentNo,
                                                        GLJournalDocDate AS GLJournalDocDate,
                                                        dbo.PadString(GLJournalInvNo, '0', 7) AS GLJournalInvNo,
                                                        FK_GEInvTypeID AS FK_GEInvTypeID,
                                                        GLJournalInvForm AS GLJournalInvForm,
                                                        GLJournalInvSerie AS GLJournalInvSerie,
                                                        GLJournalInvDate AS GLJournalInvDate,
                                                        GLJournalHDesc AS GLJournalHDesc,
                                                        GLJournalDesc AS GLJournalDesc,
                                                        GLJournalObjectName AS GLJournalObjectName,
                                                        GLJournalObjectTaxCode AS GLJournalObjectTaxCode,
                                                        GLJournalObjectAdd AS GLJournalObjectAdd,
                                                        FK_TXTaxCodeID AS FK_TXTaxCodeID,
                                                        GLJournalItemAmt AS GLJournalItemAmt,
                                                        GLJournalAmt AS GLJournalAmt,
                                                        GLJournalPeriod AS GLJournalPeriod,
                                                        GLJournalDate AS GLJournalDate,
                                                        FK_GLCreditAccountID AS FK_GLAccountID,
                                                        GLSourceLedger
                                                        INTO #Journals
                                                        FROM GLJournals
                                                        WHERE {0}", strInRange);
            }
            //Xóa các table Tax, Account, Journals
            String strDeleteTempTable = String.Format(@" IF OBJECT_ID('tempdb..#Tax') IS NOT NULL
                                                            BEGIN
                                                            DROP TABLE #Tax
                                                            END

                                                            IF OBJECT_ID('tempdb..#Account') IS NOT NULL
                                                            BEGIN
                                                            DROP TABLE #Account
                                                            END

                                                            IF OBJECT_ID('tempdb..#Journals') IS NOT NULL
                                                            BEGIN
                                                            DROP TABLE #Journals
                                                            END
                                                            
                                                            IF OBJECT_ID('tempdb..#ViewKQ') IS NOT NULL
                                                            BEGIN
                                                            DROP TABLE #ViewKQ
                                                            END
                                                        ");

            //Tạo table Account trong đó có các tài khoản truyền vào

            String strQueryAccount = string.Format(@"SELECT a.GLAccountID 
INTO #Account            
FROM GLAccounts a 
    INNER JOIN TXTaxCodes b ON a.GLAccountID = b.FK_GLAccountID 
        AND a.AAStatus = 'Alive'
        ");
            if (VATType.Contains("In"))
                strQueryAccount += "AND TXTaxCodeTypeCombo = 'InputVATTax'";
            else
                strQueryAccount += "AND TXTaxCodeTypeCombo = 'OutputVATTax'";
            strQueryAccount += " GROUP BY GLAccountID";

            //String strQueryAccount = String.Format(@"SELECT '{0}' AS AccountNo", lstAccountVATNo[0]);
            //for (int i = 1; i < lstAccountVATNo.Count; i++)
            //{
            //    strQueryAccount += String.Format(@" UNION ALL SELECT '{0}' AS AccountNo", lstAccountVATNo[i]);
            //}
            //strQueryAccount = String.Format(@"SELECT * INTO Account FROM ({0}) AS Temp", strQueryAccount);

            //Lấy dữ liệu trong Table Journals, Account, Tax và gôm nhóm theo mã chứng từ, chứng từ khách hàng, ngày chứng từ khách hàng, serial, ...
            //Chia làm 2 phần là chứng từ và thuế
            String strQueryVAT = String.Format(@"SELECT GLBKVATNo,
                                                GLBKVATDate,
                                                GLBKVATInvNo,
                                                FK_GEInvTypeID,
                                                GLBKVATInvForm,
                                                GLBKVATInvSerie,
                                                GLBKVATInvDate,
                                                GLBKVATDesc,
                                                GLBKVATInvItemDesc,
                                                GLBKVATObjectName,
                                                GLBKVATObjectTaxNo,
                                                GLBKVATObjectAddress,
                                                FK_TXTAXCodeID,
                                                GLBKVATItemTotAmt,
                                                SUM(GLBKVATAmt) AS GLBKVATAmt,
                                                SourceLedger
                                                INTO #ViewKQ
                                                FROM
                                                (
                                                    SELECT 
                                                    GLJournalDocumentNo AS GLBKVATNo,
                                                    GLJournalDocDate AS GLBKVATDate,
                                                    GLJournalInvNo AS GLBKVATInvNo,
                                                    FK_GEInvTypeID AS FK_GEInvTypeID,
                                                    GLJournalInvForm AS GLBKVATInvForm,
                                                    GLJournalInvSerie AS GLBKVATInvSerie,
                                                    GLJournalInvDate AS GLBKVATInvDate,
                                                    GLJournalHDesc AS GLBKVATDesc,
                                                    GLJournalDesc AS GLBKVATInvItemDesc,
                                                    GLJournalObjectName AS GLBKVATObjectName,
                                                    GLJournalObjectTaxCode AS GLBKVATObjectTaxNo,
                                                    GLJournalObjectAdd AS GLBKVATObjectAddress,
                                                    FK_TXTaxCodeID AS FK_TXTAXCodeID,
                                                    SUM(GLJournalItemAmt) AS GLBKVATItemTotAmt,
                                                    SUM(GLJournalAmt) AS GLBKVATAmt,
                                                    GLSourceLedger AS SourceLedger
                                                    FROM #Journals   
                                                        INNER JOIN GLAccounts ON GLAccounts.AAStatus = 'Alive' AND FK_GLAccountID = GLAccounts.GLAccountID
                                                        INNER JOIN #Account ON GLAccounts.GLAccountID = #Account.GLAccountID
                                                    WHERE GLJournalPeriod <> 0
                                                    GROUP BY GLJournalDocumentNo, GLJournalInvNo,FK_GEInvTypeID,GLJournalInvForm, GLJournalInvSerie,
                                                    GLJournalInvDate, GLJournalDesc, GLJournalObjectName,
                                                    GLJournalObjectTaxCode, GLJournalHDesc, GLJournalDocDate,
                                                    FK_TXTaxCodeID, GLJournalObjectAdd, GLSourceLedger

                                                    UNION ALL

	                                                SELECT 
	                                                GLJournalDocumentNo AS GLBKVATNo,
	                                                GLJournalDocDate AS GLBKVATDate,
	                                                GLJournalInvNo AS GLBKVATInvNo,
                                                    FK_GEInvTypeID as FK_GEInvTypeID,
	                                                GLJournalInvForm AS GLBKVATInvForm,
	                                                GLJournalInvSerie AS GLBKVATInvSerie,
	                                                GLJournalInvDate AS GLBKVATInvDate,
	                                                GLJournalHDesc AS GLBKVATDesc,
	                                                GLJournalDesc AS GLBKVATInvItemDesc,
	                                                GLJournalObjectName AS GLBKVATObjectName,
	                                                GLJournalObjectTaxCode AS GLBKVATObjectTaxNo,
	                                                GLJournalObjectAdd AS GLBKVATObjectAddress,
	                                                FK_TXTaxCodeID AS FK_TXTAXCodeID,
	                                                SUM(GLJournalAmt) AS GLBKVATItemTotAmt,
	                                                0 AS GLBKVATAmt,
	                                                GLSourceLedger AS SourceLedger
	                                                FROM #Journals, TxTaxCodes
	                                                WHERE GLJournalPeriod <> 0
	                                                AND FK_TXTaxCodeID = TXTaxCodes.TXTaxCodeID
	                                                AND TXTaxCodes.AAStatus = 'Alive'
	                                                AND TXTaxCodePct = 0
	                                                AND TXTaxCodeTypeCombo = '{1}'
	                                                GROUP BY GLJournalDocumentNo, GLJournalInvNo, FK_GEInvTypeID,GLJournalInvForm, GLJournalInvSerie,
                                                    GLJournalInvDate, GLJournalDesc, GLJournalObjectName,
                                                    GLJournalObjectTaxCode, GLJournalHDesc, GLJournalDocDate,
                                                    FK_TXTaxCodeID, GLJournalObjectAdd, GLSourceLedger                                                 
                                                ) AS TEMP
                                                GROUP BY GLBKVATNo, GLBKVATDate, GLBKVATInvNo,FK_GEInvTypeID,GLBKVATInvForm,
                                                GLBKVATInvSerie, GLBKVATInvDate, GLBKVATDesc,
                                                GLBKVATInvItemDesc, GLBKVATObjectName, GLBKVATObjectTaxNo,
                                                GLBKVATObjectAddress, FK_TXTAXCodeID, GLBKVATItemTotAmt,SourceLedger
                                                ORDER BY GLBKVATInvDate
                                                
                                                SELECT *,ISNULL(TXTaxCodePct, 10) AS GLBKVATPct
                                                FROM (
                                                    SELECT 
                                                        GLBKVATNo,
                                                	    MAX(GLBKVATDate) AS GLBKVATDate,
	                                                    MAX(GLBKVATInvNo) AS GLBKVATInvNo,
	                                                    MAX(FK_GEInvTypeID) AS FK_GEInvTypeID,
	                                                    MAX(GLBKVATInvForm) AS GLBKVATInvForm,
	                                                    MAX(GLBKVATInvSerie) AS GLBKVATInvSerie,
	                                                    MAX(GLBKVATInvDate) AS GLBKVATInvDate,
	                                                    MAX(GLBKVATDesc) AS GLBKVATDesc,
	                                                    MAX(GLBKVATInvItemDesc) AS GLBKVATInvItemDesc,
	                                                    MAX(GLBKVATObjectName) AS GLBKVATObjectName,
	                                                    MAX(GLBKVATObjectTaxNo) AS GLBKVATObjectTaxNo,
	                                                    MAX(GLBKVATObjectAddress) AS GLBKVATObjectAddress,
	                                                    MAX(FK_TXTAXCodeID) AS FK_TxTaxCodeID,
	                                                    SUM(GLBKVATItemTotAmt) AS GLBKVATItemTotAmt,
	                                                    SUM(GLBKVATAmt) AS GLBKVATAmt,
	                                                    MAX(SourceLedger) AS SourceLedger
                                                    FROM #ViewKQ
                                                    GROUP BY GLBKVATNo
                                                ) a
                                                JOIN TxTaxCodes b ON a.FK_TxTaxCodeID = b.TxTaxCodeID AND b.AAStatus = 'Alive'
                                                ", strInRange, VATType);

            //GetDataSet(strDeleteTempTable);
            //GetDataSet(strQueryAccount);
            //GetDataSet(strQueryJournals);
            DataSet ds = GetDataSet(string.Concat(strQueryAccount, Environment.NewLine, strQueryJournals, Environment.NewLine, strQueryVAT, Environment.NewLine, strDeleteTempTable));
            //GetDataSet(strDeleteTempTable);

            return ds;

        }

        public DataSet CalcCostConsolidate(DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, List<String> lstAccountNo, bool isOverall)
        {
            String strDtFrom = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtFrom.Year, dtFrom.Month, dtFrom.Day);
            String strDtTo = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtTo.Year, dtTo.Month, dtTo.Day);

            String strBeginFromCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String strBeginToCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeginTimeRange = String.Format(@"{0} AND {1}", strBeginFromCond, strBeginToCond);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);

            #region Prepair Query

            String strQueryAccount = String.Empty;
            if (lstAccountNo.Count == 0)
                strQueryAccount = String.Format(@"SELECT GLAccountNo AS AccountNo FROM GLAccounts WHERE AAStatus = 'Alive'");
            else
            {
                strQueryAccount = String.Format(@"SELECT '{0}' AS AccountNo", lstAccountNo[0]);
                for (int i = 1; i < lstAccountNo.Count; i++)
                {
                    strQueryAccount += String.Format(@" UNION ALL SELECT '{0}' AS AccountNo", lstAccountNo[i]);
                }
            }

            strQueryAccount = String.Format(@"SELECT DISTINCT * INTO Account FROM ({0}) AS Temp", strQueryAccount);

            #region Delete Temp Table
            String strDeleteTempTable = String.Format(@"

                                                    IF OBJECT_ID('Account') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Account
                                                    END
                                                    ");
            #endregion


            #endregion

            String strQuery = String.Empty;
            if(isOverall == true)
                strQuery = String.Format(@"
                                        SELECT 
                                        0 AS PPCostConsolidateID,
                                        --'TRUE' AS AASelected,
                                        GLAccounts.GLAccountID AS FK_GLAccountID,
                                        SUM(GLJournals.GLJournalAmt) AS PPCostConsolidateAmt,
                                        100 AS PPCostConsAllocatePct
                                        FROM dbo.GLJournals INNER JOIN GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                        INNER JOIN Account ON GLAccounts.GLAccountNo LIKE Account.AccountNo + '%'
                                        INNER JOIN dbo.GLCostCenters ON GLJournals.FK_GLCostCenterID = GLCostCenters.GLCostCenterID
                                        WHERE
                                        (GLJournals.FK_GLCostCenterID IS NULL OR GLCostCenters.AAStatus <> 'Alive')
                                        AND {0}
                                        GROUP BY 
                                        GLAccounts.GLAccountID
                                        ", strInRange);
            else
                strQuery = String.Format(@"
                                        SELECT 
                                        0 AS PPCostConsolidateID,
                                        GLCostCenters.GLCostCenterID AS FK_GLCostCenterID,
                                        --'TRUE' AS AASelected,
                                        GLAccounts.GLAccountID AS FK_GLAccountID,
                                        ICStocks.ICStockID AS FK_ICStockID,
                                        GLAccounts.GLAccountID AS FK_GLAccountID, 
                                        SUM(GLJournals.GLJournalAmt) AS PPCostConsolidateAmt,
                                        'Direct' AS PPCostTypeCombo
                                        FROM dbo.GLJournals INNER JOIN GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                        INNER JOIN Account ON GLAccounts.GLAccountNo LIKE Account.AccountNo + '%'
                                        INNER JOIN dbo.GLCostCenters ON GLJournals.FK_GLCostCenterID = GLCostCenters.GLCostCenterID
                                        INNER JOIN dbo.ICStocks ON GLCostCenters.FK_ICStockID = ICStocks.ICStockID
                                        WHERE
                                        GLCostCenters.AAStatus = 'Alive'
                                        AND ICStocks.AAStatus = 'Alive'
                                        AND {0}
                                        GROUP BY 
                                        GLAccounts.GLAccountID,
                                        ICStocks.ICStockID,
                                        GLCostCenters.GLCostCenterID
                                        ", strInRange);


            GetDataSet(strDeleteTempTable);
            GetDataSet(strQueryAccount);
            DataSet ds = GetDataSet(strQuery);
            GetDataSet(strDeleteTempTable);

            return ds;
        }

        public DataSet CalcCostConsolidate(DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, int iProductionCostFactorID, bool isInDirect)
        {
            DataSet ds = new DataSet();

            String strDtFrom = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtFrom.Year, dtFrom.Month, dtFrom.Day);
            String strDtTo = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtTo.Year, dtTo.Month, dtTo.Day);

            String strBeginFromCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String strBeginToCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeginTimeRange = String.Format(@"{0} AND {1}", strBeginFromCond, strBeginToCond);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);

            List<String> lstCostFactorAccountNo = new List<string>();

            PPProductionCostFactorsInfo CostFactor = (PPProductionCostFactorsInfo)new PPProductionCostFactorsController().GetObjectByID(iProductionCostFactorID);
            if (CostFactor == null || string.IsNullOrEmpty(CostFactor.PPAccountListNo)) return ds;
            GLAccountsController AccountCtrl = new GLAccountsController();
            String[] AccountArrs = CostFactor.PPAccountListNo.Trim().Split(';');
            foreach (String strAccountNo in AccountArrs)
            {
                DataSet dsAccountChild = AccountCtrl.GetAllChildAccounts(strAccountNo);
                if (dsAccountChild != null && dsAccountChild.Tables.Count > 0)
                {
                    foreach (DataRow drAccountChild in dsAccountChild.Tables[0].Rows)
                    {
                        GLAccountsInfo AccountChildInfo = (GLAccountsInfo)AccountCtrl.GetObjectFromDataRow(drAccountChild);
                        if (AccountChildInfo != null)
                        {
                            lstCostFactorAccountNo.Add(AccountChildInfo.GLAccountNo);
                        }
                    }
                }
            }

            #region Prepair Query

            String strQueryAccount = String.Empty;
            if (lstCostFactorAccountNo.Count == 0)
                strQueryAccount = String.Format(@"SELECT GLAccountNo AS AccountNo FROM GLAccounts WHERE AAStatus = 'Alive'");
            else
            {
                strQueryAccount = String.Format(@"SELECT '{0}' AS AccountNo", lstCostFactorAccountNo[0]);
                for (int i = 1; i < lstCostFactorAccountNo.Count; i++)
                {
                    strQueryAccount += String.Format(@" UNION ALL SELECT '{0}' AS AccountNo", lstCostFactorAccountNo[i]);
                }
            }

            strQueryAccount = String.Format(@"SELECT DISTINCT * INTO Account FROM ({0}) AS Temp", strQueryAccount);

            #region Delete Temp Table
            String strDeleteTempTable = String.Format(@"
                                                    IF OBJECT_ID('Account') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Account
                                                    END
                                                    ");
            #endregion


            #endregion

            String strQuery = String.Empty;
            if (isInDirect == true)
                strQuery = String.Format(@"
                                        SELECT 
                                        0 AS PPCostConsolidateID,
                                        --'TRUE' AS AASelected,
                                        GLAccounts.GLAccountID AS FK_GLAccountID,
                                        SUM(GLJournals.GLJournalAmt) AS PPCostConsolidateAmt,
                                        100 AS PPCostConsAllocatePct,
                                        {0} AS FK_PPProductionCostFactorID,
                                        'InDirect' AS PPCostTypeCombo
                                        FROM dbo.GLJournals INNER JOIN GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                        INNER JOIN Account ON GLAccounts.GLAccountNo LIKE Account.AccountNo + '%'
                                        INNER JOIN dbo.GLCostCenters ON GLJournals.FK_GLCostCenterID = GLCostCenters.GLCostCenterID
                                        WHERE
                                        (GLJournals.FK_GLCostCenterID IS NULL OR GLCostCenters.AAStatus <> 'Alive')
                                        AND {1}
                                        GROUP BY 
                                        GLAccounts.GLAccountID
                                        ", iProductionCostFactorID,  strInRange);
            else
                strQuery = String.Format(@"
                                        SELECT 
                                        0 AS PPCostConsolidateID,
                                        GLCostCenters.GLCostCenterID AS FK_GLCostCenterID,
                                        --'TRUE' AS AASelected,
                                        GLAccounts.GLAccountID AS FK_GLAccountID,
                                        ICStocks.ICStockID AS FK_ICStockID,
                                        GLAccounts.GLAccountID AS FK_GLAccountID, 
                                        SUM(GLJournals.GLJournalAmt) AS PPCostConsolidateAmt,
                                        'Direct' AS PPCostTypeCombo,
                                        {0} AS FK_PPProductionCostFactorID
                                        FROM dbo.GLJournals INNER JOIN GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                        INNER JOIN Account ON GLAccounts.GLAccountNo LIKE Account.AccountNo + '%'
                                        INNER JOIN dbo.GLCostCenters ON GLJournals.FK_GLCostCenterID = GLCostCenters.GLCostCenterID
                                        INNER JOIN dbo.ICStocks ON GLCostCenters.FK_ICStockID = ICStocks.ICStockID
                                        WHERE
                                        GLCostCenters.AAStatus = 'Alive'
                                        AND ICStocks.AAStatus = 'Alive'
                                        AND {1}
                                        GROUP BY 
                                        GLAccounts.GLAccountID,
                                        ICStocks.ICStockID,
                                        GLCostCenters.GLCostCenterID
                                        ", iProductionCostFactorID, strInRange);


            GetDataSet(strDeleteTempTable);
            GetDataSet(strQueryAccount);
            ds = GetDataSet(strQuery);
            GetDataSet(strDeleteTempTable);

            return ds;
        }

        public Double GetBeginCostConsolidateAmt(int iCostCenterID, int iCostAccountID, DateTime dtStart)
        {
            double dAmt = 0;

            DateTime dtPre = dtStart.AddMonths(-1);

            String strQuery = String.Format(@"SELECT SUM(GLJournalAmt)
                                                FROM GLJournals
                                                WHERE FK_GLDebitAccountID = {0}
                                                AND FK_GLCostCenterID = {1}
                                                AND MONTH(GLJournalDate) = {2}
                                                AND YEAR(GLJournalDate) = {3}", iCostAccountID, iCostCenterID, dtPre.Month, dtPre.Year);

            DataSet ds = GetDataSet(strQuery);

            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                dAmt = Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return dAmt;
        }

        public DataSet GetJournalCostConsolidate(DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, String strAccountNo, bool isOverall)
        {
            String strDtFrom = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtFrom.Year, dtFrom.Month, dtFrom.Day);
            String strDtTo = String.Format(@"{0}-{1}-{2} 00:00:00.000", dtTo.Year, dtTo.Month, dtTo.Day);

            String strBeginFromCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String strBeginToCond = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeginTimeRange = String.Format(@"{0} AND {1}", strBeginFromCond, strBeginToCond);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);

            String strQuery = String.Empty;
            if (isOverall == true)
                strQuery = String.Format(@"
                                        SELECT GLJournals.*
                                        FROM dbo.GLJournals INNER JOIN GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                        INNER JOIN dbo.GLCostCenters ON GLJournals.FK_GLCostCenterID = GLCostCenters.GLCostCenterID
                                        WHERE
                                        (GLJournals.FK_GLCostCenterID IS NULL OR GLCostCenters.AAStatus <> 'Alive')
                                        AND GLAccounts.GLAccountNo like '{0}'
                                        AND {1}
                                        ", strAccountNo, strInRange);
            else
                strQuery = String.Format(@"
                                        SELECT GLJournals.*
                                        FROM dbo.GLJournals INNER JOIN GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                        INNER JOIN dbo.GLCostCenters ON GLJournals.FK_GLCostCenterID = GLCostCenters.GLCostCenterID
                                        INNER JOIN dbo.ICStocks ON GLCostCenters.FK_ICStockID = ICStocks.ICStockID
                                        WHERE
                                        GLCostCenters.AAStatus = 'Alive'
                                        AND ICStocks.AAStatus = 'Alive'
                                        AND GLAccounts.GLAccountNo like '{0}'
                                        AND {1}
                                        ",strAccountNo, strInRange);

            return GetDataSet(strQuery);
        }

        public DataSet GetJournalConsolidateDirect(PPCostConsolidatesInfo CostConsolidateInfo)
        {
            DataSet ds = new DataSet();
            
            String strQuery = String.Format(@"  SELECT * FROM dbo.GLJournals
                                                INNER JOIN dbo.GLCostCenters ON dbo.GLJournals.FK_GLCostCenterID = dbo.GLCostCenters.GLCostCenterID
                                                INNER JOIN dbo.ICStocks ON dbo.GLCostCenters.FK_ICStockID = dbo.ICStocks.ICStockID
                                                INNER JOIN dbo.GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                                WHERE dbo.GLAccounts.AAStatus ='Alive' AND dbo.GLCostCenters.AAStatus = 'Alive' AND dbo.ICStocks.AAStatus = 'Alive'
                                                AND YEAR(GLJournalDate) * 12 + MONTH(GLJournalDate) = {0} * 12 + {1}
                                                AND dbo.GLJournals.FK_GLDebitAccountID = {2}
                                                AND dbo.GLJournals.FK_GLCostCenterID = {3}
                                                AND dbo.GLCostCenters.FK_ICStockID = {4}
                                                ", CostConsolidateInfo.PPYear, CostConsolidateInfo.PPPeriod, CostConsolidateInfo.FK_GLAccountID, CostConsolidateInfo.FK_GLCostCenterID, CostConsolidateInfo.FK_ICStockID);
            if (String.IsNullOrEmpty(strQuery))
            {
                return new DataSet();
            }
            else
            {
                return GetDataSet(strQuery);
            }
        }

        public DataSet GetJournalConsolidateInDirect(PPCostConsolidatesInfo CostConsolidateInfo)
        {
            DataSet ds = new DataSet();

            String strQuery = String.Format(@" SELECT * FROM dbo.GLJournals
                                            INNER JOIN dbo.GLCostCenters ON dbo.GLJournals.FK_GLCostCenterID = dbo.GLCostCenters.GLCostCenterID
                                            INNER JOIN dbo.GLAccounts ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                            WHERE dbo.GLAccounts.AAStatus ='Alive'
                                            AND YEAR(GLJournalDate) * 12 + MONTH(GLJournalDate) = {0} * 12 + {1}
                                            AND dbo.GLJournals.FK_GLDebitAccountID = {2}
                                            AND (dbo.GLJournals.FK_GLCostCenterID IS NULL OR dbo.GLJournals.FK_GLCostCenterID = 0)
                                        ", CostConsolidateInfo.PPYear, CostConsolidateInfo.PPPeriod, CostConsolidateInfo.FK_GLAccountID);
            
            if (String.IsNullOrEmpty(strQuery))
            {
                return new DataSet();
            }
            else
            {
                return GetDataSet(strQuery);
            }
        }

        public Double GetSUMFixCostPayment(DateTime dtFrom, DateTime dtTo)
        {
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);

            #region Delete Temp Table
            String strDeleteTempTable = String.Format(@"IF OBJECT_ID('Account') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Account
                                                    END");
            #endregion

            #region Query Account
            String strQueryAccount = String.Empty;
            strQueryAccount = String.Format(@"SELECT GLAccountNo AS AccountNo
                                                INTO Account 
                                                FROM GLAccounts
                                                WHERE AAStatus = 'Alive'
                                                AND (
                                                        GLAccountNo like '6%'
                                                        OR
                                                        GLAccountNo like '8%'
                                                    )
                                                AND GLAccountID NOT IN 
                                                                    (
                                                                        SELECT FK_GLAccountParentID FROM GLAccounts
                                                                        WHERE AAStatus = 'Alive'
                                                                    )");

            #endregion


            String strQuery = String.Format(@"SELECT SUM(GLJournalAmt)
                                                FROM GLJournals, dbo.GLAccounts AS DebitAccounts, GLAccounts AS CreditAccounts
                                                WHERE 
                                                GLJournals.FK_GLDebitAccountID = DebitAccounts.GLAccountID
                                                AND GLJournals.FK_GLCreditAccountID = CreditAccounts.GLAccountID
                                                AND {0}
                                                AND (
		                                                CreditAccounts.GLAccountNo LIKE '111%'
		                                                OR 
		                                                CreditAccounts.GLAccountNo LIKE '112%'
	                                                )
                                                AND DebitAccounts.GLAccountNo IN (SELECT AccountNo FROM Account)", strInRange);

            GetDataSet(strDeleteTempTable);
            GetDataSet(strQueryAccount);
            DataSet ds = GetDataSet(strQuery);
            GetDataSet(strDeleteTempTable);

            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;
        }

        public DataSet GetAllJournalFixCostPayment(DateTime dtFrom, DateTime dtTo)
        {
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);

            #region Delete Temp Table
            String strDeleteTempTable = String.Format(@"IF OBJECT_ID('Account') IS NOT NULL
                                                    BEGIN
                                                    DROP TABLE Account
                                                    END");
            #endregion

            #region Query Account
            String strQueryAccount = String.Empty;
            strQueryAccount = String.Format(@"SELECT GLAccountNo AS AccountNo
                                                INTO Account 
                                                FROM GLAccounts
                                                WHERE AAStatus = 'Alive'
                                                AND (
                                                        GLAccountNo like '6%'
                                                        OR
                                                        GLAccountNo like '8%'
                                                    )
                                                AND GLAccountID NOT IN 
                                                                    (
                                                                        SELECT FK_GLAccountParentID FROM GLAccounts
                                                                        WHERE AAStatus = 'Alive'
                                                                    )");

            #endregion


            String strQuery = String.Format(@"SELECT GLJournals.*
                                                FROM GLJournals, dbo.GLAccounts AS DebitAccounts, GLAccounts AS CreditAccounts
                                                WHERE 
                                                GLJournals.FK_GLDebitAccountID = DebitAccounts.GLAccountID
                                                AND GLJournals.FK_GLCreditAccountID = CreditAccounts.GLAccountID
                                                AND {0}
                                                AND (
		                                                CreditAccounts.GLAccountNo LIKE '111%'
		                                                OR 
		                                                CreditAccounts.GLAccountNo LIKE '112%'
	                                                )
                                                AND DebitAccounts.GLAccountNo IN (SELECT AccountNo FROM Account)", strInRange);

            GetDataSet(strDeleteTempTable);
            GetDataSet(strQueryAccount);
            DataSet ds = GetDataSet(strQuery);
            GetDataSet(strDeleteTempTable);

            return ds;
        }

        public DataSet CalcTrialBalanceForObjects(String strAccountNo, DateTime dtFrom, DateTime dtTo, DateTime dtLastStartFiscalYear, int iLevel)
        {
            String strAllRange = DALUtil.GenerateBeetween("GLJournalDate", dtLastStartFiscalYear, dtTo);
            String strInRange = DALUtil.GenerateBeetween("GLJournalDate", dtFrom, dtTo);
            string str1 = DALUtil.GennerateCondition("GLJournalDate", CompareType.GreaterEqualThan, dtLastStartFiscalYear);
            String str2 = DALUtil.GennerateCondition("GLJournalDate", CompareType.LessThan, dtFrom);
            String strBeforeStart = String.Format(@"({0} AND {1})", str1, str2);
            String strStartFiscalYear = DALUtil.GennerateCondition("GLJournalDate", CompareType.Equal, dtLastStartFiscalYear);

            String strDeleteTempTable = String.Format(
                @"
                    -----------------------------------------------------------
                        --Delete cac table tam cho viec tinh cac TK Luong tinh
                        -----------------------------------------------------------

                        IF OBJECT_ID('TrialBalance') IS NOT NULL
                        BEGIN
                        DROP TABLE TrialBalance
                        END
	
                        IF OBJECT_ID('Objects') IS NOT NULL
                        BEGIN
                        DROP TABLE Objects
                        END

                        IF OBJECT_ID('Account') IS NOT NULL
                        BEGIN
                        DROP TABLE Account
                        END


                        IF OBJECT_ID('Journals') IS NOT NULL
                        BEGIN
                        DROP TABLE Journals
                        END

                        IF OBJECT_ID('ObjectJournals') IS NOT NULL
                        BEGIN
                        DROP TABLE ObjectJournals
                        END
                        IF OBJECT_ID('CongNo') IS NOT NULL
                        BEGIN
                        DROP TABLE CongNo
                        END

                        IF OBJECT_ID('CongNoChiTiet') IS NOT NULL
                        BEGIN
                        DROP TABLE CongNoChiTiet
                        END
	
                        IF OBJECT_ID('DATA_LT4') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT4
                        END
	
                        IF OBJECT_ID('DATA_LT3') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT3
                        END
	
                        IF OBJECT_ID('Data_LT2') IS NOT NULL
                        BEGIN
                        DROP TABLE Data_LT2
                        END
	
                        IF OBJECT_ID('DATA_LT1') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT1
                        END
	
                        IF OBJECT_ID('DATA_LT0') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT0
                        END
	
                        IF OBJECT_ID('DATA_LT') IS NOT NULL
                        BEGIN
                        DROP TABLE DATA_LT
                        END
	
                        IF OBJECT_ID('BANGCANDOI_LUONGTINH') IS NOT NULL
                        BEGIN
                        DROP TABLE BANGCANDOI_LUONGTINH
                        END
	
                        -----------------------------------------------------------
                        --Delete cac table tam cho viec tinh cac TK No, Co
                        -----------------------------------------------------------

                        IF OBJECT_ID('Data4') IS NOT NULL
                        BEGIN
                        DROP TABLE Data4
                        END

                        IF OBJECT_ID('Data3') IS NOT NULL
                        BEGIN
                        DROP TABLE Data3
                        END

                        IF OBJECT_ID('Data2') IS NOT NULL
                        BEGIN
                        DROP TABLE Data2
                        END

                        IF OBJECT_ID('Data1') IS NOT NULL
                        BEGIN
                        DROP TABLE Data1
                        END

                        IF OBJECT_ID('Data0') IS NOT NULL
                        BEGIN
                        DROP TABLE Data0
                        END

                        IF OBJECT_ID('Data') IS NOT NULL
                        BEGIN
                        DROP TABLE Data
                        END

                        IF OBJECT_ID('BANGCANDOI') IS NOT NULL
                        BEGIN
                        DROP TABLE BANGCANDOI
                        END

                ");
            String strQuery =
               String.Format(@"
                        -----------------------------------------------------------
                        --Lấy về các Đối tượng
                        -----------------------------------------------------------

                        SELECT * INTO Objects
                        FROM 
                        (select 'Cust' + CAST(ARCustomerID AS nvarchar(50)) AS ObjectID,
                        ARCustomerNo as ObjectNo,
                        ARCustomerName as ObjectName
                        FROM ARCustomers 
                        WHERE AAStatus = 'Alive' 

                        UNION ALL 

                        select 'Sup' + CAST(APSUpplierID AS nvarchar(50)) AS ObjectID,
                        APSUpplierNo as ObjectNo,
                        APSupplierName as ObjectName
                        FROM APSuppliers 
                        WHERE AAStatus = 'Alive' 

                        UNION ALL

                        select 'Emp' + CAST(HREmployeeID AS nvarchar(50)) AS ObjectID,
                        HREmployeeNo as ObjectNo,
                        HREmployeeName as ObjectName
                        FROM HREmployees 
                        WHERE AAStatus = 'Alive'

                        UNION ALL

                        SELECT 'Unknow' AS ObjectID,
                        'Unknow' AS ObjectNo,
                        N'Không rõ đối tượng' AS ObjectName
                        ) AS TEMP
	
	
                        -----------------------------------------------------------
                        --Lấy về các Tài khoản con lưỡng tính
                        -----------------------------------------------------------
                        SELECT * INTO Account 
                        FROM (
                        SELECT 
                        GLAccountNo AS AccountNo,
                        GLAccountName AS AccountName,
                        FK_GLAccountParentID AS AccountParentID,
                        GLAccountLevel AS GLAccountLevel
                        FROM GLAccounts 
                        WHERE AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccountBalanceCombo = 'NC'
                        AND GLAccountID NOT IN(SELECT FK_GLAccountParentID FROM GLAccounts WHERE AAStatus = 'Alive')
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về Journals và các đối tượng
                        -----------------------------------------------------------

                        SELECT * INTO Journals
                        FROM
                        (
                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE 
                        ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                        AND {0} --AllRange

                        UNION ALL

                        SELECT Objects.*,
                        GLJournals.GLJournalID,
                        GLJournals.FK_GLDebitAccountID,
                        GLJournals.FK_GLCreditAccountID,
                        GLJournals.GLJournalAmt,
                        GLJournals.GLJournalFAmt,
                        GLJournals.FK_GECurrencyID,
                        GLJournals.GLJournalExRate,
                        GLJournals.FK_APSupplierID,
                        GLJournals.FK_ARCustomerID,
                        GLJournals.FK_HREmployeeID,
                        GLJournals.GLJournalDate,
                        GLJournalPeriod,
                        GLJournalYear
                        FROM GLJournals, Objects
                        WHERE ObjectNo = 'Unknow'
                        AND FK_APSupplierID = 0
                        AND FK_ARCustomerID = 0
                        AND FK_HREmployeeID = 0
                        AND {0} --AllRange

                        ) AS Temp
        
                        -----------------------------------------------------------
                        --Lấy về Dữ liệu Đầu kỳ , trong kỳ
                        -----------------------------------------------------------                                
                        SELECT * INTO ObjectJournals
                        FROM
                        (
                        -- No dau ky
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccounts.GLAccountID, GLAccountNo, GLAccountName,
                        SUM(Journals.GLJournalAmt) AS BeginDebitAmt,
                        SUM(Journals.GLJournalFAmt) AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                        )
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        --Co dau ky
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        SUM(Journals.GLJournalAmt) AS BeginCreditAmt,
                        SUM(Journals.GLJournalFAmt) AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                            )
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        -- No phat sinh
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        SUM(Journals.GLJournalAmt) AS ArisingDebitAmt,
                        SUM(Journals.GLJournalFAmt) AS ArisingDebitFAmt,
                        0 AS ArisingCreditAmt,
                        0 AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND {2} -- InRange
                        AND GLJournalPeriod <> 0
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName

                        UNION ALL

                        -- Co phat sinh
                        SELECT 
                        ObjectID, ObjectNo, ObjectName, 
                        GLAccountID, GLAccountNo, GLAccountName,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS ArisingDebitAmt,
                        0 AS ArisingDebitFAmt,
                        SUM(Journals.GLJournalAmt) AS ArisingCreditAmt,
                        SUM(Journals.GLJournalFAmt) AS ArisingCreditFAmt,
                        0 AS AccumDebitAmt,
                        0 AS AccumDebitFAmt,
                        0 AS AccumCreditAmt,
                        0 AS AccumCreditFAmt
                        FROM Journals, GLAccounts, Account
                        WHERE
                        Journals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        AND GLAccounts.GLAccountNo like Account.AccountNo + '%'
                        AND GLAccounts.AAStatus = 'Alive'
                        AND {2} -- InRange
                        AND GLJournalPeriod <> 0
                        GROUP BY ObjectID, ObjectNo, ObjectName, GLAccountID, GLAccountNo, GLAccountName


                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về Journals và các đối tượng
                        -----------------------------------------------------------
                        SELECT 
                        GLAccountID, GLAccountNo, ObjectID, ObjectNo, ObjectName,
                        SUM(BeginDebitAmt) - SUM(BeginCreditAmt) AS BeginAmt,
                        SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) AS BeginFAmt,
                        SUM(ArisingDebitAmt) AS ArisingDebAmt,
                        SUM(ArisingDebitFAmt) AS ArisingDebFAmt,
                        SUM(ArisingCreditAmt) AS ArisingCreAmt,
                        SUM(ArisingCreditFAmt) AS ArisingCreFAmt,
                        SUM(BeginDebitAmt) - SUM(BeginCreditAmt) + SUM(ArisingDebitAmt) - SUM(ArisingCreditAmt) AS EndAmt,
                        SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt)  + SUM(ArisingDebitFAmt) - SUM(ArisingCreditFAmt) AS EndFAmt

                        INTO CongNo
                        FROM ObjectJournals
                        Group By GLAccountID, GLAccountNo, ObjectID ,ObjectNo, ObjectName
	
                        -----------------------------------------------------------
                        --Tổng hợp công nợ theo đối tượng
                        -----------------------------------------------------------                                  
                        SELECT  
                        CongNo.ObjectID AS ObjectIDRef,
                        CongNo.GLAccountID AS FK_GLAccountID,
                        Account.AccountParentID AS AccountParentID,
                        CAST('2012-12-1 00:00:00.000' AS DateTime) AS GLTrialBalanceFromDate,
                        CAST('2012-12-31 00:00:00.000' AS DateTime) AS GLTrialBalanceToDate,
                        100002 AS FK_GECurrencyID,
                        Account.AccountNo AS GLAccountNo,
                        Account.AccountName AS GLAccountName,
                        Account.GLAccountLevel,
                        ObjectNo, ObjectName,
                        CASE WHEN SUM(BeginAmt) >= 0 then SUM(BeginAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                        CASE WHEN SUM(BeginFAmt) >= 0 then SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                        CASE WHEN SUM(BeginAmt) < 0 then -SUM(BeginAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                        CASE WHEN SUM(BeginFAmt) < 0 then -SUM(BeginFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                        SUM(ArisingDebAmt) AS GLAccountDebitAmt,
                        SUM(ArisingDebFAmt) AS GLAccountDebitFAmt,
                        SUM(ArisingCreAmt) AS GLAccountCreditAmt,
                        SUM(ArisingCreFAmt) AS GLAccountCreditFAmt,
                        CASE WHEN SUM(EndAmt) >= 0 then SUM(EndAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                        CASE WHEN SUM(EndFAmt) >= 0 then SUM(EndFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                        CASE WHEN SUM(EndAmt) < 0 then -SUM(EndAmt) ELSE 0 END AS GLAccountEndCreditAmt,
                        CASE WHEN SUM(EndFAmt) < 0 then -SUM(EndFAmt) ELSE 0 END AS GLAccountEndCreditFAmt
                        INTO CongNoChiTiet
                        FROM CongNo,Account
                        WHERE GLAccountNo like Account.AccountNo + '%'
                        GROUP BY CongNo.ObjectID, CongNo.GLAccountID, Account.AccountNo,
                        Account.AccountName, ObjectNo, ObjectName,Account.AccountParentID,Account.GLAccountLevel
   

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất
                        ----------------------------------------------------------- 
                        SELECT 
                        ObjectIDRef, ObjectNo, ObjectName,
                        FK_GLAccountID AS GLAccountID,
                        CongNoChitiet.AccountParentID AS AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT4
                        FROM CongNoChitiet
                        Group By
                        ObjectIDRef, ObjectNo, ObjectName,
                        FK_GLAccountID,
                        CongNoChitiet.AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất -1
                        ----------------------------------------------------------- 
                        SELECT
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT3
                        FROM DATA_LT4, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND DATA_LT4.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 2
                        ----------------------------------------------------------- 
                        SELECT
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO Data_LT2
                        FROM DATA_LT3, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND DATA_LT3.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 3
                        ----------------------------------------------------------- 
                        SELECT
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT1
                        FROM Data_LT2, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data_LT2.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Lấy về view theo TK con nhất - 4
                        ----------------------------------------------------------- 
                        SELECT
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO DATA_LT0
                        FROM Data_LT1, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data_LT1.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        -----------------------------------------------------------
                        --Tổng hợp view theo TK 
                        ----------------------------------------------------------- 
                        SELECT * INTO DATA_LT
                        FROM
                        (
                        SELECT * FROM Data_LT4
                        UNION ALL
                        SELECT * FROM Data_LT3
                        UNION ALL
                        SELECT * FROM Data_LT2
                        UNION ALL
                        SELECT * FROM Data_LT1
                        UNION ALL
                        SELECT * FROM Data_LT0
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về view 
                        ----------------------------------------------------------- 
                        SELECT
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,
                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt
                        INTO BANGCANDOI_LUONGTINH
                        FROM DATA_LT
                        WHERE
                        GLAccountLevel <= {4}
                        GROUP BY 
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất
                        -----------------------------------------------------------

                        SELECT * INTO Data4
                        FROM
                        (
                        -- No Dau ky
                        SELECT
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(GLJournals.GLJournalAmt) AS BeginDebitAmt,
                        SUM(GLJournals.GLJournalFAmt) AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        INNER JOIN Objects ON (
                                                            ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            (
                                                                ObjectNo = 'Unknow'
                                                                AND GLJournals.FK_APSupplierID = 0
                                                                AND GLJournals.FK_ARCustomerID = 0
                                                                AND GLJournals.FK_HREmployeeID = 0
                                                            )
                                                         )
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                        )
                        GROUP BY
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL

                        -- Co Dau ky
                        SELECT
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        SUM(GLJournals.GLJournalAmt) AS BeginCreditAmt,
                        SUM(GLJournals.GLJournalFAmt) AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        INNER JOIN Objects ON (
                                                            ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            (
                                                                ObjectNo = 'Unknow'
                                                                AND GLJournals.FK_APSupplierID = 0
                                                                AND GLJournals.FK_ARCustomerID = 0
                                                                AND GLJournals.FK_HREmployeeID = 0
                                                            )
                                                         )
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND (  
                            ({1} AND  GLJournalPeriod <> 0) --BeforeStart
                            OR
                            ({3} AND GLJournalPeriod = 0 ) -- Start Fical Year
                            )
                        GROUP BY 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL

                        -- No Phat sinh
                        SELECT
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        SUM(GLJournalAmt) AS DebitAmt,
                        SUM(GLJournalFAmt) AS DebitFAmt,
                        0 AS CreditAmt,
                        0 AS CreditFAmt
                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLDebitAccountID = GLAccounts.GLAccountID
                        INNER JOIN Objects ON (
                                                            ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            (
                                                                ObjectNo = 'Unknow'
                                                                AND GLJournals.FK_APSupplierID = 0
                                                                AND GLJournals.FK_ARCustomerID = 0
                                                                AND GLJournals.FK_HREmployeeID = 0
                                                            )
                                                         )
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND {2}
                        AND GLJournalPeriod <> 0
                        GROUP BY 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel

                        UNION ALL 

                        -- Co phat sinh
                        SELECT
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        0 AS BeginDebitAmt,
                        0 AS BeginDebitFAmt,
                        0 AS BeginCreditAmt,
                        0 AS BeginCreditFAmt,
                        0 AS DebitAmt,
                        0 AS DebitFAmt,
                        SUM(GLJournalAmt)AS CreditAmt,
                        SUM(GLJournalFAmt) AS CreditFAmt

                        FROM
                        GLJournals INNER JOIN GLAccounts ON GLJournals.FK_GLCreditAccountID = GLAccounts.GLAccountID
                        INNER JOIN Objects ON (
                                                            ('Cust' + CAST(GLJournals.FK_ARCustomerID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Sup' + CAST(GLJournals.FK_APSupplierID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            ('Emp' + CAST(GLJournals.FK_HREmployeeID AS nvarchar(50))) = Objects.ObjectID
                                                            OR
                                                            (
                                                                ObjectNo = 'Unknow'
                                                                AND GLJournals.FK_APSupplierID = 0
                                                                AND GLJournals.FK_ARCustomerID = 0
                                                                AND GLJournals.FK_HREmployeeID = 0
                                                            )
                                                         )
                        WHERE
                        GLAccounts.AAStatus = 'Alive'
                        AND GLAccountNo like '{5}%'
                        AND GLAccounts.GLAccountBalanceCombo <> 'NC'
                        AND {2}
                        AND GLJournalPeriod <> 0
                        GROUP BY 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 1
                        -----------------------------------------------------------
                        SELECT * INTO DATA3
                        FROM
                        (
                        select 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data4, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data4.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 2
                        -----------------------------------------------------------
                        SELECT * INTO DATA2
                        FROM
                        (
                        select 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data3, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data3.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp

                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 3
                        -----------------------------------------------------------
                        SELECT * INTO DATA1
                        FROM
                        (
                        select 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data2, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data2.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy về dữ liệu các TK con nhất - 4
                        -----------------------------------------------------------
                        SELECT * INTO DATA0
                        FROM
                        (
                        select 
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID AS AccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel,
                        SUM(BeginDebitAmt) AS BeginDebitAmt,
                        SUM(BeginDebitFAmt) AS BeginDebitFAmt,
                        SUM(BeginCreditAmt) AS BeginCreditAmt,
                        SUM(BeginCreditFAmt) AS BeginCreditFAmt,
                        SUM(DebitAmt) AS DebitAmt,
                        SUM(DebitFAmt) AS DebitFAmt,
                        SUM(CreditAmt) AS CreditAmt,
                        SUM(CreditFAmt) AS CreditFAmt

                        FROM Data1, GLAccounts
                        WHERE 
                        GLAccounts.AAStatus = 'Alive'
                        AND Data1.AccountParentID = GLAccounts.GLAccountID
                        GROUP BY
                        ObjectID, ObjectNo, ObjectName,
                        GLAccounts.GLAccountID,
                        GLAccounts.FK_GLAccountParentID,
                        GLAccounts.GLAccountNo,
                        GLAccounts.GLAccountName,
                        GLAccounts.GLAccountLevel
                        ) AS Temp


                        -----------------------------------------------------------
                        --Lấy View tổng hợp
                        -----------------------------------------------------------
                        SELECT * INTO Data
                        FROM
                        (
                        SELECT * FROM Data4
                        UNION ALL
                        SELECT * FROM Data3
                        UNION ALL
                        SELECT * FROM Data2
                        UNION ALL
                        SELECT * FROM Data1
                        UNION ALL
                        SELECT * FROM Data0
                        ) AS Temp

                        -----------------------------------------------------------
                        --Tính toán cân đối
                        -----------------------------------------------------------
                        SELECT 
                        ObjectID AS ObjectIDRef, ObjectNo, ObjectName,
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        CASE WHEN SUM(BeginDebitAmt) - SUM(BeginCreditAmt) > 0 THEN SUM(BeginDebitAmt) - SUM(BeginCreditAmt) ELSE 0 END AS GLAccountBeginDebitAmt,
                        CASE WHEN SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) > 0 then SUM(BeginDebitFAmt) - SUM(BeginCreditFAmt) ELSE 0 END AS GLAccountBeginDebitFAmt,
                        CASE WHEN SUM(BeginCreditAmt) - SUM(BeginDebitAmt) > 0 then SUM(BeginCreditAmt) - SUM(BeginDebitAmt) ELSE 0 END AS GLAccountBeginCreditAmt,
                        CASE WHEN SUM(BeginCreditFAmt) - SUM(BeginDebitFAmt) > 0 then SUM(BeginCreditFAmt) - SUM(BeginDebitFAmt) ELSE 0 END AS GLAccountBeginCreditFAmt,
                        SUM(DebitAmt) AS GLAccountDebitAmt,
                        SUM(DebitFAmt) AS GLAccountDebitFAmt,
                        SUM(CreditAmt) AS GLAccountCreditAmt,
                        SUM(CreditFAmt) AS GLAccountCreditFAmt,
                        CASE WHEN (SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt)) > 0 
					                        THEN SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt) ELSE 0 END AS GLAccountEndDebitAmt,
                        CASE WHEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) > 0 
					                        THEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) ELSE 0 END AS GLAccountEndDebitFAmt,
                        CASE WHEN SUM(BeginDebitAmt) + SUM(DebitAmt) - SUM(BeginCreditAmt)- SUM(CreditAmt) < 0 
					                        THEN -SUM(BeginDebitAmt) - SUM(DebitAmt) + SUM(BeginCreditAmt)+ SUM(CreditAmt) ELSE 0 END AS  GLAccountEndCreditAmt,
                        CASE WHEN SUM(BeginDebitFAmt) + SUM(DebitFAmt) - SUM(BeginCreditFAmt)- SUM(CreditFAmt) < 0 
					                        THEN -SUM(BeginDebitFAmt) - SUM(DebitFAmt) + SUM(BeginCreditFAmt)+ SUM(CreditFAmt) ELSE 0 END AS GLAccountEndCreditFAmt

                        INTO BANGCANDOI
                        FROM DATA
                        WHERE 
                        GLAccountLevel <= {4}
                        GROUP BY
                        ObjectID, ObjectNo, ObjectName,
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel


                        -----------------------------------------------------------
                        --Tạo bản cân đối
                        -----------------------------------------------------------
                        SELECT 
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel,
                        SUM(GLAccountBeginDebitAmt) AS GLAccountBeginDebitAmt,
                        SUM(GLAccountBeginDebitFAmt) AS GLAccountBeginDebitFAmt,
                        SUM(GLAccountBeginCreditAmt) AS GLAccountBeginCreditAmt,
                        SUM(GLAccountBeginCreditFAmt) AS GLAccountBeginCreditFAmt,
                        SUM(GLAccountDebitAmt) AS GLAccountDebitAmt,
                        SUM(GLAccountDebitFAmt) AS GLAccountDebitFAmt,
                        SUM(GLAccountCreditAmt) AS GLAccountCreditAmt,
                        SUM(GLAccountCreditFAmt) AS GLAccountCreditFAmt,

                        SUM(GLAccountEndDebitAmt) AS GLAccountEndDebitAmt,
                        SUM(GLAccountEndDebitFAmt) AS GLAccountEndDebitFAmt,
                        SUM(GLAccountEndCreditAmt) AS GLAccountEndCreditAmt,
                        SUM(GLAccountEndCreditFAmt) AS GLAccountEndCreditFAmt

                        INTO TrialBalance
                        FROM
                        (
                        SELECT * FROM BANGCANDOI
                        UNION ALl
                        SELECT * FROM BANGCANDOI_LUONGTINH
                        ) AS Temp
                        
                        GROUP BY 
                        ObjectIDRef, ObjectNo, ObjectName,
                        GLAccountID,
                        AccountParentID,
                        GLAccountNo,
                        GLAccountName,
                        GLAccountLevel

                        -----------------------------------------------------------
                        --View bản cân đối
                        -----------------------------------------------------------
                        SELECT * 
                        FROM TrialBalance
                        ORDER BY GLAccountNo
	
                ", strAllRange, strBeforeStart, strInRange, strStartFiscalYear, iLevel, strAccountNo);

            DataSet ds = new DataSet();
            ds.Tables.Add(new DataTable());

            using (TransactionScope tranScope = new TransactionScope())
            {
                GetDataSet(strDeleteTempTable);
                GetDataSet(strDeleteTempTable);
                GetDataSet(strDeleteTempTable);
                ds = GetDataSet(strQuery);
                GetDataSet(strDeleteTempTable);
            }

            return ds;

        }
        public void SetZeroAmtBySubLedgerAndDocNoAndDate(String psSubLedger, String psDocNo, DateTime pdtDocDate)
        {
            String strQuery = String.Format(@"UPDATE GLJournals 
    SET GLJournalAmt = 0,
        GLJournalFAmt = 0
    WHERE GLSourceLedger = '{0}' 
        AND  GLJournalDocumentNo = '{1}'
        AND  CAST(CONVERT(VARCHAR(20), GLJournalDate, 112) AS DATETIME) = '{2}'"
                , psSubLedger, psDocNo, pdtDocDate.ToString("yyyyMMdd"));
            GetDataSet(strQuery);
        }
        public double GetCustEndBalance(int piCustID, DateTime dtTo, int iHomeCurrencyID, int iBranchID, string sExceptDocNo, string sExceptGLSourceLedger)
        {
            DataSet ds = GetEndBalance("AR", dtTo, iHomeCurrencyID, iBranchID, sExceptDocNo, sExceptGLSourceLedger, piCustID, "ARCustomer", true);
            double _dRet = 0;
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                _dRet = Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return _dRet;
        }
        public DataSet GetEndBalance(String strAccountType, DateTime dtTo, int iCurrencyID, int iBranchID, string sExceptDocNo, string sExceptGLSourceLedger, int iObjID, string psObjType, bool pbSum)
        {
            object[] _objParrs = {strAccountType ,
                                    dtTo ,
                                    iCurrencyID ,
                                    iBranchID,
                                    sExceptDocNo,
                                    sExceptGLSourceLedger,
                                    iObjID,
                                    psObjType,
                                    pbSum
                                };
            return SqlDatabaseHelper.RunStoredProcedure("spL_GetEndBalance", _objParrs);
        }
        public DataSet GetDataForExchangeAdjust(String strAccountType, DateTime dtTo, int iHomeCurrencyID, int iBranchID, string sExceptDocNo, string sExceptGLSourceLedger)
        {

            String strQuery = String.Format(@"
DECLARE @ToDate as Datetime
DECLARE @Year as int
DECLARE @HomeCurrency as int
DECLARE @AccType as nvarchar(255)
DECLARE @iBranchID as int
DECLARE @sExceptDocNo as nvarchar(255)
DECLARE @sExceptGLSourceLedger as nvarchar(255)


SET @AccType = '{0}'
SET @ToDate = '{1}'
SET @HomeCurrency = {2}
SET @Year = YEAR(@ToDate)
SET @iBranchID = {3}
SET @sExceptDocNo = '{4}'
SET @sExceptGLSourceLedger = '{5}'

SELECT GLAccountID
	INTO #tAccount
	FROM GLAccounts
	WHERE AAStatus = 'Alive' 
		AND GLAccountTypeCombo IN (@AccType) AND (@AccType <> 'CM' OR GLAccountBalanceCombo NOT IN ('NC'))
        --AND LEFT(GLAccountNo,3) <> '113'


SELECT FK_GLDebitAccountID as FK_GLAccountID
	,FK_GECurrencyID
	,FK_BRBranchID
    ,FK_GLObjectID
	,GLJournalAmt
	,GLJournalFAmt
INTO #tData
	FROM GLJournals a
		INNER JOIN #tAccount b ON a.FK_GLDebitAccountID = b.GLAccountID
	WHERE (GLJournalPeriod = 0 OR GLJournalDate <= @ToDate)
		AND GLJournalYear = @Year
        AND FK_GECurrencyID <> @HomeCurrency
        AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
        AND NOT (GLJournalDocumentNo = @sExceptDocNo AND GLSourceLedger = @sExceptGLSourceLedger)
UNION ALL		
SELECT FK_GLCreditAccountID as FK_GLAccountID
	,FK_GECurrencyID
	,FK_BRBranchID
    ,FK_GLObjectIDCredit as FK_GLObjectID
	,-GLJournalAmt as GLJournalAmt
	,-GLJournalFAmt as GLJournalFAmt
	FROM GLJournals a
		INNER JOIN #tAccount b ON a.FK_GLCreditAccountID = b.GLAccountID
	WHERE (GLJournalPeriod = 0 OR GLJournalDate <= @ToDate)
		AND GLJournalYear = @Year
        AND FK_GECurrencyID <> @HomeCurrency
        AND (FK_BRBranchID = @iBranchID OR @iBranchID = 0)
        AND NOT (GLJournalDocumentNo = @sExceptDocNo AND GLSourceLedger = @sExceptGLSourceLedger)
UPDATE #tData
    SET FK_GLObjectID = 0 
    FROM #tData a
        LEFT JOIN GLAccounts b ON a.FK_GLAccountID = b.GLAccountID AND b.GLAccountTypeCombo IN ('AR','AP')
    WHERE b.GLAccountID is null

SELECT FK_GLAccountID
	,FK_GECurrencyID
	,FK_BRBranchID
    ,FK_GLObjectID
	,SUM(GLJournalAmt) as Amt
	,SUM(GLJournalFAmt) as FAmt
	,CAST(0 as float) as DebitAmt
	,CAST(0 as float) as DebitFAmt
    ,CAST(0 as float) as CreditAmt
	,CAST(0 as float) as CreditFAmt
    ,CAST('Debit' as nvarchar(50)) as GLBalanceTypeCombo
INTO #tKQ
	FROM #tData
	GROUP BY FK_GLAccountID,FK_GECurrencyID,FK_GLObjectID,FK_BRBranchID

DELETE FROM #tKQ 	
    WHERE Amt = 0 AND FAmt = 0

UPDATE #tKQ 
	SET DebitAmt = Amt
	WHERE Amt > 0
UPDATE #tKQ 
	SET DebitFAmt = FAmt
	WHERE FAmt > 0

UPDATE #tKQ 
	SET CreditAmt = ABS(Amt)
        ,GLBalanceTypeCombo = 'Credit'
	WHERE Amt < 0
UPDATE #tKQ 
	SET CreditFAmt = ABS(FAmt)
	WHERE FAmt < 0

UPDATE #tKQ 
	SET Amt = ABS(Amt)
        ,FAmt = ABS(FAmt)

SELECT FK_GECurrencyID 
        ,1 as GECurrencyExcRate
		,CAST(0 as int) as FK_GLProfitAccountID
		,CAST(0 as int) as FK_GLLossAccountID
	INTO #GLExchangeAdjustCurrencyExcs
    FROM #tKQ 
    GROUP BY FK_GECurrencyID 

UPDATE #GLExchangeAdjustCurrencyExcs
	SET FK_GLProfitAccountID = b.FK_GLProfitAccountID
		,FK_GLLossAccountID = b.FK_GLLossAccountID
FROM #GLExchangeAdjustCurrencyExcs a
    INNER JOIN (
                SELECT FK_GECurrencyID
                    ,FK_GLProfitAccountID
                    ,FK_GLLossAccountID
                FROM GLExchangeAdjustCurrencyExcs
                WHERE FK_GLExchangeAdjustID = (SELECT MAX(FK_GLExchangeAdjustID) 
                        FROM GLExchangeAdjustCurrencyExcs
                        WHERE AAStatus = 'Alive' AND FK_GLProfitAccountID > 0 AND FK_GLLossAccountID > 0)
              ) as b ON a.FK_GECurrencyID = b.FK_GECurrencyID
			  
SELECT *
	FROM #GLExchangeAdjustCurrencyExcs
SELECT *
	FROM #tKQ
	
DROP TABLE #GLExchangeAdjustCurrencyExcs
DROP TABLE #tKQ
DROP TABLE #tAccount
DROP TABLE #tData
", strAccountType, dtTo.ToString("yyyyMMdd"), iHomeCurrencyID, iBranchID,sExceptDocNo,sExceptGLSourceLedger);

            DataSet ds = GetDataSet(strQuery);

            return ds;
        }
        public DataSet GetJournalForRevert(string psKey)
        {

            String strQuery = String.Format(@"
SELECT a.* 
    INTO #tKQ
    FROM GLJournals a 
        INNER JOIN ({0}) as b ON a.GLJournalID = b.GLJournalID

SELECT * 
    FROM #tKQ

SELECT cast(0 as bit) as AASelected
        ,GLJournalNo,GLJournalDate
        ,GLSourceLedger
        ,MAX(GLJournalHDesc) as GLJournalHDesc
    FROM #tKQ
    GROUP BY GLJournalNo,GLJournalDate,GLSourceLedger
DROP TABLE #tKQ
", psKey);

            DataSet ds = GetDataSet(strQuery);

            return ds;
        }
    }
	#endregion
}