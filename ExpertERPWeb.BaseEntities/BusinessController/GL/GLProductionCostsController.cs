using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region GLProductionCosts
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:GLProductionCostsController
	//Created Date:14 March 2013
	//-----------------------------------------------------------
	
	public class GLProductionCostsController:BaseBusinessController
	{
		public GLProductionCostsController()
		{
			dal= new DALBaseProvider("GLProductionCosts",typeof(GLProductionCostsInfo));
		}

        public DataSet GetAllDocsForCalcProductionCost(DateTime dtFrom, DateTime dtTo)
        {
            String strReceiptDateCond = DALUtil.GenerateBeetween("ICReceiptDate", dtFrom, dtTo);
            String strShipmentDateCond = DALUtil.GenerateBeetween("ICShipmentDate", dtFrom, dtTo);
            String strTransferDateCond = DALUtil.GenerateBeetween("ICTransferDate", dtFrom, dtTo);
            String strProductionOrdrDateCond = DALUtil.GenerateBeetween("PPProductionOrdrDate", dtFrom, dtTo);
            String strAdjInvDateCond = DALUtil.GenerateBeetween("ICAdjInvDate", dtFrom, dtTo);

            String strQuery = String.Format(@"SELECT * FROM
                                            (
                                            SELECT 
                                            'Receipt' AS DoctType,
                                            ICReceiptDate AS DocDate,
                                            ICReceiptNo AS DocNo
                                            FROM dbo.ICReceipts
                                            WHERE AAStatus = 'Alive'                        
                                            AND {0}

                                            UNION ALL

                                            SELECT 
                                            'Shipment' AS DoctType,
                                            ICShipmentDate AS DocDate,
                                            ICShipmentNo AS DocNo
                                            FROM dbo.ICShipments
                                            WHERE AAStatus = 'Alive'
                                            AND {1}


                                            UNION ALL

                                            SELECT 
                                            'Transfer' AS DoctType,
                                            ICTransferDate AS DocDate,
                                            ICTransferNo AS DocNo
                                            FROM dbo.ICTransfers
                                            WHERE AAStatus = 'Alive'
                                            AND {2}

                                            UNION ALL

                                            SELECT 
                                            'AdjInv' AS DoctType,
                                            ICAdjInvDate AS DocDate,
                                            ICAdjInvNo AS DocNo
                                            FROM dbo.ICAdjInvs
                                            WHERE AAStatus = 'Alive'
                                            AND {3}

                                            UNION ALL

                                            SELECT 
                                            'ProductionOrdr' AS DoctType,
                                            PPProductionOrdrDate AS DocDate,
                                            PPProductionOrdrNo AS DocNo
                                            FROM dbo.PPProductionOrdrs
                                            WHERE AAStatus = 'Alive'
                                            AND {4}
                                            ) AS Temp

                                            ORDER BY DocDaTe", strReceiptDateCond, strShipmentDateCond, 
                                                             strTransferDateCond, strAdjInvDateCond, 
                                                             strProductionOrdrDateCond);

            return GetDataSet(strQuery);
        }

        public void DeleteAllDataInPeriod(int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"DELETE GLProductionCosts WHERE Period = {0} AND Year = {1}", iPeriod, iYear);
            GetDataSet(strQuery);
        }

        public DataSet GetAllPreviousProductionCosts(int iPeriod, int iYear)
        {
            DateTime dt = new DateTime(iYear, iPeriod, 1);
            dt = dt.AddMonths(-1);

            String strQuery = String.Format(@"SELECT * FROM GLProductionCosts
                                                WHERE Period = {0} AND Year = {1}", dt.Month, dt.Month);

            return GetDataSet(strQuery);
        }

        public DataSet GetAllCostInPeriod(int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"
                                                SELECT *
                                                FROM dbo.GLProductionCosts
                                                WHERE 
                                                Period = {0}
                                                AND Year = {1}", iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetSummaryForAccountAndStock(int iPeriod, int iYear)
        {
            String strQuery = String.Format(@"SELECT 
                                                FK_GLAccountID AS AccountID,
                                                FK_ICStockID AS StockID,
                                                SUM(Amt) AS Amt
                                                FROM GLProductionCosts
                                                WHERE 
                                                Period = {0}
                                                AND Year = {1}
                                                GROUP BY 
                                                FK_GLAccountID,
                                                FK_ICStockID
                                                ", iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetSummaryForStock(int iStockID, int iPeriod, int iYear)
        {
            String strQuery = String.Format(@"SELECT 
                                                FK_ICProductID AS ProductID,
                                                SUM(Amt) AS Amt
                                                FROM GLProductionCosts
                                                WHERE 
                                                FK_ICStockID = {0}
                                                AND Period = {1}
                                                AND Year = {2}
                                                GROUP BY 
                                                FK_ICProductID
                                                ", iStockID, iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetSummaryCostConsolidateForStock(int iStockID, int iPeriod, int iYear)
        {
            String strQuery = String.Format(@" SELECT FK_ICStockID, SUM(LaborAmt) AS LaborAmt, SUM(OverheadAmt) AS OverheadAmt, SUM(InComplete) AS InComplete,SUM(IndirectRMAmt) AS IndirectRMAmt
                                        FROM
                                        (
                                        SELECT FK_ICStockID, SUM(PPCostConsolidateAmt) AS LaborAmt, 0 AS OverheadAmt, 0 AS InComplete, 0 AS IndirectRMAmt FROM dbo.PPCostConsolidates
                                        WHERE PPYear = {1} AND PPPeriod = {2}
                                        AND FK_ICStockID = {0}
                                        AND FK_PPProductionCostFactorID IN (
                                                                                SELECT PPProductionCostFactorID FROM dbo.PPProductionCostFactors
                                                                                WHERE AAStatus='Alive'
                                                                                AND PPProductionCostFactorTypeCombo = 'Labor'
                                                                            )
                                        GROUP BY FK_ICStockID

                                        UNION ALL

                                        SELECT FK_ICStockID, 0 AS LaborAmt, SUM(PPCostConsolidateAmt) AS OverheadAmt, 0 AS InComplete,0 AS IndirectRMAmt FROM dbo.PPCostConsolidates
                                        WHERE PPYear = {1} AND PPPeriod = {2}
                                        AND FK_ICStockID = {0}
                                        AND FK_PPProductionCostFactorID IN (
                                                                                SELECT PPProductionCostFactorID FROM dbo.PPProductionCostFactors
                                                                                WHERE AAStatus='Alive'
                                                                                AND PPProductionCostFactorTypeCombo = 'Overhead'
                                                                            )
                                        GROUP BY FK_ICStockID
                                        
                                        UNION ALL

                                        SELECT FK_ICStockID, 0 AS LaborAmt, 0 AS OverheadAmt, SUM(PPCostConsolidateAmt) AS InComplete,0 AS IndirectRMAmt FROM dbo.PPCostConsolidates
                                        WHERE PPYear = {1} AND PPPeriod = {2}
                                        AND FK_ICStockID = {0}
                                        AND PPCostTypeCombo LIKE 'InComplete'
                                        GROUP BY FK_ICStockID

                                        UNION ALL

                                        SELECT FK_ICStockID, 0 AS LaborAmt, 0 AS OverheadAmt, 0 AS InComplete, SUM(PPCostConsolidateAmt) AS IndirectRMAmt FROM dbo.PPCostConsolidates
                                        WHERE PPYear = {1} AND PPPeriod = {2}
                                        AND FK_ICStockID = {0}
                                       AND FK_PPProductionCostFactorID IN (
                                                                                SELECT PPProductionCostFactorID FROM dbo.PPProductionCostFactors
                                                                                WHERE AAStatus='Alive'
                                                                                AND PPProductionCostFactorTypeCombo = 'RM'
                                                                            )
                                        GROUP BY FK_ICStockID
                                        ) AS TB
                                        GROUP BY TB.FK_ICStockID", iStockID, iYear, iPeriod);
            return GetDataSet(strQuery);
        }


        public double GetSumCost(int iStockID, int iProductID, int iPeriod, int iYear)
        {
            String strQuery = String.Format(@"SELECT 
                                                SUM(Amt) AS Amt
                                                FROM GLProductionCosts
                                                WHERE 
                                                Period = {0}
                                                AND Year = {1}
                                                AND FK_ICStockID = {2}
                                                AND FK_ICProductID = {3}
                                                ", iPeriod, iYear, iStockID, iProductID );
            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;
        }

        public DataSet GetAllCostInPeriod(int iStockID, int iProductID, int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"
                                                SELECT *
                                                FROM dbo.GLProductionCosts
                                                WHERE 
                                                FK_ICProductID = {0}
                                                AND FK_ICStockID = {1}
                                                AND Period = {2}
                                                AND Year = {3}", iProductID, iStockID, iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetAllCostInPeriod(int iStockID, int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"
                                                SELECT *
                                                FROM dbo.GLProductionCosts
                                                WHERE 
                                                FK_ICStockID = {0}
                                                AND Period = {1}
                                                AND Year = {2}", iStockID, iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public double GetSumAmtInPeriod(int iStockID, int iProductID, int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"
                                                SELECT SUM(Amt)
                                                FROM dbo.GLProductionCosts
                                                WHERE 
                                                FK_ICProductID = {0}
                                                AND FK_ICStockID = {1}
                                                AND Period = {2}
                                                AND Year = {3}", iProductID, iStockID, iPeriod, iYear);
            DataSet ds = GetDataSet(strQuery);

            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;
        }

        public GLProductionCostsInfo GetCostInPeriod(int iStockID, int iProductID, int iAccountID, int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"
                                                SELECT *
                                                FROM dbo.GLProductionCosts
                                                WHERE 
                                                FK_ICProductID = {0}
                                                AND FK_ICStockID = {1}
                                                AND FK_GLAccountID = {2}
                                                AND Period = {3}
                                                AND Year = {4}", iProductID, iStockID, iAccountID, iPeriod, iYear);
            DataSet ds = GetDataSet(strQuery);

            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                return (GLProductionCostsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);

            return null;
        }
	}
	#endregion
}