using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
    #region GLVoucherTransactionItems
    //-----------------------------------------------------------
    //Generated By: GMC Studio
    //Class:GLVoucherTransactionItemsController
    //Created Date:Thursday, November 8, 2012
    //-----------------------------------------------------------

    public class GLVoucherTransactionItemsController : BaseBusinessController
    {
        public enum ObjectType
        {
            Invoice = 0,
            PInvoice = 1,
            APCreditNote = 2,
            PO = 3,
            Voucher = 4,
            ARCreditNote = 5
        }

        public GLVoucherTransactionItemsController()
        {
            dal = new DALBaseProvider("GLVoucherTransactionItems", typeof(GLVoucherTransactionItemsInfo));
        }

        public Double GetSumFPmtByObject(ObjectType type, int iObjectID)
        {
            String strQuery = String.Format(@"SELECT SUM(GLVoucherTransactionItemFPmtAmt)
                                                    FROM GLVoucherTransactionItems WHERE AAStatus = 'Alive'");
            if (type == ObjectType.Invoice)
                strQuery += String.Format(" AND FK_ARInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.PInvoice)
                strQuery += String.Format(" AND FK_APPInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.APCreditNote)
                strQuery += String.Format(" AND FK_APCreditNoteID = {0}", iObjectID);
            else if (type == ObjectType.PO)
                strQuery += String.Format(" AND FK_APPOID = {0}", iObjectID);
            else if (type == ObjectType.Voucher)
                strQuery += String.Format(" AND FK_GLVoucherID = {0}", iObjectID);
            else if (type == ObjectType.ARCreditNote)
                strQuery += String.Format(" AND FK_ARCreditNoteID = {0}", iObjectID);

            DataSet ds = GetDataSet(strQuery);

            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;


        }

        public Double GetSumFPmtByObject(ObjectType type, int iObjectID, int iVoucherID)
        {
            String strQuery = String.Format(@"SELECT SUM(GLVoucherTransactionItemFPmtAmt)
                                                    FROM GLVoucherTransactionItems WHERE AAStatus = 'Alive' AND FK_GLVoucherID={0})", iVoucherID);
            if (type == ObjectType.Invoice)
                strQuery += String.Format(" AND FK_ARInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.PInvoice)
                strQuery += String.Format(" AND FK_APPInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.APCreditNote)
                strQuery += String.Format(" AND FK_APCreditNoteID = {0}", iObjectID);
            else if (type == ObjectType.PO)
                strQuery += String.Format(" AND FK_APPOID = {0}", iObjectID);
            else if (type == ObjectType.Voucher)
                strQuery += String.Format(" AND FK_GLVoucherID = {0}", iObjectID);
            else if (type == ObjectType.ARCreditNote)
                strQuery += String.Format(" AND FK_ARCreditNoteID = {0}", iObjectID);

            DataSet ds = GetDataSet(strQuery);

            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0
                && ds.Tables[0].Rows[0][0] != null && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;
        }

        public DataSet GetAllTransactionItemsByObject(VoucherType voucherType, ObjectType type, int iObjectID)
        {
            String strQuery = String.Format(@"SELECT *
                                                    FROM GLVoucherTransactionItems WHERE AAStatus = 'Alive'");
            if (type == ObjectType.Invoice)
                strQuery += String.Format(" AND FK_ARInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.PInvoice)
                strQuery += String.Format(" AND FK_APPInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.APCreditNote)
                strQuery += String.Format(" AND FK_APCreditNoteID = {0}", iObjectID);
            else if (type == ObjectType.PO)
                strQuery += String.Format(" AND FK_APPOID = {0}", iObjectID);
            else if (type == ObjectType.Voucher)
                strQuery += String.Format(" AND FK_GLPaymentVoucherID = {0}", iObjectID);
            else if (type == ObjectType.ARCreditNote)
                strQuery += String.Format(" AND FK_ARCreditNoteID = {0}", iObjectID);

            if (voucherType == VoucherType.InPmt)
                strQuery += String.Format(@" AND FK_GLVoucherID IN (SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'InPmt'
            UNION ALL SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo IN ('Voucher','VoucherOrg') AND FK_ARCustomerID > 0)");
            else if (voucherType == VoucherType.OutPmt)
                strQuery += String.Format(@" AND FK_GLVoucherID IN (SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'OutPmt'
            UNION ALL SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo IN ('Voucher','VoucherOrg') AND FK_APSupplierID > 0)");
            else if (voucherType == VoucherType.PmtReq)
                strQuery += String.Format(@" AND FK_GLVoucherID IN (SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'PmtReq')");

            return GetDataSet(strQuery);

        }

        public DataSet GetAllTransactionItemsByObject(VoucherType voucherType, ObjectType type, int iObjectID, DateTime dtObjectDate)
        {
            String strDate = DALUtil.GennerateCondition("GLVoucherDate", CompareType.LessEqualThan, dtObjectDate);
            String strQuery = String.Format(@"SELECT *
                                                    FROM GLVoucherTransactionItems WHERE AAStatus = 'Alive'");
            if (type == ObjectType.Invoice)
                strQuery += String.Format(" AND FK_ARInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.PInvoice)
                strQuery += String.Format(" AND FK_APPInvoiceID = {0}", iObjectID);
            else if (type == ObjectType.APCreditNote)
                strQuery += String.Format(" AND FK_APCreditNoteID = {0}", iObjectID);
            else if (type == ObjectType.PO)
                strQuery += String.Format(" AND FK_APPOID = {0}", iObjectID);
            else if (type == ObjectType.Voucher)
                strQuery += String.Format(" AND FK_GLPaymentVoucherID = {0}", iObjectID);
            else if (type == ObjectType.ARCreditNote)
                strQuery += String.Format(" AND FK_ARCreditNoteID = {0}", iObjectID);

            if (voucherType == VoucherType.InPmt)
                strQuery += String.Format(@" AND FK_GLVoucherID IN (SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'InPmt' AND {0} 
            UNION ALL SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'Voucher' AND {0} AND FK_ARCustomerID > 0)", strDate);
            else if (voucherType == VoucherType.OutPmt)
                strQuery += String.Format(@" AND FK_GLVoucherID IN (SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'OutPmt' AND {0} 
            UNION ALL SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'Voucher' AND {0} AND FK_APSupplierID > 0)", strDate);
            else if (voucherType == VoucherType.PmtReq)
                strQuery += String.Format(@" AND FK_GLVoucherID IN (SELECT GLVoucherID FROM GLVouchers WHERE AAStatus = 'Alive' AND GLVoucherTypeCombo = 'PmtReq' AND {0} )", strDate);

            return GetDataSet(strQuery);

        }


        public GLVoucherTransactionItemsInfo GetObjectByVoucherAndObjectType(int iVoucherID, ObjectType objectType, int iObjectID)
        {
            String strQuery = String.Format(@"SELECT *
                                                    FROM GLVoucherTransactionItems WHERE AAStatus = 'Alive' AND FK_GLVoucherID={0}", iVoucherID);
            if (objectType == ObjectType.Invoice)
                strQuery += String.Format(" AND FK_ARInvoiceID = {0}", iObjectID);
            else if (objectType == ObjectType.PInvoice)
                strQuery += String.Format(" AND FK_APPInvoiceID = {0}", iObjectID);
            else if (objectType == ObjectType.APCreditNote)
                strQuery += String.Format(" AND FK_APCreditNoteID = {0}", iObjectID);
            else if (objectType == ObjectType.PO)
                strQuery += String.Format(" AND FK_APPOID = {0}", iObjectID);
            else if (objectType == ObjectType.Voucher)
                strQuery += String.Format(" AND FK_GLPaymentVoucherID = {0}", iObjectID);
            else if (objectType == ObjectType.ARCreditNote)
                strQuery += String.Format(" AND FK_ARCreditNoteID = {0}", iObjectID);

            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                return (GLVoucherTransactionItemsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            return null;
        }

        public DataSet GetDataByVoucherID(int iGLVoucherID)
        {
            string strQuery = string.Format(@"SELECT * FROM GLVoucherTransactionItems WHERE  FK_GLVoucherID={0} AND AAStatus='Cancel'", iGLVoucherID);
            return GetDataSet(strQuery);
        }

        public DataSet GetAPCleanDebtData(DateTime dtFrom, DateTime dtTo, int iAccID, int iSuppID, int iCurrID)
        {
            string strQuery = string.Format(@"
--(PInvoice - Voucher (OutPmt)
SELECT a.* 
INTO #tKQ
FROM GLVoucherTransactionItems a
    INNER JOIN APPInvoices b ON a.FK_APPInvoiceID = b.APPInvoiceID
        AND b.AAStatus = 'Alive'
        AND b.AAPostStatus = 'Post'
    INNER JOIN GLVouchers c ON a.FK_GLVoucherID = c.GLVoucherID
        AND c.AAStatus = 'Alive'
        AND c.AAPostStatus = 'Post'
    INNER JOIN GLAccounts d ON a.FK_GLDebitAccountID = d.GLAccountID
    INNER JOIN GLAccounts e ON a.FK_GLCreditAccountID = e.GLAccountID
WHERE a.AAStatus = 'Alive' 
    AND (b.APPInvoiceDate BETWEEN '{0}' AND '{1}' OR c.GLVoucherDate BETWEEN '{0}' AND '{1}')
    AND (b.FK_APSupplierID = {2} OR 0 = {2})
    AND (a.FK_GECurrencyID = {3} OR 0 = {3})
    AND (d.GLAccountTypeCombo = 'AP' OR e.GLAccountTypeCombo = 'AP')
    AND (d.GLAccountID = {4} OR e.GLAccountID = {4} OR {4} = 0)
--)
UNION
--(Invoice - Agency - CLV
SELECT a.* 
FROM GLVoucherTransactionItems a
    INNER JOIN ARInvoices b ON a.FK_ARInvoiceID = b.ARInvoiceID
        AND b.AAStatus = 'Alive'
        AND b.AAPostStatus = 'Post'
    INNER JOIN GLVouchers c ON a.FK_GLVoucherID = c.GLVoucherID
        AND c.AAStatus = 'Alive'
        AND c.AAPostStatus = 'Post'
    INNER JOIN GLAccounts d ON a.FK_GLDebitAccountID = d.GLAccountID
    INNER JOIN GLAccounts e ON a.FK_GLCreditAccountID = e.GLAccountID
WHERE a.AAStatus = 'Alive' 
    AND (b.ARInvoiceDate BETWEEN '{0}' AND '{1}' OR c.GLVoucherDate BETWEEN '{0}' AND '{1}')
    AND (b.FK_APSupplierID = {2} OR 0 = {2})
    AND (a.FK_GECurrencyID = {3} OR 0 = {3})
    AND (d.GLAccountTypeCombo = 'AP' OR e.GLAccountTypeCombo = 'AP')
    AND (d.GLAccountID = {4} OR e.GLAccountID = {4} OR {4} = 0)
UNION
--(PKT - PKT
SELECT a.* 
FROM GLVoucherTransactionItems a
    INNER JOIN GLVoucherItems t ON a.FK_GLDebitVoucherItemID = t.GLVoucherItemID
        AND t.AAStatus = 'Alive'
    INNER JOIN GLVouchers b ON t.FK_GLVoucherID = b.GLVoucherID
        AND b.AAStatus = 'Alive'
        AND b.AAPostStatus = 'Post'
    INNER JOIN GLVoucherItems u ON a.FK_GLVoucherItemID = u.GLVoucherItemID
        AND u.AAStatus = 'Alive'
    INNER JOIN GLVouchers c ON u.FK_GLVoucherID = c.GLVoucherID
        AND c.AAStatus = 'Alive'
        AND c.AAPostStatus = 'Post'
    INNER JOIN GLAccounts d ON a.FK_GLDebitAccountID = d.GLAccountID
    INNER JOIN GLAccounts e ON a.FK_GLCreditAccountID = e.GLAccountID
WHERE a.AAStatus = 'Alive' 
    AND (b.GLVoucherDate BETWEEN '{0}' AND '{1}' OR c.GLVoucherDate BETWEEN '{0}' AND '{1}')
    AND (t.FK_ARCustomerID = {2} OR 0 = {2})
    AND (a.FK_GECurrencyID = {3} OR 0 = {3})
    AND (d.GLAccountTypeCombo = 'AP' OR e.GLAccountTypeCombo = 'AP')
    AND (d.GLAccountID = {4} OR e.GLAccountID = {4} OR {4} = 0)

UPDATE #tKQ SET AASelected = 0
SELECT * FROM #tKQ
    ", dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"), iSuppID, iCurrID, iAccID);
            return GetDataSet(strQuery);
        }

        public DataSet GetARCleanDebtData(DateTime dtFrom, DateTime dtTo, int iAccID, int iCustID, int iCurrID, int iEmpID, ARCustomersInfo objARCustomer, String strModule)
        {
            ARCustomersController objARCustomersCtrl = new ARCustomersController();
            String sKeyCustomer = string.Empty;//objARCustomersCtrl.GenKeyCustomerByOCode(iCustID, objARCustomer, "ARInvoices.FK_ARCustomerID", strModule, false);

            string strQuery = string.Format(@"
--(Invoice - Voucher (InPmt)
SELECT a.* 
INTO #tKQ
FROM GLVoucherTransactionItems a
    INNER JOIN ARInvoices b ON a.FK_ARInvoiceID = b.ARInvoiceID
        AND b.AAStatus = 'Alive'
        AND b.AAPostStatus = 'Post'
    INNER JOIN GLVouchers c ON a.FK_GLVoucherID = c.GLVoucherID
        AND c.AAStatus = 'Alive'
        AND c.AAPostStatus = 'Post'
    INNER JOIN GLAccounts d ON a.FK_GLDebitAccountID = d.GLAccountID
    INNER JOIN GLAccounts e ON a.FK_GLCreditAccountID = e.GLAccountID
WHERE a.AAStatus = 'Alive' 
    AND (b.ARInvoiceDate BETWEEN '{0}' AND '{1}' OR c.GLVoucherDate BETWEEN '{0}' AND '{1}')
    AND (b.FK_ARCustomerID = {2} OR 0 = {2})
    AND (a.FK_HREmployeeID = {5} OR 0 = {5})
    AND (a.FK_GECurrencyID = {3} OR 0 = {3})
    AND (d.GLAccountTypeCombo = 'AR' OR e.GLAccountTypeCombo = 'AR')
    AND (d.GLAccountID = {4} OR e.GLAccountID = {4} OR {4} = 0)
    {6}
--)
UNION 
--(PKT - PKT
SELECT a.* 
FROM GLVoucherTransactionItems a
    INNER JOIN GLVoucherItems t ON a.FK_GLCreditVoucherItemID = t.GLVoucherItemID
        AND t.AAStatus = 'Alive'
    INNER JOIN GLVouchers b ON t.FK_GLVoucherID = b.GLVoucherID
        AND b.AAStatus = 'Alive'
        AND b.AAPostStatus = 'Post'
    INNER JOIN GLVoucherItems u ON a.FK_GLVoucherItemID = u.GLVoucherItemID
        AND u.AAStatus = 'Alive'
    INNER JOIN GLVouchers c ON u.FK_GLVoucherID = c.GLVoucherID
        AND c.AAStatus = 'Alive'
        AND c.AAPostStatus = 'Post'
    INNER JOIN GLAccounts d ON a.FK_GLDebitAccountID = d.GLAccountID
    INNER JOIN GLAccounts e ON a.FK_GLCreditAccountID = e.GLAccountID
WHERE a.AAStatus = 'Alive' 
    AND (b.GLVoucherDate BETWEEN '{0}' AND '{1}' OR c.GLVoucherDate BETWEEN '{0}' AND '{1}')
    AND (t.FK_ARCustomerID = {2} OR 0 = {2})
    AND (t.FK_HREmployeeID = {5} OR 0 = {5})
    AND (a.FK_GECurrencyID = {3} OR 0 = {3})
    AND (d.GLAccountTypeCombo = 'AR' OR e.GLAccountTypeCombo = 'AR')
    AND (d.GLAccountID = {4} OR e.GLAccountID = {4} OR {4} = 0)
    {7}
UPDATE #tKQ SET AASelected = 0
SELECT * FROM #tKQ
    ", dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"), iCustID, iCurrID, iAccID, iEmpID, sKeyCustomer.Replace("ARInvoices", "b"), sKeyCustomer.Replace("ARInvoices", "t"));
            return GetDataSet(strQuery);
        }

        public DataSet GetAllDataByGLVoucherItemIDOfVoucherID(int piGLVoucherID)
        {
            string strQuery = string.Format(@"
SELECT a.* 
    FROM GLVoucherTransactionItems a
        INNER JOIN GLVoucherItems b ON a.FK_GLVoucherItemID = b.GLVoucherItemID AND a.AAStatus = 'Alive'
        INNER JOIN GLVouchers c ON b.FK_GLVoucherID = c.GLVoucherID AND c.AAStatus = 'Alive'
            AND c.GLVoucherID = {0}
", piGLVoucherID);
            return GetDataSet(strQuery);
        }
    }
}
	#endregion
