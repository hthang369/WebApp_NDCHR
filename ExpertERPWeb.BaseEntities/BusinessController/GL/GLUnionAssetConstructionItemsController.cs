using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region GLUnionAssetConstructionItems
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:GLUnionAssetConstructionItemsController
	//Created Date:Saturday, March 21, 2015
	//-----------------------------------------------------------
	
	public class GLUnionAssetConstructionItemsController:BaseBusinessController
	{
		public GLUnionAssetConstructionItemsController()
		{
			dal= new DALBaseProvider("GLUnionAssetConstructionItems",typeof(GLUnionAssetConstructionItemsInfo));
		}

        /// <summary>
        /// Lấy danh sách Journal chưa được tập hợp hết XDCB
        /// </summary>
        /// <param name="strAccountType"></param>
        /// <returns></returns>
        public DataSet GetAllDataInJournalByDebitAccountTypeGroupByAssetConstruction(string strAccountType)
        {
            string strQuery = string.Format(@"SELECT  SUM(GLUnionAssetConstructionItems.GLUnionAssetConstructionItemUnionAmt) as GLUnionAssetConstructionItemJournalUnionAmt,
                                                      SUM(GLUnionAssetConstructionItems.GLUnionAssetConstructionItemUnionFAmt) as GLUnionAssetConstructionItemJournalUnionFAmt,
                                                        dbo.GLJournals.GLJournalID as FK_GLJournalID,
                                                        dbo.GLJournals.FK_GLDebitAccountID as FK_GLJournalDebitAccountID,
                                                        dbo.GLJournals.FK_FAAssetConstructionID ,
                                                        GLJournals.GLJournalAmt as GLUnionAssetConstructionItemJournalAmt,
                                                        dbo.GLJournals.GLJournalFAmt as GLUnionAssetConstructionItemJournalFAmt
                                                FROM    dbo.GLAccounts
                                                        INNER JOIN dbo.GLJournals ON dbo.GLJournals.FK_GLDebitAccountID = dbo.GLAccounts.GLAccountID
                                                                                     AND dbo.GLAccounts.AAStatus = 'Alive'
                                                                                     AND dbo.GLAccounts.GLAccountTypeCombo = '{0}'
                                                        LEFT JOIN dbo.GLUnionAssetConstructionItems ON GLUnionAssetConstructionItems.FK_GLJournalID = GLJournals.GLJournalID
                                                                                                       AND GLUnionAssetConstructionItems.AAStatus = 'Alive'
                                                GROUP BY dbo.GLJournals.GLJournalID ,
                                                        dbo.GLJournals.FK_GLDebitAccountID ,
                                                        dbo.GLJournals.FK_FAAssetConstructionID ,
                                                        GLJournals.GLJournalAmt ,
                                                        dbo.GLJournals.GLJournalFAmt
                                                HAVING    SUM(GLUnionAssetConstructionItems.GLUnionAssetConstructionItemUnionAmt) IS NULL
                                                            OR  (GLJournals.GLJournalAmt - SUM(GLUnionAssetConstructionItems.GLUnionAssetConstructionItemUnionAmt) )>0"
                , strAccountType);
            return dal.GetDataSet(strQuery);
        }

        public void UpdateForeignKeyJounalToNullWhenDelete(int iUnionAssetConstructionID)
        {
            string strQuery = string.Format(@"Update GLUnionAssetConstructionItems set FK_GLJournalID=NULL where FK_GLUnionAssetConstructionID={0} AND AAStatus='Delete'"
                                , iUnionAssetConstructionID);
            dal.GetDataSet(strQuery);
        }

     
	}
	#endregion
}