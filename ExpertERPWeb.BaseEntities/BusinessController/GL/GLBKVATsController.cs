using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region GLBKVATs
	//-----------------------------------------------------------
	//Generated By: Expert Studio
	//Class:GLBKVATsController
	//Created Date:Tuesday, June 14, 2011
	//-----------------------------------------------------------
	
	public class GLBKVATsController:BaseBusinessController
	{
		public GLBKVATsController()
		{
			dal= new DALBaseProvider("GLBKVATs",typeof(GLBKVATsInfo));
		}

        public void DeleteObjectInTimeSpan(DateTime fromDate, DateTime toDate)
        {
            string strQuery = string.Format("delete from GLBKVATs where GLBKVATDate >= '{0}' and  GLBKVATDate <= '{1}'",
                String.Format("{0:yyyy/M/d HH:mm:ss}", fromDate),
                String.Format("{0:yyyy/M/d HH:mm:ss}", toDate));
            dal.GetDataSet(strQuery);
        }

        public DataSet GetAllDataByJournalDateAndAccountID(DateTime fromDate, DateTime toDate, String strType)
        {
            String strDateCond = DALUtil.GenerateBeetween("GLJournalDate", fromDate, toDate);

            string query = String.Format(@"SELECT
	                                            GLBKVATNo,
	                                            GLBKVATDesc,
	                                            GLPeriod,
	                                            GLYear,
	                                            GLBKVATDate,
	                                            GLBKVATType,
	                                            GLBKVATInvNo,
	                                            GLBKVATInvSerie,
	                                            GLBKVATInvDate,
	                                            SUM(GLBKVATItemTotAmt) AS GLBKVATItemTotAmt,
	                                            GLBKVATPct,
	                                            SUM(GLBKVATAmt) AS GLBKVATAmt,
	                                            GLBKVATObjectName,
	                                            GLBKVATObjectAddress,
	                                            GLBKVATObjectTaxNo,
	                                            GLBKVATInvItemDesc
                                            FROM
	                                            (
	                                            SELECT 
		                                            Journal.GLJournalNo AS GLBKVATNo,
		                                            Journal.GLJournalHDesc AS GLBKVATDesc,
		                                            Journal.GLJournalPeriod AS GLPeriod,
		                                            Journal.GLJournalYear AS GLYear,
		                                            Journal.GLJournalDate AS GLBKVATDate,
		                                            '{1}' AS GLBKVATType,
		                                            Journal.GLJournalInvNo AS GLBKVATInvNo,
		                                            Journal.GLJournalInvSerie AS GLBKVATInvSerie,
		                                            Journal.GLJournalInvDate AS GLBKVATInvDate,
		                                            Journal.GLJournalAmt AS GLBKVATItemTotAmt,
		                                            ISNULL((SELECT TXTaxCodePct FROM TXTaxCodes WHERE AAStatus='Alive' AND Journal.FK_TXTaxCodeID = TXTaxCodeID),0) AS GLBKVATPct,
		                                            (Journal.GLJournalAmt * ISNULL((SELECT TXTaxCodePct FROM TXTaxCodes WHERE AAStatus='Alive' AND Journal.FK_TXTaxCodeID = TXTaxCodeID),0) / 100) AS GLBKVATAmt,
		                                            ISNULL(NULLIF(Journal.GLJournalObjectName,''), ISNULL((SELECT HREmployeeName FROM dbo.HREmployees WHERE AAStatus='Alive' AND HREmployeeID = Journal.FK_HREmployeeID),'')) AS GLBKVATObjectName,
		                                            ISNULL(NULLIF(Journal.GLJournalObjectAdd,''), ISNULL((SELECT HREmployeePermanentAddressStreet FROM dbo.HREmployees WHERE AAStatus='Alive' AND HREmployeeID = Journal.FK_HREmployeeID),'')) AS GLBKVATObjectAddress,
		                                            Journal.GLJournalObjectTaxCode AS GLBKVATObjectTaxNo,
		                                            ISNULL((SELECT ICProductName FROM dbo.ICProducts WHERE AAStatus='Alive' AND Journal.FK_ICProductID = ICProductID), Journal.GLJournalDesc) AS GLBKVATInvItemDesc
		
	                                            FROM dbo.GLJournals Journal
	                                            WHERE (	
			                                            Journal.FK_GLDebitAccountID IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND GLAccountID NOT IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND (GLAccountNo LIKE '1331%' OR GLAccountNo LIKE '3331%') )) 
			                                            AND 
			                                            Journal.FK_GLCreditAccountID IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND GLAccountID NOT IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND (GLAccountNo LIKE '1331%' OR GLAccountNo LIKE '3331%') ))
                                                       )
                                                       AND Journal.FK_TXTaxCodeID IN (SELECT TXTaxCodeID FROM TXTaxCodes WHERE AAStatus='Alive' AND TXTaxCodeTypeCombo LIKE '{1}')
                                                       AND Journal.GLJournalInvNo <> ''
                                                       AND Journal.GLJournalInvSerie <> ''
                                                       AND Journal.GLJournalInvDate <> ''
                                                       AND {0}
	                                            ) AS TB
	                                            GROUP BY GLBKVATNo,	GLBKVATDesc, GLPeriod, GLYear, GLBKVATDate, GLBKVATType, GLBKVATInvNo, GLBKVATInvSerie, GLBKVATInvDate, GLBKVATPct, GLBKVATObjectName, GLBKVATObjectAddress, GLBKVATObjectTaxNo, GLBKVATInvItemDesc"
                                            , strDateCond, strType);
            //if (fromDate.Year != 1)
            //    query += String.Format("AND GLJournalDate >= '{0}' ", String.Format("{0:yyyy/M/d HH:mm:ss}", fromDate));
            //if (toDate.Year != 1)
            //    query += string.Format("AND GLJournalDate <= '{0}' ", String.Format("{0:yyyy/M/d HH:mm:ss}", toDate));

            //query += String.Format("AND (FK_GLDebitAccountID IN (select GLAccountID from GLAccounts where AAStatus = 'Alive' and GLAccountNo like '{0}%') "
            //+ "or FK_GLCreditAccountID IN (select GLAccountID from GLAccounts where AAStatus = 'Alive' and GLAccountNo = '{1}'))", AccountNo, AccountNo);
            DataSet ds = dal.GetDataSet(query);
            return ds;
        }

        public DataSet GetAllDataErrorByJournalDateAndAccountID(DateTime fromDate, DateTime toDate, String strType)
        {
            String strDateCond = DALUtil.GenerateBeetween("GLJournalDate", fromDate, toDate);

            string query = String.Format(@"SELECT
	                                            GLBKVATNo,
	                                            GLBKVATDesc,
	                                            GLPeriod,
	                                            GLYear,
	                                            GLBKVATDate,
	                                            GLBKVATType,
	                                            GLBKVATInvNo,
	                                            GLBKVATInvSerie,
	                                            GLBKVATInvDate,
	                                            SUM(GLBKVATItemTotAmt) AS GLBKVATItemTotAmt,
	                                            GLBKVATPct,
	                                            SUM(GLBKVATAmt) AS GLBKVATAmt,
	                                            GLBKVATObjectName,
	                                            GLBKVATObjectAddress,
	                                            GLBKVATObjectTaxNo,
	                                            GLBKVATInvItemDesc
                                            FROM
	                                            (
	                                            SELECT 
		                                            Journal.GLJournalNo AS GLBKVATNo,
		                                            Journal.GLJournalHDesc AS GLBKVATDesc,
		                                            Journal.GLJournalPeriod AS GLPeriod,
		                                            Journal.GLJournalYear AS GLYear,
		                                            Journal.GLJournalDate AS GLBKVATDate,
		                                            '{1}' AS GLBKVATType,
		                                            Journal.GLJournalInvNo AS GLBKVATInvNo,
		                                            Journal.GLJournalInvSerie AS GLBKVATInvSerie,
		                                            Journal.GLJournalInvDate AS GLBKVATInvDate,
		                                            Journal.GLJournalAmt AS GLBKVATItemTotAmt,
		                                            ISNULL((SELECT TXTaxCodePct FROM TXTaxCodes WHERE AAStatus='Alive' AND Journal.FK_TXTaxCodeID = TXTaxCodeID),0) AS GLBKVATPct,
		                                            (Journal.GLJournalAmt * ISNULL((SELECT TXTaxCodePct FROM TXTaxCodes WHERE AAStatus='Alive' AND Journal.FK_TXTaxCodeID = TXTaxCodeID),0) / 100) AS GLBKVATAmt,
		                                            ISNULL(NULLIF(Journal.GLJournalObjectName,''), ISNULL((SELECT HREmployeeName FROM dbo.HREmployees WHERE AAStatus='Alive' AND HREmployeeID = Journal.FK_HREmployeeID),'')) AS GLBKVATObjectName,
		                                            ISNULL(NULLIF(Journal.GLJournalObjectAdd,''), ISNULL((SELECT HREmployeePermanentAddressStreet FROM dbo.HREmployees WHERE AAStatus='Alive' AND HREmployeeID = Journal.FK_HREmployeeID),'')) AS GLBKVATObjectAddress,
		                                            Journal.GLJournalObjectTaxCode AS GLBKVATObjectTaxNo,
		                                            ISNULL((SELECT ICProductName FROM dbo.ICProducts WHERE AAStatus='Alive' AND Journal.FK_ICProductID = ICProductID), Journal.GLJournalDesc) AS GLBKVATInvItemDesc
		
	                                            FROM dbo.GLJournals Journal
	                                            WHERE (	
			                                            Journal.FK_GLDebitAccountID IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND GLAccountID NOT IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND (GLAccountNo LIKE '1331%' OR GLAccountNo LIKE '3331%') )) 
			                                            OR 
			                                            Journal.FK_GLCreditAccountID IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND GLAccountID NOT IN (SELECT GLAccountID FROM GLAccounts WHERE AAStatus = 'Alive' AND (GLAccountNo LIKE '1331%' OR GLAccountNo LIKE '3331%') ))
                                                       )
                                                       AND Journal.FK_TXTaxCodeID IN (SELECT TXTaxCodeID FROM TXTaxCodes WHERE AAStatus='Alive' AND TXTaxCodeTypeCombo LIKE '{1}')
                                                       AND Journal.GLJournalInvNo LIKE ''
                                                       AND Journal.GLJournalInvSerie LIKE ''
                                                       AND {0}
	                                            ) AS TB
	                                            GROUP BY GLBKVATNo,	GLBKVATDesc, GLPeriod, GLYear, GLBKVATDate, GLBKVATType, GLBKVATInvNo, GLBKVATInvSerie, GLBKVATInvDate, GLBKVATPct, GLBKVATObjectName, GLBKVATObjectAddress, GLBKVATObjectTaxNo, GLBKVATInvItemDesc"
                                            , strDateCond, strType);

            DataSet ds = dal.GetDataSet(query);
            return ds;
        }
	}
	#endregion
}