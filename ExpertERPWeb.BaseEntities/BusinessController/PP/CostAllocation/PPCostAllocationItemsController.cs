using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
    #region PPCostAllocationItems
    //-----------------------------------------------------------
    //Generated By: GMC Studio
    //Class:PPCostAllocationItemsController
    //Created Date:Friday, October 07, 2016
    //-----------------------------------------------------------

    public class PPCostAllocationItemsController : BaseBusinessController
    {
        public PPCostAllocationItemsController()
        {
            dal = new DALBaseProvider("PPCostAllocationItems", typeof(PPCostAllocationItemsInfo));
        }


        public DataSet GetAllData_AllocateMthCombo(string typeCombo, int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"
                                            SELECT  *
                                            FROM    PPCostAllocationItems
                                            WHERE   PPCostFactorAllocateMthCombo = '{0}'
                                                    AND AAStatus = 'Alive'
                                                    AND FK_PPCostAllocationID = ( SELECT    PPCostAllocationID
                                                                                  FROM      dbo.PPCostAllocations
                                                                                  WHERE     PPPeriod = {1}
                                                                                            AND PPYear = {2}
                                                                                            AND AAStatus = 'Alive'
                                                                                )
                                            ", typeCombo, iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetCostFactor_ByCostCenterDirect(int iPPCostCenterID)
        {
            string strQuery = string.Format(@"
                                            SELECT * 
                                            FROM PPCostAllocationItems
                                            WHERE FK_PPCostCenterID='{0}' 
                                            AND AAStatus='Alive'
                                            ", iPPCostCenterID);
            return GetDataSet(strQuery);
        }

        public DataSet GetAllDataItem_ByPPCostAllocationID(int iPeriod, int iYear, int iPPCostAllocationID = 0, string typeCombo = "")
        {
            string strSubQueryCombo = string.Empty;
            string strCostFactor = string.Empty;
            string strQuery = string.Empty;
            if (typeCombo != "")
            {
                strSubQueryCombo = string.Format(@"AND PPCostFactorAllocateMthCombo = '{0}' ", typeCombo);

            }

            string strSubQueryPPCostAllocationID = string.Empty;

            if (iPPCostAllocationID > 0)
            {
                strSubQueryPPCostAllocationID = string.Format(@"AND PPCostAllocationID = '{0}'", iPPCostAllocationID);
                strCostFactor = "FK_PPCostFactorID,";
                strQuery = string.Format(@"
                                            SELECT  MAX(FK_PPCostFactorID) FK_PPCostFactorID,
                                            FK_PPCostCenterID ,
                                            SUM(PPCostAllocationItemDirectValue) PPCostAllocationItemDirectValue ,
                                            SUM(PPCostAllocationItemIndirectValue) PPCostAllocationItemIndirectValue ,
                                            SUM(PPCostAllocationItemAmtTot) PPCostAllocationItemAmtTot ,
                                            MAX(PPCostFactorAllocateMthCombo) PPCostFactorAllocateMthCombo ,
                                            PPCostAllocationItemStatisticProductionCheck,
                                            MAX(FK_ICProductFGID) FK_ICProductFGID
                                    FROM    PPCostAllocationItems
                                    WHERE   AAStatus = 'Alive'
                                            AND FK_PPCostAllocationID IN ( SELECT    PPCostAllocationID
                                                                          FROM      dbo.PPCostAllocations
                                                                          WHERE     PPPeriod = '{0}'
                                                                                    AND PPYear = '{1}'
                                                                                    AND AAStatus = 'Alive'
                                                                                    {2}
                                                                        )
                                            {3}
                                    GROUP BY {4} 
                                             FK_PPCostCenterID ,
                                             PPCostAllocationItemStatisticProductionCheck
                                             --,FK_ICProductFGID
													
                                            ", iPeriod, iYear, strSubQueryPPCostAllocationID, strSubQueryCombo, strCostFactor);
            }
            else if (iPPCostAllocationID == 0)
            {
                strQuery = string.Format(@"
                                            SELECT  FK_PPCostCenterID ,
                                            SUM(PPCostAllocationItemDirectValue) PPProductionCostingCalcCostCenterDirectValue ,
                                            SUM(PPCostAllocationItemIndirectValue) PPProductionCostingCalcCostCenterInDirectValue ,
                                            SUM(PPCostAllocationItemAmtTot) PPProductionCostingCalCostCentercAmt ,
                                            MAX(FK_ICProductFGID) FK_ICProductFGID,
                                            N'Chưa phân bổ' AS PPProductionCostingCalcItemStatusCombo
                                    FROM    PPCostAllocationItems
                                    WHERE   AAStatus = 'Alive'
                                            AND FK_PPCostAllocationID IN ( SELECT    PPCostAllocationID
                                                                          FROM      dbo.PPCostAllocations
                                                                          WHERE     PPPeriod = '{0}'
                                                                                    AND PPYear = '{1}'
                                                                                    AND AAStatus = 'Alive'
                                                                        )
                                                {2}
                                    GROUP BY  
                                             FK_PPCostCenterID ,
                                             PPCostAllocationItemStatisticProductionCheck
                                             --,FK_ICProductFGID
									--HAVING SUM(PPCostAllocationItemAmtTot) > 0				
                                            ", iPeriod, iYear, strSubQueryCombo);
            }

            return GetDataSet(strQuery);
        }

        public DataSet GetAllDataItem_ByCostAllocationIDAndPeriod(int PPCostCenterID, int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"
                                                 
                                                 SELECT FK_PPCostAllocationID ,
                                                        FK_PPCostFactorID ,
                                                        FK_PPCostCenterID ,
                                                        FK_ICProductFGID,
                                                        SUM(PPCostAllocationItemDirectValue) PPCostAllocationItemDirectValue,
                                                        SUM(PPCostAllocationItemAmtTot) PPCostAllocationItemAmtTot,
                                                        SUM(PPCostAllocationItemIndirectValue) PPCostAllocationItemIndirectValue 
                                                    --PPCostFactorAllocateMthCombo
                                                 FROM   PPCostAllocationItems
                                                 WHERE  AAStatus = 'Alive'
                                                        AND FK_PPCostCenterID = '{0}'
                                                        AND FK_PPCostAllocationID = ( SELECT
                                                              PPCostAllocationID
                                                              FROM
                                                              dbo.PPCostAllocations
                                                              WHERE
                                                              PPPeriod = '{1}'
                                                              AND PPYear = '{2}'
                                                              AND AAStatus = 'Alive'
                                                              )
                                                 GROUP BY FK_PPCostAllocationID ,
                                                        FK_PPCostFactorID ,
                                                        FK_ICProductFGID,
                                                        FK_PPCostCenterID
                                                    
                                            
                                                    
                                            ", PPCostCenterID, iPeriod, iYear);
            return GetDataSet(strQuery);

        }

        public DataSet GetAllDataItem_ByCostCenterStepAndPeriod(int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"                                            
                                            SELECT  MAX(FK_PPCostFactorID) FK_PPCostFactorID ,
                                                    MAX(PPCostAllocationItems.FK_PPCostCenterID) FK_PPCostCenterID,
                                                    SUM(PPCostAllocationItemDirectValue) PPCostAllocationItemDirectValue ,
                                                    SUM(PPCostAllocationItemIndirectValue) PPCostAllocationItemIndirectValue ,
                                                    SUM(PPCostAllocationItemAmtTot) PPCostAllocationItemAmtTot ,
                                                    MAX(PPCostFactorAllocateMthCombo) PPCostFactorAllocateMthCombo ,
                                                    PPCostAllocationItems.PPCostAllocationItemStatisticProductionCheck ,
                                                    FK_ICProductFGID
                                            FROM    PPCostAllocationItems
                                            INNER JOIN PPCostCenterSteps ON PPCostCenterSteps.FK_PPCostCenterID = PPCostAllocationItems.FK_PPCostCenterID 

                                            WHERE   AAStatus = 'Alive'
                                                    AND FK_PPCostAllocationID IN ( SELECT   PPCostAllocationID
                                                                                    FROM     dbo.PPCostAllocations
                                                                                    WHERE    PPPeriod = '{0}'
                                                                                            AND PPYear = '{1}'
                                                                                            AND AAStatus = 'Alive' )
                                                    AND PPCostFactorAllocateMthCombo = 'Direct'
                                            GROUP BY FK_PPCostFactorID ,
                                                    PPCostAllocationItems.FK_PPCostCenterID ,
                                                    PPCostAllocationItemStatisticProductionCheck ,
                                                    FK_ICProductFGID,
		                                            PPCostCenterSteps.PPCostCenterStepOrder
                                            ORDER BY PPCostCenterSteps.PPCostCenterStepOrder ASC
													
                                            ", iPeriod, iYear);
            return GetDataSet(strQuery);
        }
        public DataSet GetAllDataByPeriod(int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"
                                             SELECT  MAX(FK_PPCostFactorID) FK_PPCostFactorID,
                                            FK_PPCostCenterID ,
                                            SUM(PPCostAllocationItemDirectValue) PPCostAllocationItemDirectValue ,
                                            SUM(PPCostAllocationItemIndirectValue) PPCostAllocationItemIndirectValue ,
                                            SUM(PPCostAllocationItemAmtTot) PPCostAllocationItemAmtTot ,
                                            MAX(PPCostFactorAllocateMthCombo) PPCostFactorAllocateMthCombo ,
                                            PPCostAllocationItemStatisticProductionCheck,
                                            FK_ICProductFGID
                                    FROM    PPCostAllocationItems
                                    WHERE   AAStatus = 'Alive'
                                            AND FK_PPCostAllocationID IN ( SELECT    PPCostAllocationID
                                                                          FROM      dbo.PPCostAllocations
                                                                          WHERE     PPPeriod = '{0}'
                                                                                    AND PPYear = '{1}'
                                                                                    AND AAStatus = 'Alive'
                                                                        )
                                         AND PPCostFactorAllocateMthCombo = 'Direct' 
                                    GROUP BY FK_PPCostFactorID ,
                                             FK_PPCostCenterID ,
                                             PPCostAllocationItemStatisticProductionCheck,
                                             FK_ICProductFGID
                                ", iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetInDirectValueByPPCostCenterAndFactorID(int pPPCostCenterID, int pPPCostFactorID, int pPeriod, int pYear)
        {
            string strQuery = string.Format(@"
                                        SELECT  *
                                        FROM    dbo.PPCostAllocationItems
                                        WHERE   FK_PPCostCenterID = {0}
                                                AND FK_PPCostFactorID = {1}
                                                AND AAStatus = 'Alive'
                                                AND FK_PPCostAllocationID = ( 
                                                                              SELECT
                                                                              PPCostAllocationID
                                                                              FROM
                                                                              dbo.PPCostAllocations
                                                                              WHERE
                                                                              PPPeriod = {2}
                                                                              AND PPYear = {3} 
                                                                              AND AAStatus='Alive'
                                                              )
                                            ", pPPCostCenterID, pPPCostFactorID, pPeriod, pYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetAllDataGroupByCostCenter(int iPeriod, int iYear, int iPPCostAllocationID)
        {
            string strQuery = string.Format(@"

                                    SELECT  MAX(FK_PPCostCenterID) FK_PPCostCenterID,
                                            SUM(PPCostAllocationItemDirectValue) PPCostAllocationItemDirectValue ,
                                            SUM(PPCostAllocationItemIndirectValue) PPCostAllocationItemIndirectValue ,
                                            SUM(PPCostAllocationItemAmtTot) PPCostAllocationItemAmtTot ,
                                            MAX(PPCostFactorAllocateMthCombo) PPCostFactorAllocateMthCombo 
                                    FROM    PPCostAllocationItems
                                    WHERE   AAStatus = 'Alive'
                                            AND FK_PPCostAllocationID IN ( SELECT    PPCostAllocationID
                                                                          FROM      dbo.PPCostAllocations
                                                                          WHERE     PPPeriod = {0}
                                                                                    AND PPYear = {1}
                                                                                    AND AAStatus = 'Alive'
																					AND PPCostAllocationID = {2}
                                                                        )
                                    GROUP BY 
                                             FK_PPCostCenterID 
                                            ", iPeriod, iYear, iPPCostAllocationID);
            return GetDataSet(strQuery);
        }
    }
    #endregion
}