using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region PPProductionCostStatistics
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:PPProductionCostStatisticsController
	//Created Date:24 Tháng Mười Một 2014
	//-----------------------------------------------------------
	
	public class PPProductionCostStatisticsController:BaseBusinessController
	{
		public PPProductionCostStatisticsController()
		{
			dal= new DALBaseProvider("PPProductionCostStatistics",typeof(PPProductionCostStatisticsInfo));
		}

        public void DeleteAllDataByYearANDPeriod(int iYear, int iPeriod)
        {
            String str = String.Format(@"   DELETE dbo.PPProductionCostStatistics
                                            WHERE PPYear = {0}
                                            AND PPPeriod = {1}"
                                            , iYear, iPeriod);
            dal.GetDataSet(str);
        }

        public void DeleteAllDataByYearANDPeriod(int iYear, int iPeriod, int iPPProductionCostCenterID)
        {
            String str = String.Format(@"   DELETE dbo.PPProductionCostStatistics
                                            WHERE PPYear = {0}
                                            AND PPPeriod = {1}
                                            AND FK_PPProductionCostCenterID = {2}"
                                            , iYear, iPeriod, iPPProductionCostCenterID);
            dal.GetDataSet(str);
        }

        public DataSet GetAllDataByYearANDPeriod(int iYear, int iPeriod)
        {
            String str = String.Format(@"   SELECT * FROM dbo.PPProductionCostStatistics
                                            WHERE PPYear = {0}
                                            AND PPPeriod = {1}"
                                            , iYear, iPeriod);
            return dal.GetDataSet(str);
        }

        public DataSet GetAllDataByYearANDPeriod(int iYear, int iPeriod, int iPPProductionCostCenterID)
        {
            String str = String.Format(@"   SELECT * FROM dbo.PPProductionCostStatistics
                                            WHERE PPYear = {0}
                                            AND PPPeriod = {1}
                                            AND FK_PPProductionCostCenterID = {2}"
                                            , iYear, iPeriod, iPPProductionCostCenterID);
            return dal.GetDataSet(str);
        }

        public Boolean CheckDataInYearANDPeriod(int iYear, int iPeriod)
        {
            DataSet ds = GetAllDataByYearANDPeriod(iYear, iPeriod);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0) return true;

            return false;
        }

        public Boolean CheckDataInYearANDPeriod(int iYear, int iPeriod, int iPPProductionCostCenterID)
        {
            DataSet ds = GetAllDataByYearANDPeriod(iYear, iPeriod, iPPProductionCostCenterID);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0) return true;

            return false;
        }

        public DataSet LayTapHopThanhPhamSanXuatTrongKy(int iYear, int iPeriod, int iPPCostCenterID)
        {
            String strQuery = LayTruyVanTapHopKetQuaSanXuatTrongKy(iYear, iPeriod, iPPCostCenterID);
            //Không lấy nhập kho NVL dư (RMReceipt) --Vinh
            String str = strQuery.Replace("*", String.Format(@" FK_ICProductID ,
                                                PPProductionCostCenters.FK_PPCostCenterID ,
                                                PPProductionCostStatisticQty ,
                                                {0} AS PPYear, {1} AS PPPeriod,
                                                PPProductionCostCenters.PPProductionCostCenterID AS FK_PPProductionCostCenterID",
                                                iYear, iPeriod));
            return dal.GetDataSet(str);
        }

        public double LaySoLuongThanhPhamSanXuatTrongKy(int iYear, int iPeriod, int iPPCostCenterID)
        {
            String strQuery = LayTruyVanTapHopKetQuaSanXuatTrongKy(iYear, iPeriod, iPPCostCenterID);
            //Không lấy nhập kho NVL dư (RMReceipt) --Vinh
            String str = strQuery.Replace("*", String.Format(@" SUM(PPProductionCostStatisticQty) ASPPProductionCostStatisticQty "));
            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }

        public String LayTruyVanTapHopKetQuaSanXuatTrongKy(int iYear, int iPeriod, int iPPCostCenterID)
        {
            //Không lấy nhập kho NVL dư (RMReceipt) --Vinh
            String str = String.Format(@"SELECT  *
                                        FROM    ( SELECT    FK_ICProductID ,
                                                            ICReceiptItems.FK_PPCostCenterID ,
                                                            SUM(ICReceiptItemQty) AS PPProductionCostStatisticQty
                                                  FROM      dbo.ICReceiptItems
                                                  WHERE     ICReceiptItems.AAStatus = 'Alive'
                                                            AND ICReceiptItems.FK_PPCostCenterID = {2}
                                                            AND 
                                                            (
                                                                FK_PPProductionOrdrID IN (
                                                                                            SELECT  PPProductionOrdrID
                                                                                            FROM    dbo.PPProductionOrdrs
                                                                                            WHERE   AAStatus = 'Alive'
                                                                                                    AND YEAR(PPProductionOrdrDate) = {0}
                                                                                                    AND MONTH(PPProductionOrdrDate) = {1} )
                                                                OR
                                                                FK_ICReceiptID IN (
                                                                                    SELECT ICReceiptID 
                                                                                    FROM dbo.ICReceipts
                                                                                    WHERE AAStatus = 'Alive'
                                                                                          AND MONTH(ICReceiptDate) = {0}
                                                                                          AND Year(ICReceiptDate) = {1}
                                                                                          AND ICReceiptSubType <> 'RMReceipt'
                                                                                    )
                                                            )
                                                  GROUP BY  FK_ICProductID ,
                                                            ICReceiptItems.FK_PPCostCenterID
                                                ) AS TB
                                                INNER JOIN dbo.PPProductionCostCenters ON ( PPProductionCostCenters.FK_PPCostCenterID = TB.FK_PPCostCenterID
                                                                                            AND PPProductionCostCenters.PPYear = {0}
                                                                                            AND PPProductionCostCenters.PPPeriod = {1}
                                                                                          )"
                                    , iYear, iPeriod, iPPCostCenterID);
            return str;
        }

        public DataSet CapNhatGiaVonSanXuatTrongKy(int iYear, int iPeriod, int iICProductID, int iPPCostCenterID, double dbUnitCost)
        {
            //Không lấy nhập kho NVL dư (RMReceipt) --Vinh
            String str = String.Format(@"UPDATE dbo.ICReceiptItems
                                        SET ICReceiptItemUnitCost = {4}, ICReceiptItemCostTot = ROUND({4} * ICReceiptItemQty, 0)
                                        WHERE   AAStatus = 'Alive'
                                                AND FK_PPCostCenterID = {3}
		                                        AND FK_ICProductID = {2}
                                                AND 
                                                (
                                                    FK_PPProductionOrdrID IN (
                                                                                SELECT  PPProductionOrdrID
                                                                                FROM    dbo.PPProductionOrdrs
                                                                                WHERE   AAStatus = 'Alive'
                                                                                        AND YEAR(PPProductionOrdrDate) = {0}
                                                                                        AND MONTH(PPProductionOrdrDate) = {1} )
                                                    OR
                                                    FK_ICReceiptID IN (
                                                                        SELECT ICReceiptID 
                                                                        FROM dbo.ICReceipts
                                                                        WHERE AAStatus = 'Alive'
                                                                                AND MONTH(ICReceiptDate) = {0}
                                                                                AND Year(ICReceiptDate) = {1}
                                                                                AND ICReceiptSubType <> 'RMReceipt'
                                                                        )
                                                )"
                                    , iYear, iPeriod, iICProductID, iPPCostCenterID, dbUnitCost);
            return dal.GetDataSet(str);
        }

        public double LayTongGiaVonSanXuatTrongKy(int iYear, int iPeriod, int iICProductID, int iPPCostCenterID)
        {
            //Không lấy nhập kho NVL dư (RMReceipt) --Vinh
            String str = String.Format(@"SELECT SUM(ICReceiptItemCostTot) FROM dbo.ICReceiptItems
                                        WHERE   AAStatus = 'Alive'
                                                AND FK_PPCostCenterID = {3}
		                                        AND FK_ICProductID = {2}
                                                AND 
                                                (
                                                    FK_PPProductionOrdrID IN (
                                                                                SELECT  PPProductionOrdrID
                                                                                FROM    dbo.PPProductionOrdrs
                                                                                WHERE   AAStatus = 'Alive'
                                                                                        AND YEAR(PPProductionOrdrDate) = {0}
                                                                                        AND MONTH(PPProductionOrdrDate) = {1} )
                                                    OR
                                                    FK_ICReceiptID IN (
                                                                        SELECT ICReceiptID 
                                                                        FROM dbo.ICReceipts
                                                                        WHERE AAStatus = 'Alive'
                                                                                AND MONTH(ICReceiptDate) = {0}
                                                                                AND Year(ICReceiptDate) = {1}
                                                                                AND ICReceiptSubType <> 'RMReceipt'
                                                                        )
                                                )"
                                    , iYear, iPeriod, iICProductID, iPPCostCenterID);
            DataSet ds = dal.GetDataSet(str);
            if(ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }

        public ICReceiptItemsInfo LayNhapKhoSanXuatDauTienTrongKy(int iYear, int iPeriod, int iICProductID, int iPPCostCenterID)
        {
            //Không lấy nhập kho NVL dư (RMReceipt) --Vinh
            String str = String.Format(@"SELECT TOP 1 FROM dbo.ICReceiptItems
                                        WHERE   AAStatus = 'Alive'
                                                AND FK_PPCostCenterID = {3}
		                                        AND FK_ICProductID = {2}
                                                AND 
                                                (
                                                    FK_PPProductionOrdrID IN (
                                                                                SELECT  PPProductionOrdrID
                                                                                FROM    dbo.PPProductionOrdrs
                                                                                WHERE   AAStatus = 'Alive'
                                                                                        AND YEAR(PPProductionOrdrDate) = {0}
                                                                                        AND MONTH(PPProductionOrdrDate) = {1} )
                                                    OR
                                                    FK_ICReceiptID IN (
                                                                        SELECT ICReceiptID 
                                                                        FROM dbo.ICReceipts
                                                                        WHERE AAStatus = 'Alive'
                                                                                AND MONTH(ICReceiptDate) = {0}
                                                                                AND Year(ICReceiptDate) = {1}
                                                                                AND ICReceiptSubType <> 'RMReceipt'
                                                                        )
                                                )"
                                    , iYear, iPeriod, iICProductID, iPPCostCenterID);
            DataSet ds = dal.GetDataSet(str);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                return (ICReceiptItemsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }
            return null;
        }

        public double LayChiPhiNhapNVLThuaChoTapPhi(int iYear, int iPeriod, int iPPCostCenterID, int iGLAccountID)
        {
            String str = String.Format(@"SELECT  SUM(GLJournalAmt) AS Amt
                                        FROM    dbo.GLJournals
                                                INNER JOIN dbo.PPProductionCostFactorItems ON ( PPProductionCostFactorItems.FK_GLAccountID = GLJournals.FK_GLCreditAccountID
                                                                                                AND PPProductionCostFactorItems.FK_GLAccountID = {3}
                                                                                                AND GLJournals.FK_PPCostCenterID = {2}
                                                                                                AND GLJournalYear = {0}
                                                                                                AND GLJournalPeriod = {1}
                                                                                                AND PPProductionCostFactorItems.FK_PPCostFactorID IN (
                                                                                                                                                        SELECT
                                                                                                                                                              PPProductionCostFactorID
                                                                                                                                                        FROM  dbo.PPProductionCostFactors
                                                                                                                                                        WHERE PPYear = {0}
                                                                                                                                                              AND PPPeriod = {1} )
                                                                                              )"
                                            , iYear, iPeriod, iPPCostCenterID, iGLAccountID);
            DataSet ds = dal.GetDataSet(str);
            if(ds!= null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count> 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }

        public double LayChiPhiDoDangChoTapPhi(int iYear, int iPeriod, int iPPProductionCostCenterID, int iGLAccountID)
        {
            String str = String.Format(@"SELECT  SUM(PPProductionCostStatisticItemAmt) AS PPProductionCostStatisticItemAmt
                                        FROM    dbo.PPProductionCostStatisticItems
                                                INNER JOIN dbo.PPProductionCostStatistics ON ( PPProductionCostStatistics.PPProductionCostStatisticID = PPProductionCostStatisticItems.FK_PPProductionCostStatisticID
                                                                                               AND PPProductionCostStatistics.PPPeriod = PPProductionCostStatisticItems.PPPeriod
                                                                                               AND PPProductionCostStatistics.PPYear = PPProductionCostStatisticItems.PPYear
                                                                                               AND PPProductionCostStatisticItems.PPYear = {0}
                                                                                               AND PPProductionCostStatisticItems.PPPeriod = {1}
                                                                                               AND PPProductionCostStatistics.FK_PPProductionCostCenterID = {2}
                                                                                               AND PPProductionCostStatisticItems.FK_GLAccountID = {3}
																							   AND PPProductionCostStatistics.PPProductionCostStatisticTypeCombo LIKE 'InComplete'
                                                                                             )"
                                            , iYear, iPeriod, iPPProductionCostCenterID, iGLAccountID);
            DataSet ds = dal.GetDataSet(str);
            if(ds!= null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count> 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }
	}
	#endregion
}