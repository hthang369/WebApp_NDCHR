using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region PPWOs
	//-----------------------------------------------------------
	//Generated By: Expert Studio
	//Class:PPWOsController
	//Created Date:20 Tháng Tư 2011
	//-----------------------------------------------------------
	
	public class PPWOsController:BaseBusinessController
	{
		public PPWOsController()
		{
			dal= new DALBaseProvider("PPWOs",typeof(PPWOsInfo));
		}

        public DataSet GetAllWOByProductPlnType(int iProductPlnID, string strProductPlnType)
        {
            string strQuery=string.Format(@"select distinct PPWOs.* from PPWOEstFGItems 
                                                inner join PPWOs on PPWOEstFGItems.FK_PPWOID=PPWOs.PPWOID
                                                inner join PPProductPlnItems 
                                                on	PPWOEstFGItems.FK_ICProductID=PPProductPlnItems.FK_ICProductID 
	                                                AND PPWOEstFGItems.FK_ICSemiProductID=PPProductPlnItems.FK_ICSemiProductID
	                                                AND PPWOEstFGItems.FK_ICFGProductID=PPProductPlnItems.FK_ICFGProductID
                                                where PPWOs.FK_PPProductPlnID={0} AND PPProductPlnItems.FK_PPProductPlnID={0}
                                                AND PPProductPlnItems.PPProductPlnItemTypeCombo='{1}'", iProductPlnID,strProductPlnType);
            return dal.GetDataSet(strQuery);
        }

        // NhamNDH add -25/11/2016- Move Lệnh sản xuất từ CHF
        public DataSet GetAllWONotComplete()
        {
            string strQuery = string.Format(@"
                    SELECT  *
                    FROM    dbo.PPWOs
                    WHERE   PPWOs.AAStatus = 'Alive'
                            AND ( PPWOID IN ( SELECT    PPWOEstFGItems.FK_PPWOID
                                              FROM      dbo.PPWOEstFGItems
                                              WHERE     PPWOEstFGItems.PPWOEstFGItemRQty > 0 )
                                  OR PPWOID IN (
                                  SELECT    PPProductionOrdrFG.FK_PPWOID
                                  FROM      dbo.PPProductionOrdrEstFGs
                                            INNER JOIN dbo.PPProductionOrdrs PPProductionOrdrFG ON PPProductionOrdrFG.PPProductionOrdrID = PPProductionOrdrEstFGs.FK_PPProductionOrdrID
                                                                                  AND PPProductionOrdrFG.AAStatus = PPProductionOrdrEstFGs.AAStatus
                                                                                  AND PPProductionOrdrFG.AAStatus = 'Alive'
                                  WHERE     PPProductionOrdrEstFGs.PPProductionOrdrEstFGRQty > 0 )
                                  OR PPWOID IN (
                                  SELECT    PPProductionOrdrRM.FK_PPWOID
                                  FROM      dbo.PPProductionOrdrEstRMs
                                            INNER JOIN dbo.PPProductionOrdrs PPProductionOrdrRM ON PPProductionOrdrRM.PPProductionOrdrID = PPProductionOrdrEstRMs.FK_PPProductionOrdrID
                                                                                  AND PPProductionOrdrRM.AAStatus = PPProductionOrdrEstRMs.AAStatus
                                                                                  AND PPProductionOrdrRM.AAStatus = 'Alive'
                                  WHERE     PPProductionOrdrEstRMs.PPProductionOrdrEstRMRQty > 0 )
                                  OR PPWOID IN (
                                  SELECT    PPProductionOrdrRO.FK_PPWOID
                                  FROM      dbo.PPProductionOrdrs PPProductionOrdrRO
                                            INNER JOIN dbo.ICROs ON ICROs.FK_PPProductionOrdrID = PPProductionOrdrRO.PPProductionOrdrID
                                                                    AND ICROs.AAStatus = PPProductionOrdrRO.AAStatus
                                                                    AND ICROs.AAStatus = 'Alive'
                                            INNER JOIN dbo.ICROItems ON ICROItems.FK_ICROID = ICROs.ICROID
                                                                        AND ICROItems.AAStatus = ICROs.AAStatus
                                                                        AND ICROItems.AAStatus = 'Alive'
                                  WHERE     ICROItems.ICROItemRQty > 0 )
                                )");

            return GetDataSet(strQuery);
        }
        // NhamNDH add -25/11/2016- Move lệnh sản xuất từ CHF
        public DataSet GetAllWOCancel()
        {
            string strQuery = string.Format(@"
                                            SELECT  *
                                            FROM    dbo.PPWOs
                                            WHERE   AAStatus = 'Alive'
                                                    AND PPWOID IN ( SELECT  FK_PPWOID
                                                                    FROM    dbo.PPWOEstFGItems
                                                                    WHERE   AAStatus = 'Alive'
                                                                            AND PPWOEstFGItemCQty > 0 )");
            return GetDataSet(strQuery);
        }
        public PPWOsInfo GetObjecOpenBalanceByDate(DateTime dte)
        {
            string strQuery = string.Format(@"SELECT
                                                    PPWOs.*
                                                FROM PPWOs
                                                WHERE 
                                                    CONVERT(VARCHAR(10), PPWOs.PPWOEstEndDate, 112) >= '{0}'
                                                    AND PPWOs.AAStatus = 'Alive'
                                                    AND PPWOs.PPWOTypeCombo = 'WOOB'
                                                ", dte.ToString("yyyyMMdd"));
            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                return (PPWOsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            return null;
        }
        //
    }
	#endregion
}