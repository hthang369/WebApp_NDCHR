using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region PPWOPItems
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:PPWOPItemsController
	//Created Date:Saturday, February 27, 2016
	//-----------------------------------------------------------
	
	public class PPWOPItemsController:BaseBusinessController
	{
		public PPWOPItemsController()
		{
			dal= new DALBaseProvider("PPWOPItems",typeof(PPWOPItemsInfo));
		}

        public DataSet GetAllDataByMPSANDProduct(int iPPMPSID, int iICProductID)
        {
            string strQuery = string.Format(@"SELECT * FROM dbo.PPWOPItems WHERE AAStatus = 'Alive' AND FK_PPMPSItemID = {0} AND FK_ICProductID = {1}"
                                           , iPPMPSID, iICProductID);
            return GetDataSet(strQuery);
        }
        /// <summary>
        /// NhamNDH -29/11/2016- Lấy danh sách sản phẩm theo SO đã tạo lệnh sản xuất
        /// </summary>
        /// <param name="iARSOItemID"></param>
        /// <param name="iICProductID"></param>
        /// <returns></returns>
        public DataSet GetAllDataBySOANDProduct(int iARSOItemID, int iICProductID)
        {
            string strQuery = string.Format(@"SELECT * FROM dbo.PPWOPItems WHERE AAStatus = 'Alive' AND FK_ARSOItemID = {0} AND FK_ICProductID = {1}"
                                           , iARSOItemID, iICProductID);
            return GetDataSet(strQuery);
        }

        // NhamNDH add -29/11/2016- lấy số lượng đã tạo lệnh sản xuất theo SO
        public double GetQtyInFGWOByARSOItemID(int iARSOItemID)
        {
            string strQuery = string.Format(@"  SELECT SUM(PPWOPItems.PPWOPItemQty)
                                                FROM dbo.PPWOPItems
                                                INNER JOIN dbo.PPWOs ON PPWOs.PPWOID = PPWOPItems.FK_PPWOID AND PPWOs.AAStatus ='Alive'
                                                WHERE PPWOPItems.AAStatus='Alive'
                                                      AND PPWOPItems.FK_ARSOItemID={0}"
                                            ,iARSOItemID);
            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                try
                {
                    return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
                }
                catch (System.Exception ex)
                {

                }
            }
            return 0;
        }
        //170424: T.Bao comment
        // NhamNDH add -02/12/2016- lấy danh sách đã tạo lệnh sản xuất theo SO, Product, kế hoạch
        public DataSet GetAllDataBySOtemIDProduct(int aRSOItemID, int iCProductID)
        {
            string strQuery = string.Format(@"  SELECT dbo.PPWOPItems.*
                                                FROM dbo.PPWOPItems
                                                INNER JOIN dbo.PPWOs ON	PPWOs.PPWOID = PPWOPItems.FK_PPWOID AND dbo.PPWOs.AAStatus = 'Alive'
                                                WHERE dbo.PPWOPItems.AAStatus = 'Alive'
	                                                  AND dbo.PPWOPItems.FK_ARSOItemID = {0}
                                                      AND dbo.PPWOPItems.FK_ICProductID = {1}"
                                            , aRSOItemID, iCProductID);
            return GetDataSet(strQuery);
        }
        // 170424: T.Bao Get Sum Group by 
        public DataSet GetSumPPWOPItemQtyByARSOID(int ARSOID)
        {
            string strQuery = string.Format(@"  SELECT  SUM(PPWOPItems.PPWOPItemQty) AS PPWOPItemQty,
		                                                dbo.PPWOPItems.FK_ARShpPlanItemID
                                                FROM    dbo.PPWOPItems
                                                        INNER JOIN dbo.PPWOs ON PPWOs.PPWOID = PPWOPItems.FK_PPWOID
                                                                                AND dbo.PPWOs.AAStatus = 'Alive'
                                                WHERE   dbo.PPWOPItems.AAStatus = 'Alive'
		                                                AND EXISTS (SELECT  'x'
					                                                FROM    dbo.ARShpPlanItems
							                                                INNER JOIN dbo.ARSOItems ON ARSOItems.ARSOItemID = ARShpPlanItems.FK_ARSOItemID
														                                                AND ARSOItems.AAStatus = 'Alive'
							                                                INNER JOIN dbo.ARSOs ON ARSOs.ARSOID = ARSOItems.FK_ARSOID
													                                                AND ARSOs.AAStatus = 'Alive'
					                                                WHERE   ARShpPlanItems.AAStatus = 'Alive'
							                                                AND ARShpPlanItems.ARShpPlanItemQty > ARShpPlanItems.ARShpPlanItemOnWO
							                                                AND (ARSOs.ARSOID = {0} OR 0 = {0})
							                                                AND PPWOPItems.FK_ARShpPlanItemID = ARShpPlanItems.ARShpPlanItemID)
                                                GROUP BY PPWOPItems.FK_ARShpPlanItemID", ARSOID);
            return GetDataSet(strQuery);
        }
        // NhamNDH - Group theo Item YCSX
        public DataSet GetSumPPWOPItemQtyByPPWORID(int iPPWORID)
        {
            string strQuery = string.Format(@"  SELECT  SUM(PPWOPItems.PPWOPItemQty) AS PPWOPItemQty,
		                                                dbo.PPWOPItems.FK_PPWORItemID
                                                FROM    dbo.PPWOPItems
                                                        INNER JOIN dbo.PPWOs ON PPWOs.PPWOID = PPWOPItems.FK_PPWOID
                                                                                AND dbo.PPWOs.AAStatus = 'Alive'
                                                WHERE   dbo.PPWOPItems.AAStatus = 'Alive'
		                                                AND EXISTS (SELECT  'x'
					                                                FROM    dbo.PPWORItems
							                                                INNER JOIN dbo.PPWORs ON PPWORs.PPWORID = PPWORItems.FK_PPWORID
													                                                AND PPWORs.AAStatus = 'Alive'
					                                                WHERE   PPWORItems.AAStatus = 'Alive'
							                                               -- AND PPWORItems.PPWORItemQty > PPWORItems.PPWORItemsOnWO
							                                                AND (PPWORs.PPWORID = {0} OR 0 = {0})
							                                                AND PPWOPItems.FK_PPWORItemID = PPWORItems.PPWORItemID
                                                                        )
                                                GROUP BY PPWOPItems.FK_PPWORItemID", iPPWORID);
            return GetDataSet(strQuery);
        }
	}
	#endregion
}