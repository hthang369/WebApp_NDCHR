using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
using System.Globalization;

namespace ExpertERP.BusinessEntities
{
    #region PPInCompleteStatisticItems
    //-----------------------------------------------------------
    //Generated By: GMC Studio
    //Class:PPInCompleteStatisticItemsController
    //Created Date:02 Tháng Mười Hai 2014
    //-----------------------------------------------------------

    public class PPInCompleteStatisticItemsController : BaseBusinessController
    {
        public static CultureInfo culture = new CultureInfo("en-US");
        public PPInCompleteStatisticItemsController()
        {
            dal = new DALBaseProvider("PPInCompleteStatisticItems", typeof(PPInCompleteStatisticItemsInfo));
        }

        #region Lấy thông tin item 
        public DataSet GetAllDataByPeriod(int iPeriod, int iYear, string strModuleName)
        {
            string strQuery = string.Format(@"
                                            SELECT  *
                                            FROM    dbo.PPInCompleteStatisticItems
                                            WHERE   FK_PPInCompleteStatisticID IN (
                                                                                    SELECT  PPInCompleteStatisticID
                                                                                    FROM    dbo.PPInCompleteStatistics
                                                                                    WHERE   AAStatus = 'Alive'
                                                                                            AND MONTH(PPInCompleteStatisticDate) = '{0}'
                                                                                            AND YEAR(PPInCompleteStatisticDate) = '{1}' 
                                                                                            AND AAModule='{2}'
                                                                                 )
                                                   AND AAStatus = 'Alive'
                                            ", iPeriod, iYear, strModuleName);
            return GetDataSet(strQuery);
        }

        public PPInCompleteStatisticItemsInfo GetIncompleteProductQty_ByPeriod(int iICProductID, int iPeriod, string strModuleName)
        {
            string strQuery = string.Format(@"
                                            SELECT  *
                                            FROM    dbo.PPInCompleteStatisticItems
                                            WHERE   FK_PPInCompleteStatisticID IN (
                                                    SELECT  PPInCompleteStatisticID
                                                    FROM    dbo.PPInCompleteStatistics
                                                    WHERE   MONTH(PPInCompleteStatisticDate) = '{1}'
                                                            AND AAModule = '{2}' 
                                                            AND AAStatus='Alive')
                                                    AND FK_ICProductID = '{0}'
                                                    
                                            ", iICProductID, iPeriod, strModuleName);
            DataSet ds = GetDataSet(strQuery);
            if (ds != null)
            {
                if (ds.Tables[0].Rows.Count > 0)
                {
                    return (PPInCompleteStatisticItemsInfo)dal.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
                }
            }
            return null;
        }
        #endregion

        #region Lấy giá trị phân bổ cho NVL dở dang
        public double GetAmtIncompleteMaterial_ByICProductIDAndPeriod(int iICProductID, int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"

                                            SELECT PPInCompleteStatisticItemAmt 
                                            FROM dbo.PPInCompleteStatisticItems
                                            WHERE FK_PPInCompleteStatisticItemParentID IN (
                                                                                            SELECT PPInCompleteStatisticItemID
                                                                                            FROM    dbo.PPInCompleteStatisticItems
                                                                                            WHERE   FK_PPInCompleteStatisticID IN (
                                                                                                    SELECT  PPInCompleteStatisticID
                                                                                                    FROM    dbo.PPInCompleteStatistics
                                                                                                    WHERE   MONTH(PPInCompleteStatisticDate) = '{1}'
                                                                                                            AND YEAR(PPInCompleteStatisticDate) = '{2}'
                                                                                                            AND AAModule = 'IncompleteMaterial'
                                                                                                            AND AAStatus = 'Alive' )
                                                                                                    AND FK_ICProductID = '{0}'
                                                                                                    AND AAStatus = 'Alive'
                                                                                            )
                                            ", iICProductID, iPeriod, iYear);
            DataSet ds = GetDataSet(strQuery);
            double dAmt = 0;
            if (ds != null && ds.Tables[0].Rows.Count > 0)
            {
                dAmt = Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return dAmt;
        }
        #endregion

        public DataSet GetProductQtyTotIncompleteStatistic_ByPeriod(int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"
                                            SELECT  SUM(PPInCompleteStatisticItemQty) PPInCompleteStatisticItemQty,
                                                    FK_PPCostCenterID
                                            FROM    dbo.PPInCompleteStatisticItems
                                            WHERE   FK_PPInCompleteStatisticID IN ( SELECT  PPInCompleteStatisticID
                                                                        FROM    dbo.PPInCompleteStatistics
                                                                        WHERE   MONTH(PPInCompleteStatisticDate) = '{0}'
                                                                                AND YEAR(PPInCompleteStatisticDate) = '{1}'
                                                                                AND AAModule = 'InCompleteStatistic'
                                                                                AND AAStatus='Alive'
                                                                        )
                                                                        
                                                    AND AAStatus='Alive'
                                            GROUP BY FK_PPCostCenterID
										
                                            ", iPeriod, iYear);
            return GetDataSet(strQuery);
        }

        public DataSet GetAllDataChildOBWIPByProductID(int pICProductID, int pPeriod, int pYear, string pModuleName, int pPPCostCenterID)
        {
            string strQuery = string.Format(@"   
                                            SELECT  ISNULL(SUM(PPInCompleteStatisticItemQty),0)  PPInCompleteStatisticItemQty ,
                                                    ISNULL(SUM(PPInCompleteStatisticItemAmt),0) PPInCompleteStatisticItemAmt
                                            FROM    dbo.PPInCompleteStatisticItems
                                            WHERE   FK_PPInCompleteStatisticItemParentID IN (
                                                    SELECT  PPInCompleteStatisticItemID
                                                    FROM    dbo.PPInCompleteStatisticItems
                                                    WHERE   FK_PPInCompleteStatisticID IN (
                                                            SELECT  PPInCompleteStatisticID
                                                            FROM    dbo.PPInCompleteStatistics
                                                            WHERE   MONTH(PPInCompleteStatisticDate) = {1}
                                                                    AND YEAR(PPInCompleteStatisticDate) = {2}
                                                                    AND AAModule = '{3}'
                                                                    AND AAStatus = 'Alive' 
                                                                    
                                                                                            )
                                                            AND FK_ICProductID = '{0}' 
                                                            AND FK_PPCostCenterID={4}
                                                    )
                                            ", pICProductID, pPeriod, pYear, pModuleName, pPPCostCenterID);
            return GetDataSet(strQuery);
        }

        public DataSet GetAllDataChildByProductIDAndPPCostCenter(int pICProductID, int pPeriod, int pYear, string pModuleName, int pPPCostCenterID)
        {
            string strQuery = string.Format(@"   
                                            SELECT  *
                                            FROM    dbo.PPInCompleteStatisticItems
                                            WHERE   FK_PPInCompleteStatisticItemParentID IN (
                                                    SELECT  PPInCompleteStatisticItemID
                                                    FROM    dbo.PPInCompleteStatisticItems
                                                    WHERE   FK_PPInCompleteStatisticID IN (
                                                            SELECT  PPInCompleteStatisticID
                                                            FROM    dbo.PPInCompleteStatistics
                                                            WHERE   MONTH(PPInCompleteStatisticDate) = {1}
                                                                    AND YEAR(PPInCompleteStatisticDate) = {2}
                                                                    AND AAModule = '{3}'
                                                                    AND AAStatus = 'Alive' 
                                                                    
                                                                                            )
                                                            AND FK_ICProductID = '{0}' 
                                                            AND FK_PPCostCenterID={4}
                                                    )
                                            ", pICProductID, pPeriod, pYear, pModuleName, pPPCostCenterID);
            return GetDataSet(strQuery);
        }

        public void UpdateAmtInCompleteStatisticItemsByCostCenterIDAndCostFactorID(int iPeriod, int iYear, string strModuleName, int pPPCostCenterID, int pPPCostFactorID, double pPPIncompleteStatisticItemAmt)
        {
            string strQuery = string.Format(culture, @"
                                                    UPDATE dbo.PPInCompleteStatisticItems SET
                                                    PPInCompleteStatisticItemAmt = {5}
                                                    WHERE FK_PPInCompleteStatisticID IN(SELECT  PPInCompleteStatisticID
                                                                                                                                        FROM    dbo.PPInCompleteStatistics
                                                                                                                                        WHERE   AAStatus = 'Alive'
                                                                                                                                                AND MONTH(PPInCompleteStatisticDate) = '{0}'
                                                                                                                                                AND YEAR(PPInCompleteStatisticDate) = '{1}' 
                                                                                                                                                AND AAModule='{2}')
                                                    AND AAStatus = 'Alive' AND PPInCompleteStatisticItems.FK_PPCostCenterID = {3}
                                                    AND FK_PPCostFactorID = {4}
                                                    ", iPeriod, iYear, strModuleName, pPPCostCenterID, pPPCostFactorID, pPPIncompleteStatisticItemAmt);
            GMCDbUtil.ExecuteQuery(strQuery);
        }

        public DataSet GetAllDataChildByPPInCompleteStatisticItemParentID(string[] arrInCompleteStatisticItemParentID)
        {
            string strQuery = string.Format(@"
                                            SELECT  *
                                            FROM    dbo.PPInCompleteStatisticItems
                                            WHERE   FK_PPInCompleteStatisticItemParentID IN ({0})
                                            ", string.Join(",", arrInCompleteStatisticItemParentID) );
            return GetDataSet(strQuery);
        }

        public double GetQtyTotIncompleteStatisticItemByProductAndCostCenter(int pICProductID, int pPeriod, int pYear, string pModuleName, int pPPCostCenterID)
        {
            string strQuery = string.Format(@"
                                                    SELECT  childs.PPInCompleteStatisticItemQty
                                                    FROM    PPInCompleteStatisticItems childs
                                                            JOIN PPInCompleteStatistics main ON childs.FK_PPInCompleteStatisticID = main.PPInCompleteStatisticID
                                                                                                AND main.AAStatus = 'Alive'
                                                                                                AND MONTH(PPInCompleteStatisticDate) = {1}
                                                                                                AND YEAR(PPInCompleteStatisticDate) = {2}
                                                                                                AND main.AAModule = '{3}'
                                                    WHERE   childs.AAStatus = main.AAStatus
                                                            AND childs.FK_PPCostCenterID = {4}
				                                            AND childs.FK_ICProductID = {0}
                                            ", pICProductID, pPeriod, pYear, pModuleName, pPPCostCenterID);
            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }


    }
    #endregion
}