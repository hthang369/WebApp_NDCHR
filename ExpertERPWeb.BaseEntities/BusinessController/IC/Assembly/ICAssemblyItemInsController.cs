using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ICAssemblyItemIns
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ICAssemblyItemInsController
	//Created Date:Monday, November 07, 2011
	//-----------------------------------------------------------
	
	public class ICAssemblyItemInsController:BaseBusinessController
	{
		public ICAssemblyItemInsController()
		{
			dal= new DALBaseProvider("ICAssemblyItemIns",typeof(ICAssemblyItemInsInfo));
		}

        public DataSet GetAssemblyItemInsInRangeTime(int iBranchID, int iProductID, int iStockID, DateTime dtFrom, DateTime dtTo)
        {
            String strQuery = String.Format(@"Select Sum(ICAssemblyItemInQty) as Qty, SUM(ICAssemblyItemInCostTot) As CostTot
                                                From ICAssemblyItemIns 
                                                WHERE AAStatus = 'Alive' 
                                                AND FK_ICProductID = {0}
                                                AND FK_ICAssemblyID IN
	                                                (Select ICAssemblyID from ICAssemblys 
	                                                where AAStatus = 'Alive'  
	                                                AND convert(varchar(10), ICAssemblyDate, 112) Between '{1}' And '{2})' 
	                                                )",
                                                   iProductID,
                                                   dtFrom.ToString("yyyyMMdd"),
                                                   dtTo.ToString("yyyyMMdd"));

            if (iBranchID != 0)// cho mot chi nhanh cu the
            {
                if (iStockID != 0)
                    strQuery += String.Format(" AND FK_ICStockID = {0}", iStockID);
                else
                    strQuery += String.Format(" AND FK_ICStockID IN (SELECT ICStockID FROM ICStocks WHERE FK_BRBranchID = {0} AND AASTatus = 'Alive')", iBranchID);
            }
            else// cho toan bo chi nhanh
            {
                if (iStockID != 0)
                    strQuery += String.Format(" AND FK_ICStockID = {0}", iStockID);
            }

            return dal.GetDataSet(strQuery);
        }

        public DataSet GetSumQtyAndCostTotByStockIDProductIDAndPeriodAndYear(int iICStockID, int iICProductID, int iPeriod, int iYear)
        {
            String strQuery = String.Format("SELECT SUM(ICAssemblyItemInQty) as Qty, SUM(ICAssemblyItemInCostTot) as CostTot FROM ICAssemblyItemIns WHERE AAStatus = 'Alive' AND FK_ICProductID = {0} AND FK_ICStockID = {1}", iICProductID, iICStockID);
            String strQueryAssemblyAlive = String.Format("SELECT ICAssemblyID FROM ICAssemblys WHERE AAStatus = 'Alive' AND Month(ICAssemblyDate) = {0} AND Year(ICAssemblyDate) = {1}", iPeriod, iYear);

            strQuery += String.Format(" AND FK_ICAssemblyID IN ({0})", strQueryAssemblyAlive);

            return dal.GetDataSet(strQuery);
        }

        public DataSet GetSumQtyAndCostTotByProductIDAndPeriodAndYear(int iICProductID, int iPeriod, int iYear)
        {
            String strQuery = String.Format("SELECT SUM(ICAssemblyItemInQty) as Qty, SUM(ICAssemblyItemInCostTot) as CostTot FROM ICAssemblyItemIns WHERE AAStatus = 'Alive' AND FK_ICProductID = {0}", iICProductID);
            String strQueryAssemblyAlive = String.Format("SELECT ICAssemblyID FROM ICAssemblys WHERE AAStatus = 'Alive' AND Month(ICAssemblyDate) = {0} AND Year(ICAssemblyDate) = {1}", iPeriod, iYear);

            strQuery += String.Format(" AND FK_ICAssemblyID IN ({0})", strQueryAssemblyAlive);

            return dal.GetDataSet(strQuery);
        }
	}
	#endregion
}