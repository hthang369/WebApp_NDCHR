using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ICAssemblyItemOuts
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ICAssemblyItemOutsController
	//Created Date:Monday, November 07, 2011
	//-----------------------------------------------------------
	
	public class ICAssemblyItemOutsController:BaseBusinessController
	{
		public ICAssemblyItemOutsController()
		{
			dal= new DALBaseProvider("ICAssemblyItemOuts",typeof(ICAssemblyItemOutsInfo));
		}

        public DataSet GetAssemblyItemOutsInRangeTime(int iBranchID, int iProductID, int iStockID, DateTime dtFrom, DateTime dtTo)
        {
            String strQuery = String.Format(@"Select Sum(ICAssemblyItemOutQty) as Qty, SUM(ICAssemblyItemOutCostTot) As CostTot
                                                From ICAssemblyItemOuts 
                                                WHERE AAStatus = 'Alive' 
                                                AND FK_ICProductID = {0}
                                                AND FK_ICAssemblyID IN
	                                                (Select ICAssemblyID from ICAssemblys 
	                                                where AAStatus = 'Alive'  
	                                                AND convert(varchar(10), ICAssemblyDate, 112) Between '{1}' And '{2})' 
	                                                )",
                                                   iProductID,
                                                   dtFrom.ToString("yyyyMMdd"),
                                                   dtTo.ToString("yyyyMMdd"));

            if (iBranchID != 0)// cho mot chi nhanh cu the
            {
                if (iStockID != 0)
                    strQuery += String.Format(" AND FK_ICStockID = {0}", iStockID);
                else
                    strQuery += String.Format(" AND FK_ICStockID IN (SELECT ICStockID FROM ICStocks WHERE FK_BRBranchID = {0} AND AASTatus = 'Alive')", iBranchID);
            }
            else// cho toan bo chi nhanh
            {
                if (iStockID != 0)
                    strQuery += String.Format(" AND FK_ICStockID = {0}", iStockID);
            }

            return dal.GetDataSet(strQuery);
        }

        public Double GetSumQtyByStockIDProductIDInPeriod(int iICStockID, int iICProductID, int iPeriod, int iYear)
        {
            String strQuery = String.Format("SELECT SUM(ICAssemblyItemOutQty) FROM ICAssemblyItemOuts WHERE AAStatus = 'Alive' AND FK_ICProductID = {0} AND FK_ICStockID = {1}", iICProductID, iICStockID);
            String strQueryAssemblyInPeriod = String.Format("SELECT ICAssemblyID FROM ICAssemblys WHERE AAStatus = 'Alive' AND Month(ICAssemblyDate) = {0} AND Year(ICAssemblyDate) = {1}", iPeriod, iYear);

            strQuery += String.Format(" AND FK_ICAssemblyID IN ({0})", strQueryAssemblyInPeriod);

            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;

        }

        public Double GetSumQtyByProductIDInPeriod(int iICProductID, int iPeriod, int iYear)
        {
            String strQuery = String.Format("SELECT SUM(ICAssemblyItemOutQty) FROM ICAssemblyItemOuts WHERE AAStatus = 'Alive' AND FK_ICProductID = {0}", iICProductID);
            String strQueryAssemblyInPeriod = String.Format("SELECT ICAssemblyID FROM ICAssemblys WHERE AAStatus = 'Alive' AND Month(ICAssemblyDate) = {0} AND Year(ICAssemblyDate) = {1}", iPeriod, iYear);

            strQuery += String.Format(" AND FK_ICAssemblyID IN ({0})", strQueryAssemblyInPeriod);

            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);

            return 0;

        }

        public DataSet GetAllObjectByTypeInRange(DateTime dtFromDate,DateTime dtToDate,string strType)
        {
            string strQuery = String.Format(@"Select * from ICAssemblyItemOuts where AAStatus='Alive' AND FK_ICAssemblyID 
                                                    in (Select ICAssemblyID from ICAssemblys where AAStatus='Alive' and ICAssemblyTypeCombo='{0}'
                                                        AND CONVERT(VARCHAR(10), [ICAssemblyDate], 112)>= CONVERT(VARCHAR(10), '{1}', 112)
                                                        AND CONVERT(VARCHAR(10), [ICAssemblyDate], 112)<= CONVERT(VARCHAR(10), '{2}', 112)  
                                                        )", strType, dtFromDate.ToString("yyyyMMdd"), dtToDate.ToString("yyyyMMdd"));
            return dal.GetDataSet(strQuery);
        }

	}
	#endregion
}