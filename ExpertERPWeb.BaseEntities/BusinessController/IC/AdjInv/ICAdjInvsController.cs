using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ICAdjInvs
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ICAdjInvsController
	//Created Date:04 Tháng Mười Một 2009
	//-----------------------------------------------------------
	
	public class ICAdjInvsController:BaseBusinessController
	{
		public ICAdjInvsController()
		{
			dal= new DALBaseProvider("ICAdjInvs",typeof(ICAdjInvsInfo));
		}

        public DataSet GetAllAdjInvInPeriod(int iPeriod, int iYear, int iStockID)
        {
            String strQuery = String.Format(@"SELECT * FROM ICAdjInvs 
                                                    WHERE AAStatus = 'Alive'
                                                    AND MONTH(ICAdjInvDate) = {0} 
                                                    AND YEAR(ICAdjInvDate) = {1}
                                                    ", iPeriod, iYear);

            if (iStockID > 0)
            {
                strQuery += String.Format(@" AND ICAdjInvID IN (SELECT FK_ICAdjInvID FROM ICAdjInvItems WHERE AAStatus = 'Alive'
                                                                AND ICAdjInvItems.FK_ICStockID = {0})",iStockID);
            }

            strQuery += String.Format(@" ORDER BY ICAdjInvDate");

            return dal.GetDataSet(strQuery);
        }

        public DataSet GetAllAdjustment_InPeriod(int iPeriod, int iYear,string status)
        {
            String str = String.Format(@"   SELECT * FROM dbo.ICAdjInvs
                                            WHERE AAStatus='Alive'
                                            AND YEAR(ICAdjInvDate)*12 + MONTH(ICAdjInvDate) = {0}
                                            AND (AAPostStatus IS NULL OR AAPostStatus = N'{1}')", iYear * 12 + iPeriod, status);
            return dal.GetDataSet(str);
        }

        #region Giá Thành Mới
        public DataSet GetAllAdjInvInPeriodNotInCostCenterActive(int iYear, int iPeriod)
        {
            String strQuery = String.Format(@"  SELECT  *
                                                FROM    dbo.ICAdjInvs
                                                        INNER JOIN dbo.ICAdjInvItems ON ( ICAdjInvItems.FK_ICAdjInvID = ICAdjInvs.ICAdjInvID
                                                                                            AND ICAdjInvItems.AAStatus = ICAdjInvs.AAStatus
                                                                                            AND ICAdjInvs.AAStatus = 'Alive'											
                                                                                            AND YEAR(ICAdjInvDate) = {0}
                                                                                            AND MONTH(ICAdjInvDate) = {1}
                                                                                            AND FK_PPCostCenterID NOT IN (
																		                                                SELECT  FK_PPCostCenterID
																		                                                FROM    dbo.PPProductionCostCenterActives
																		                                                WHERE   PPYear = {0}
																				                                                AND PPPeriod = {1} )
                                                                                          )
                                                ", iYear, iPeriod);

            return dal.GetDataSet(strQuery);
        }
        #endregion
        public DataSet GetDataSetICAdjInvsByICProductIDAndFDateTDate(int iCProductID, DateTime dteFDate, DateTime dteTDate)
        {
            DataSet dsICAdjInvs = new DataSet();
            String strQuery = String.Format("SELECT * FROM [dbo].[ICAdjInvs]WHERE [ICAdjInvID] in(SELECT FK_ICAdjInvID FROM [dbo].ICAdjInvItems WHERE [FK_ICProductID]={0} AND [AAStatus]='{3}')AND  [ICAdjInvDate] >= '{1}'AND [ICAdjInvDate] <= '{2}' AND [AAStatus]='{3}'", iCProductID, dteFDate.ToString("yyyyMMdd"), dteTDate.ToString("yyyyMMdd"), BusinessObject.DefaultAAStatus);
            dsICAdjInvs = dal.GetDataSet(strQuery);
            if (dsICAdjInvs != null)
                return dsICAdjInvs;
            return dsICAdjInvs;
        }
    }
	#endregion
}