using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
using System.Globalization;
namespace ExpertERP.BusinessEntities
{
	#region ICAdjInvItems
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ICAdjInvItemsController
	//Created Date:04 Tháng Mười Một 2009
	//-----------------------------------------------------------
	
	public class ICAdjInvItemsController:BaseBusinessController
	{
        public static CultureInfo culture = new CultureInfo("en-US");

		public ICAdjInvItemsController()
		{
			dal= new DALBaseProvider("ICAdjInvItems",typeof(ICAdjInvItemsInfo));
		}

        public void UpdateValuationToAdjInvItems(int iStockID, int iProductId, int iPeriod, int iYear, double dUnitCost, String strAdjInvType)
        {
            String strQuery = String.Format(culture, @"UPDATE ICAdjInvItems SET ICAdjInvItemUnitCost = {0}, ICAdjInvItemCostTot = Round({0} * ICAdjInvItemQty, 0)
                                                                    WHERE AAStatus = 'Alive' 
                                                                    AND FK_ICProductID = {1}
                                                                    AND ICAdjInvItemTypeCombo = '{2}'
                                                                    AND 
                                                                    FK_ICAdjInvID IN 
                                                                        (SELECT ICAdjInvID FROM ICAdjInvs WHERE AASTatus = 'Alive'
                                                                                            AND Month(ICAdjInvDate) = {3} AND Year(ICAdjInvDate) = {4}
                                                                        )",
                                                                  dUnitCost, iProductId, strAdjInvType, iPeriod, iYear);

            if (iStockID > 0)
                strQuery += String.Format(@" AND FK_ICStockID = {0}", iStockID);

            dal.GetDataSet(strQuery);
        }

        public double GetSUMCostTotAdjInvItems(int iStockID, int iProductId, int iPeriod, int iYear, String strAdjInvType)
        {
            String strQuery = String.Format(culture, @" SELECT SUM(ICAdjInvItemCostTot)
                                                        FROM ICAdjInvItems
                                                        WHERE AAStatus = 'Alive' 
                                                        AND FK_ICProductID = {0}
                                                        AND ICAdjInvItemTypeCombo = '{1}'
                                                        AND 
                                                        FK_ICAdjInvID IN 
                                                            (SELECT ICAdjInvID FROM ICAdjInvs WHERE AASTatus = 'Alive'
                                                                                AND Month(ICAdjInvDate) = {2} AND Year(ICAdjInvDate) = {3}
                                                            )", iProductId, strAdjInvType, iPeriod, iYear);

            if (iStockID > 0)
                strQuery += String.Format(@" AND FK_ICStockID = {0}", iStockID);

            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
            {
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            }
            return 0;
        }

        public DataSet GetDataDecByStockANDProductANDDate(int iStockID, int iProductID, DateTime dtFrom, DateTime dtTo)
        {
            String str = String.Format(@"   SELECT * FROM dbo.ICAdjInvItems
                                            WHERE AAStatus = 'Alive'
                                            AND ICAdjInvItemTypeCombo LIKE 'DecQty'
                                            AND (FK_ICStockID  = {0} OR {0} = 0)
                                            AND (FK_ICProductID = {1} OR {1} = 0)
                                            AND FK_ICAdjInvID IN (
						                                            SELECT ICAdjInvID 
						                                            FROM dbo.ICAdjInvs
						                                            WHERE AAStatus = 'Alive'
						                                            AND CONVERT(NVARCHAR(10), ICAdjInvDate, 112) >= '{2}'
						                                            AND CONVERT(NVARCHAR(10), ICAdjInvDate, 112) <= '{3}'
						                                            )", iStockID, iProductID, dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"));
            return dal.GetDataSet(str);
        }

        public DataSet GetAllDataByDate(DateTime dtFrom, DateTime dtTo)
        {
            String str = String.Format(@"   SELECT * FROM dbo.ICAdjInvItems
                                            WHERE AAStatus = 'Alive'
                                            AND FK_ICAdjInvID IN (
						                                            SELECT ICAdjInvID 
						                                            FROM dbo.ICAdjInvs
						                                            WHERE AAStatus = 'Alive'
						                                            AND CONVERT(NVARCHAR(10), ICAdjInvDate, 112) >= '{0}'
						                                            AND CONVERT(NVARCHAR(10), ICAdjInvDate, 112) <= '{1}'
						                                            )", dtFrom.ToString("yyyyMMdd"), dtTo.ToString("yyyyMMdd"));
            return dal.GetDataSet(str);
        }

        #region Giá Thành Mới --Vinh
        public void UpdateCostTotAdjInvItems(int iICProductID, int iPeriod, int iYear, double dbUnitCost, double dbFUnitCost, String strAdjInvType)
        {
            String strQuery = String.Format(@" UPDATE  ICAdjInvItems
                                                        SET     ICAdjInvItemUnitCost = {0} ,
                                                                ICAdjInvItemCostTot = ROUND({0} * ICAdjInvItemQty, 0),
                                                                ICAdjInvItemFCostTot = {5} * ICAdjInvItemQty
                                                        WHERE   AAStatus = 'Alive'
                                                                AND FK_PPCostCenterID NOT IN (
                                                                                                SELECT FK_PPCostCenterID FROM dbo.PPProductionCostCenterActives
                                                                                                WHERE PPPeriod = {3}
                                                                                                AND PPYear = {4}
                                                                                              )
                                                                AND FK_ICProductID = {1}
                                                                AND ICAdjInvItemTypeCombo = '{2}'
                                                                AND FK_ICAdjInvID IN ( SELECT   ICAdjInvID
                                                                                        FROM     ICAdjInvs
                                                                                        WHERE    AAStatus = 'Alive'
                                                                                                AND MONTH(ICAdjInvDate) = {3}
                                                                                                AND YEAR(ICAdjInvDate) = {4} )"
, dbUnitCost.ToString(System.Globalization.CultureInfo.InvariantCulture)
, iICProductID
, strAdjInvType
, iPeriod
, iYear
, dbFUnitCost.ToString(System.Globalization.CultureInfo.InvariantCulture));
            dal.GetDataSet(strQuery);
        }

        public DataSet GetSumQtyAndCostTotByProductIDAndPeriodAndYear(int iICProductID, int iPeriod, int iYear, String strAdjInvType)
        {
            String strQuery = String.Format(@"  SELECT SUM(ICAdjInvItemQty) as Qty, 
                                                SUM(ICAdjInvItemCostTot) as CostTot 
                                                FROM ICAdjInvItems 
                                                WHERE AAStatus = 'Alive' 
                                                AND FK_ICProductID = {0}
                                                AND ICAdjInvItemTypeCombo = '{1}'
                                                AND FK_ICAdjInvID IN (
                                                    SELECT ICAdjInvID 
                                                    FROM ICAdjInvs 
                                                    WHERE AAStatus = 'Alive' 
                                                    AND MONTH(ICAdjInvDate) = {2} 
                                                    AND YEAR(ICAdjInvDate) = {3})", iICProductID, strAdjInvType, iPeriod, iYear);

            return dal.GetDataSet(strQuery);
        }
        #endregion
        
	}
	#endregion
}