using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ICROItems
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ICROItemsController
	//Created Date:28 Tháng Hai 2013
	//-----------------------------------------------------------
	
	public class ICROItemsController:BaseBusinessController
	{
		public ICROItemsController()
		{
			dal= new DALBaseProvider("ICROItems",typeof(ICROItemsInfo));
		}

        public DataSet GetAllDataByPOBOMItem(int iPOBOMItemID)
        {
            String strQuery = String.Format(@"SELECT * FROM ICROItems WHERE AAStatus='Alive' AND FK_ICROID IN (SELECT ICROID FROM ICROs WHERE AAStatus='Alive') AND FK_APPOBOMItemID={0}", iPOBOMItemID);
            return GetDataSet(strQuery);
        }

        public DataSet GetItemICROByID(int ObjectID)
        {
            String strQuery = String.Format(@"SELECT * FROM dbo.ICROItems WHERE AAStatus='Alive' AND FK_ICROID = {0}", ObjectID);
            return dal.GetDataSet(strQuery);
        }

        public DataSet GetAllDataByAPSupplierAndICProduct(int iSupplierID, int iICProductID)
        {
            String strQuery = String.Format(@"SELECT * FROM dbo.ICROItems WHERE FK_ICROID IN
                    (SELECT dbo.ICROs.ICROID FROM dbo.ICROs WHERE FK_APPOID IN 
                    (SELECT dbo.APPOs.APPOID FROM dbo.APPOs WHERE FK_APSupplierID ={0} AND dbo.APPOs.AAStatus='Alive')
                    AND dbo.ICROs.AAStatus='Alive') AND dbo.ICROItems.AAStatus='Alive' AND FK_ICProductID={1}",iSupplierID,iICProductID);
            return GetDataSet(strQuery);
        }


        public double GetTotalQtyByWOProductAndProductParent(int iWO, int iICProductID, int iParentProductID)
        {
            string strQuery = string.Format(@"SELECT SUM(ICROItemQty) FROM dbo.ICROItems
                                                    WHERE FK_PPWOID={0}
                                                    AND (FK_ICProductID={1} or {1}=0)
                                                    AND (FK_ICProductIDWO={2} or {2}=0)
                                                    AND AAStatus='Alive'
                                                AND FK_ICROID in (Select ICROID from ICROs where AAStatus='Alive')", iWO, iICProductID, iParentProductID);
            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            return 0;
        }
        // NhamNDH add -25/11/2016- Move Lệnh sản xuất từ CHF
        public DataSet GetAllDataNotCompleteByWO(int iPPWOID)
        {
            string strQuery = string.Format(@"
                    SELECT  *
                    FROM    dbo.ICROItems
                            INNER JOIN dbo.ICROs ON ICROItems.FK_ICROID = ICROs.ICROID
                                                    AND ICROItems.AAStatus = ICROs.AAStatus
                                                    AND ICROItems.AAStatus = 'Alive'
                            INNER JOIN dbo.PPProductionOrdrs ON ICROs.FK_PPProductionOrdrID = PPProductionOrdrs.PPProductionOrdrID
                                                                AND ICROs.AAStatus = PPProductionOrdrs.AAStatus
                                                                AND ICROs.AAStatus = 'Alive'
                                                                AND PPProductionOrdrs.FK_PPWOID = {0}
                    WHERE   ICROItems.ICROItemRQty > 0", iPPWOID);
            return GetDataSet(strQuery);
        }
        // NhamNDH add -28/11/2016- Move Phiếu sản xuất vs Kết quả sản xuất từ CHF
        public ICROItemsInfo GetObjectByTransferItem(int iICTransferItemIC)
        {
            string strQuery = String.Format(@"  SELECT  *
                                                FROM    dbo.ICROItems
                                                        INNER JOIN dbo.ICTransferItemROItems ON ICTransferItemROItems.FK_ICROItemID = ICROItems.ICROItemID
                                                                                                AND ICTransferItemROItems.AAStatus = ICROItems.AAStatus
                                                                                                AND ICTransferItemROItems.AAStatus = 'Alive'
                                                WHERE   ICTransferItemROItems.FK_ICTransferItemID = {0}", iICTransferItemIC);

            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                return (ICROItemsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            else
                return null;

        }
        // NhamNDH add -28/11/2016- Move Phiếu sản xuất từ CHF
        public DataSet GetROProductionNotCompleteByProductionOrdrID(int iPPProductionOrdrID)
        {
            string strQuery = string.Format(@"
            SELECT  *
            FROM    dbo.ICROItems
                    INNER JOIN dbo.ICROs ON ICROs.ICROID = ICROItems.FK_ICROID
                                            AND ICROs.AAStatus = ICROItems.AAStatus
                                            AND ICROs.AAStatus = 'Alive'
                                            AND ICROs.FK_PPProductionOrdrID = {0}
								            AND ICROs.AAModule = 'ROProductionOrdr'
            WHERE   ICROItems.ICROItemRQty > 0"
                                , iPPProductionOrdrID);
            return GetDataSet(strQuery);
        }
        // NhamNDH add -28/11/2016- Move Phiếu sản xuất từ CHF
        public DataSet GetROTransferNotCompleteByProductionOrdrID(int iPPProductionOrdrID)
        {
            string strQuery = string.Format(@"
            SELECT  *
            FROM    dbo.ICROItems
                    INNER JOIN dbo.ICROs ON ICROs.ICROID = ICROItems.FK_ICROID
                                            AND ICROs.AAStatus = ICROItems.AAStatus
                                            AND ICROs.AAStatus = 'Alive'
                                            AND ICROs.FK_PPProductionOrdrID = {0}
								            AND ICROs.AAModule = 'ROTransfer'
            WHERE   ICROItems.ICROItemRQty > 0"
                    , iPPProductionOrdrID);
            return GetDataSet(strQuery);
        }
        //
    }
	#endregion
}