using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region FAAssetDeprs
	//-----------------------------------------------------------
	//Generated By: Expert Studio
	//Class:FAAssetDeprsController
	//Created Date:Tuesday, April 05, 2011
	//-----------------------------------------------------------
	
	public class FAAssetDeprsController:BaseBusinessController
	{
		public FAAssetDeprsController()
		{
			dal= new DALBaseProvider("FAAssetDeprs",typeof(FAAssetDeprsInfo));
		}

        public DataSet GetDatasetDeprInYear(int iYear)
        {
            String strQuery = String.Format("SELECT * FROM FAAssetDeprs WHERE FAYear = {0} AND AAStatus = 'Alive'", iYear);
            return dal.GetDataSet(strQuery);
        }

        public DataSet GetDatasetDeprInPeriod(int iPeriod, int iYear)
        {
            String strQuery = String.Format("SELECT * FROM FAAssetDeprs WHERE FAPeriod = {0} AND FAYear = {1} AND AAStatus = 'Alive'", iPeriod, iYear);
            return dal.GetDataSet(strQuery);
        }

        public FAAssetDeprsInfo GetAssetDeprInPeriod(int iPeriod, int iYear)
        {
            String strQuery = String.Format("SELECT * FROM FAAssetDeprs WHERE FAPeriod = {0} AND FAYear = {1} AND AAStatus = 'Alive'", iPeriod, iYear);
            DataSet ds = dal.GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                return (FAAssetDeprsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);


            return null;
        }

        public DataSet GetAllDataInRange(DateTime fromDate, DateTime toDate)
        {
            String strDate = DALUtil.GenerateBeetween("FAAssetDeprDate", fromDate, toDate);
            string query = String.Format("SELECT * FROM FAAssetDeprs WHERE AAStatus = 'Alive' AND {0}", strDate);

            DataSet ds = dal.GetDataSet(query);
            return ds;
        }

        /// <summary>
        /// Lấy danh sách phiếu khấu hao của một tài sản được lập sau ngày truyền vào dtFAAssetDeprDate.
        /// </summary>
        /// <param name="iFAAssetID"></param>
        /// <param name="dtFAAssetDeprDate"></param>
        /// <returns></returns>
        public DataSet GetAllDataByAssetAfterDate(int iFAAssetID, DateTime dtFAAssetDeprDate)
        {
            string strQuery = string.Format(@"SELECT  *
                            FROM    dbo.FAAssetDeprs
                            WHERE   AAStatus='Alive' AND FAAssetDeprID IN ( SELECT   dbo.FAAssetDeprItems.FK_FAAssetDeprID
                                                        FROM     dbo.FAAssetDeprItems
                                                        WHERE    FK_FAAssetID = {0} AND dbo.FAAssetDeprItems.AAStatus='Alive')
                                                        AND CONVERT(NVARCHAR(10), FAAssetDeprDate, 112) > CONVERT(NVARCHAR(10), '{1}', 112)", iFAAssetID, dtFAAssetDeprDate.ToString("yyyyMMdd"));
            return GetDataSet(strQuery);

        }


        public FAAssetDeprsInfo GetLasstAssetDepr()
        {
            string strQuery = string.Format(@"SELECT  TOP 1 *
                                                FROM    dbo.FAAssetDeprs
                                                WHERE   AAStatus = 'Alive'
                                                        AND FAYear * 12 + FAPeriod = ( SELECT   MAX(dbo.FAAssetDeprs.FAYear
                                                                                                    * 12
                                                                                                    + dbo.FAAssetDeprs.FAPeriod)
                                                                                       FROM     dbo.FAAssetDeprs
                                                                                       WHERE    AAStatus = 'Alive'
                                                                                     )");
            DataSet ds = GetDataSet(strQuery);
            FAAssetDeprsInfo objFAAssetDeprInfo = null;
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                objFAAssetDeprInfo = (FAAssetDeprsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }
            return objFAAssetDeprInfo;
        }

        public bool CheckIxistDeprAfterPeriodAndYear(int iPeriod, int iYear)
        {
            string strQuery = string.Format(@"SELECT  *
            FROM    dbo.FAAssetDeprs
            WHERE   AAStatus = 'Alive'
                    AND (FAPeriod + FAYear
                          * 12 ) > ( {0} + {1} * 12 )",iPeriod,iYear);
            DataSet ds = GetDataSet(strQuery);
            bool bIsExist=false;
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                bIsExist = true;
            }
            return bIsExist;
        }


        // V.Hung add 24/08/2015 Lấy kỳ khấu hao sớm nhất
        public FAAssetDeprsInfo LayKyKhauHaoSomNhat()
        {
            string strQuery = string.Format(@"SELECT  TOP 1 *
                                                FROM    dbo.FAAssetDeprs
                                                WHERE   AAStatus = 'Alive'
                                                        AND FAYear * 12 + FAPeriod = ( SELECT   MIN(dbo.FAAssetDeprs.FAYear
                                                                                                    * 12
                                                                                                    + dbo.FAAssetDeprs.FAPeriod)
                                                                                       FROM     dbo.FAAssetDeprs
                                                                                       WHERE    AAStatus = 'Alive'
                                                                                     )");
            DataSet ds = GetDataSet(strQuery);
            FAAssetDeprsInfo objFAAssetDeprInfo = null;
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                objFAAssetDeprInfo = (FAAssetDeprsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            }
            return objFAAssetDeprInfo;
        }

       

    }
	#endregion
}