using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ARSaleForecastItemDetails
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ARSaleForecastItemDetailsController
	//Created Date:Friday, December 11, 2015
	//-----------------------------------------------------------
	
	public class ARSaleForecastItemDetailsController:BaseBusinessController
	{
		public ARSaleForecastItemDetailsController()
		{
			dal= new DALBaseProvider("ARSaleForecastItemDetails",typeof(ARSaleForecastItemDetailsInfo));
		}

        public DataSet GetAllObjectByARForecastID(int iARForecastID)
        {
            String strQuery = String.Format(@" Select *
                                               From ARForecastItemDetails
                                               Where AASatus = 'Alive'
                                           ");

            return GetDataSet(strQuery);
        }

        public double LayGiaTriKeHoachTheoLoai(int iARCustomerID, int iYear,int iMonth, string strWhereWeek, string strWhereProduct, string strDetailGroup, string strIOFCombo)
        {

            String strQuery = String.Format(@"SELECT    SUM(de.ARSaleForecastItemDetailValue)
                                                        * ISNULL(( SELECT   ROUND(SUM(ARInvoiceItemQty)
                                                                                  / ( SELECT    SUM(ARInvoiceQtyTot)
                                                                                      FROM      dbo.ARInvoices s
                                                                                      WHERE     AAStatus = 'Alive'
                                                                                                AND s.FK_ARCustomerID = dbo.ARInvoices.FK_ARCustomerID
                                                                                                AND ( ( YEAR(ARInvoiceDate) = {1}
                                                                                                        AND MONTH(ARInvoiceDate) = {2}
                                                                                                        - 1
                                                                                                      )
                                                                                                      OR ( {2} = 1
                                                                                                           AND YEAR(ARInvoiceDate) = {1}
                                                                                                           - 1
                                                                                                           AND MONTH(ARInvoiceDate) = 12
                                                                                                         )
                                                                                                    )
                                                                                    ) * 100, 0) [Percent]
                                                                   FROM     dbo.ARInvoices
                                                                            JOIN dbo.ARInvoiceItems ON ( ARInvoiceItems.FK_ARInvoiceID = ARInvoices.ARInvoiceID
                                                                                                         AND ARInvoiceItems.AAStatus = ARInvoices.AAStatus
                                                                                                         AND ARInvoiceItems.AAStatus = 'Alive'
                                                                                                       )
                                                                            JOIN dbo.ICProducts ON ( ARInvoiceItems.FK_ICProductID = ICProductID
                                                                                                     AND ICProducts.AAStatus = ARInvoiceItems.AAStatus
                                                                                                     AND ICProducts.AAStatus = 'Alive'
                                                                                                   )
                                                                   WHERE    ARInvoices.FK_ARCustomerID = {3}
                                                                            {4}
                                                                            AND ( ( YEAR(ARInvoiceDate) = {1}
                                                                                    AND MONTH(ARInvoiceDate) = {2} - 1
                                                                                  )
                                                                                  OR ( {2} = 1
                                                                                       AND YEAR(ARInvoiceDate) = {1} - 1
                                                                                       AND MONTH(ARInvoiceDate) = 12
                                                                                     )
                                                                                )
                                                                   GROUP BY ARInvoices.FK_ARCustomerID ,
                                                                            ICProductIOF01Combo
                                                                 ), 0) / 100 
                                                FROM    ARSaleForecasts (NOLOCK) s
                                                        JOIN ARSaleForecastCuss (NOLOCK) CU ON ( s.ARSaleForecastID = CU.FK_ARSaleForecastID
                                                                                                 AND CU.AAStatus = s.AAStatus
                                                                                                 AND CU.AAStatus = 'Alive'
                                                                                               )
                                                        JOIN dbo.ARCustomers (NOLOCK) ON ( ARCustomers.ARCustomerID = CU.FK_ARCustomerID
                                                                                           AND ARCustomers.AAStatus = CU.AAStatus
                                                                                         )
                                                        JOIN dbo.ARSellers (NOLOCK) ON ( ARCustomers.FK_ARSellerID = ARSellers.ARSellerID
                                                                                         AND ARSellers.AAStatus = ARCustomers.AAStatus
                                                                                       )
                                                        JOIN ARSaleForecastItems (NOLOCK) PR ON ( PR.FK_ARSaleForecastCusID = CU.ARSaleForecastCusID
                                                                                                  AND PR.AAStatus = CU.AAStatus
                                                                                                )
                                                        JOIN ARSaleForecastItemDetails (NOLOCK) de ON ( PR.ARSaleForecastItemID = de.FK_ARSaleForecastItemID
                                                                                                        AND de.AAStatus = PR.AAStatus
                                                                                                      )
                                                WHERE   ARSaleForecastItemDetailTypeCombo = 'Month'
                                                        AND de.ARSaleForecastItemDetailGroupCombo = 'Quantity'
                                                        AND s.ARSaleForecastYear = {1}
                                                        AND de.ARSaleForecastItemDetailTypeValue = {2}
                                                        AND CU.FK_ARCustomerID = {3};
                                                           ", strDetailGroup, iYear, iMonth, iARCustomerID, strIOFCombo);

            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            return 0;
        }

        public double LayGiaTriKeHoachTheoLoai_DoanhSo(int iARCustomerID, int iYear, int iMonth, string strWhereWeek, string strWhereProduct, string strDetailGroup, string strIOFCombo)
        {
            String strQuery = String.Format(@"SELECT  ISNULL(SUM(de.ARSaleForecastItemDetailValue),0)
                                                    * ISNULL(( SELECT   ROUND(SUM(ARInvoiceItemQty)
                                                                              / ( SELECT    SUM(ARInvoiceQtyTot)
                                                                                  FROM      dbo.ARInvoices s
                                                                                  WHERE     AAStatus = 'Alive'
                                                                                            AND s.FK_ARCustomerID = dbo.ARInvoices.FK_ARCustomerID
                                                                                            AND ( ( YEAR(ARInvoiceDate) = {1}
                                                                                                    AND MONTH(ARInvoiceDate) = {2}
                                                                                                    - 1
                                                                                                  )
                                                                                                  OR ( {2} = 1
                                                                                                       AND YEAR(ARInvoiceDate) = {1}
                                                                                                       - 1
                                                                                                       AND MONTH(ARInvoiceDate) = 12
                                                                                                     )
                                                                                                )
                                                                                ) * 100,0) [Percent]
                                                               FROM     dbo.ARInvoices
                                                                        JOIN dbo.ARInvoiceItems ON ( ARInvoiceItems.FK_ARInvoiceID = ARInvoices.ARInvoiceID
                                                                                                     AND ARInvoiceItems.AAStatus = ARInvoices.AAStatus
                                                                                                     AND ARInvoiceItems.AAStatus = 'Alive'
                                                                                                   )
                                                                        JOIN dbo.ICProducts ON ( ARInvoiceItems.FK_ICProductID = ICProductID
                                                                                                 AND ICProducts.AAStatus = ARInvoiceItems.AAStatus
                                                                                                 AND ICProducts.AAStatus = 'Alive'
                                                                                               )
                                                               WHERE    ARInvoices.FK_ARCustomerID = {3}
                                                                        {4}
                                                                        AND ( ( YEAR(ARInvoiceDate) = {1}
                                                                                AND MONTH(ARInvoiceDate) = {2} - 1
                                                                              )
                                                                              OR ( {2} = 1
                                                                                   AND YEAR(ARInvoiceDate) = {1} - 1
                                                                                   AND MONTH(ARInvoiceDate) = 12
                                                                                 )
                                                                            )
                                                               GROUP BY ARInvoices.FK_ARCustomerID ,
                                                                        ICProductIOF01Combo
                                                             ), 0) / 100 QtyEst
                                            INTO #Tem1
                                            FROM    ARSaleForecasts (NOLOCK) s
                                                    JOIN ARSaleForecastCuss (NOLOCK) CU ON ( s.ARSaleForecastID = CU.FK_ARSaleForecastID
                                                                                             AND CU.AAStatus = s.AAStatus
                                                                                             AND CU.AAStatus = 'Alive'
                                                                                           )
                                                    JOIN dbo.ARCustomers (NOLOCK) ON ( ARCustomers.ARCustomerID = CU.FK_ARCustomerID
                                                                                       AND ARCustomers.AAStatus = CU.AAStatus
                                                                                     )
                                                    JOIN dbo.ARSellers (NOLOCK) ON ( ARCustomers.FK_ARSellerID = ARSellers.ARSellerID
                                                                                     AND ARSellers.AAStatus = ARCustomers.AAStatus
                                                                                   )
                                                    JOIN ARSaleForecastItems (NOLOCK) PR ON ( PR.FK_ARSaleForecastCusID = CU.ARSaleForecastCusID
                                                                                              AND PR.AAStatus = CU.AAStatus
                                                                                            )
                                                    JOIN ARSaleForecastItemDetails (NOLOCK) de ON ( PR.ARSaleForecastItemID = de.FK_ARSaleForecastItemID
                                                                                                    AND de.AAStatus = PR.AAStatus
                                                                                                  )
                                            WHERE   ARSaleForecastItemDetailTypeCombo = 'Month'
                                                    AND de.ARSaleForecastItemDetailGroupCombo = 'Quantity'
                                                    AND s.ARSaleForecastYear = {1}
                                                    AND de.ARSaleForecastItemDetailTypeValue = {2}
                                                    AND CU.FK_ARCustomerID = {3};
                                            ---- 
                                            SELECT  CASE WHEN SUM(ARInvoiceItemQty) = 0 THEN 0 ELSE ROUND((SUM(ARInvoiceItemAmtTot)
                                                          / SUM(ARInvoiceItemQty)
                                                            ) , 0) END UnitPrice
                                            INTO #Tem2
                                            FROM    dbo.ARInvoices
                                                    JOIN dbo.ARInvoiceItems ON ( ARInvoiceItems.FK_ARInvoiceID = ARInvoices.ARInvoiceID
                                                                                 AND ARInvoiceItems.AAStatus = ARInvoices.AAStatus
                                                                                 AND ARInvoiceItems.AAStatus = 'Alive'
                                                                               )
                                                    JOIN dbo.ICProducts ON ( ARInvoiceItems.FK_ICProductID = ICProductID
                                                                             AND ICProducts.AAStatus = ARInvoiceItems.AAStatus
                                                                             AND ICProducts.AAStatus = 'Alive'
                                                                           )
                                            WHERE   ARInvoices.FK_ARCustomerID = {3}
                                                    {4}
                                                    AND ( ( YEAR(ARInvoiceDate) = {1}
                                                            AND MONTH(ARInvoiceDate) = {2} - 1
                                                          )
                                                          OR ( {2} = 1
                                                               AND YEAR(ARInvoiceDate) = {1} - 1
                                                               AND MONTH(ARInvoiceDate) = 12
                                                             )
                                                        )
                                            GROUP BY ARInvoices.FK_ARCustomerID ,
                                                    ICProductIOF01Combo;
                                            ----- 
                                            SELECT #Tem1.QtyEst*#Tem2.UnitPrice
                                            FROM #Tem1, #Tem2


                                                           ", strDetailGroup, iYear, iMonth, iARCustomerID, strIOFCombo);

            DataSet ds = GetDataSet(strQuery);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0 && ds.Tables[0].Rows[0][0] != DBNull.Value)
                return Convert.ToDouble(ds.Tables[0].Rows[0][0]);
            return 0;
        }

        public ARSaleForecastItemDetailsInfo GetObjectByTypeAndQuater(int iForecastItemID, string strType, int iQuarterOrMonth)
        {
            string strQry = string.Format(@"SELECT * FROM dbo.ARSaleForecastItemDetails, dbo.ARSaleForecastItems
                                            WHERE ARSaleForecastItemDetails.FK_ARSaleForecastItemID = ARSaleForecastItems.ARSaleForecastItemID
                                            AND ARSaleForecastItemDetails.AAStatus = 'Alive'
                                            AND ARSaleForecastItems.AAStatus = 'Alive'
                                            AND ARSaleForecastItems.ARSaleForecastItemID = {0}
                                            AND ARSaleForecastItemDetailTypeValue = {1}
                                            AND ARSaleForecastItemDetailTypeCombo = '{2}'", iForecastItemID, iQuarterOrMonth, strType);
            DataSet ds = GetDataSet(strQry);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                return (ARSaleForecastItemDetailsInfo)GetObjectFromDataRow(ds.Tables[0].Rows[0]);
            else
                return null;
        }
	}
	#endregion
}