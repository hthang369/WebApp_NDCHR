using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ViewGLVouchers
	//-----------------------------------------------------------
	//Generated By: Expert Studio
	//Class:ViewGLVouchersController
	//Created Date:08 Tháng Mười Một 2012
	//-----------------------------------------------------------
	
	public class ViewGLVouchersController:BaseBusinessController
	{
		public ViewGLVouchersController()
		{
			dal= new DALBaseProvider("ViewGLVouchers",typeof(ViewGLVouchersInfo));
		}

        public void InsertViewGLVoucher(GLVouchersInfo VoucherInfo)
        {

            ViewGLVouchersInfo ViewGLVoucher = new ViewGLVouchersInfo();
            ViewGLVouchersController ViewGLVoucherCtrl = new ViewGLVouchersController();
            DataSet ds = ViewGLVoucherCtrl.GetAllDataByForeignColumn("FK_GLVoucherID", VoucherInfo.GLVoucherID);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                ViewGLVouchersInfo viewVouchernfo = (ViewGLVouchersInfo)ViewGLVoucherCtrl.GetObjectFromDataRow(ds.Tables[0].Rows[0]);
                if (viewVouchernfo != null)
                {
                    ViewGLVoucher = viewVouchernfo;
                }
            }
            string strCreditNo = "";
            string strDebitNo = "";
            ViewGLVoucher.FK_GLVoucherID = VoucherInfo.GLVoucherID;
            ViewGLVoucher.ViewGLVoucherPmtPayToName= VoucherInfo.GLOutPmtPayToName;
            ViewGLVoucher.ViewGLPmtPayToDesc = VoucherInfo.GLOutPmtPayToDesc;
            ViewGLVoucher.ViewGLOutPmtDesc = VoucherInfo.GLVoucherDesc;
            ViewGLVoucher.ViewGLPmtAmt = VoucherInfo.GLVoucherPaymentAmtTot;

            Dictionary<int, String> lstDebits = new Dictionary<int, String>();
            Dictionary<int, String> lstCredits = new Dictionary<int, String>();

            GLVoucherItemsController VoucherItemCtrl = new GLVoucherItemsController();
            ds =  VoucherItemCtrl.GetAllDataByForeignColumn("FK_GLVoucherID", VoucherInfo.GLVoucherID);
            if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow dr in ds.Tables[0].Rows)
                {
                    GLVoucherItemsInfo VoucherItemInfo = (GLVoucherItemsInfo)VoucherItemCtrl.GetObjectFromDataRow(dr);
                    if (VoucherItemInfo != null)
                    {
                        if (VoucherItemInfo.FK_GLDebitAccountID!=0)
                        {
                            if (!lstDebits.ContainsKey(VoucherItemInfo.FK_GLDebitAccountID))
                            {
                                GLAccountsInfo AccountInfo=(GLAccountsInfo)new GLAccountsController().GetObjectByID(VoucherItemInfo.FK_GLDebitAccountID);
                                if (AccountInfo!=null)
                                {
                                    lstDebits.Add(VoucherItemInfo.FK_GLDebitAccountID, AccountInfo.GLAccountNo);
                                }
                            }
                                                    
                        }
                        if (VoucherItemInfo.FK_GLDebitVATAccountID !=0)
                        {
                            if (!lstDebits.ContainsKey(VoucherItemInfo.FK_GLDebitVATAccountID))
                            {
                                GLAccountsInfo AccountDebitVAT = (GLAccountsInfo)new GLAccountsController().GetObjectByID(VoucherItemInfo.FK_GLDebitVATAccountID);
                                if (AccountDebitVAT != null)
                                {
                                    lstDebits.Add(VoucherItemInfo.FK_GLDebitVATAccountID, AccountDebitVAT.GLAccountNo);
                                }
                            }
                        }
                        if(VoucherItemInfo.FK_GLCreditAccountID !=0)
                        {
                            if (!lstCredits.ContainsKey(VoucherItemInfo.FK_GLCreditAccountID))
                            {
                                GLAccountsInfo AccountCredit = (GLAccountsInfo)new GLAccountsController().GetObjectByID(VoucherItemInfo.FK_GLCreditAccountID);
                                if (AccountCredit != null)
                                {
                                    lstCredits.Add(VoucherItemInfo.FK_GLCreditAccountID, AccountCredit.GLAccountNo);
                                }
                            }
                        }

                        if (VoucherItemInfo.FK_GLCreditVATAccountID != 0)
                        {
                            if (!lstCredits.ContainsKey(VoucherItemInfo.FK_GLCreditVATAccountID))
                            {
                                GLAccountsInfo AccountCredit = (GLAccountsInfo)new GLAccountsController().GetObjectByID(VoucherItemInfo.FK_GLCreditVATAccountID);
                                if (AccountCredit != null)
                                {
                                    lstCredits.Add(VoucherItemInfo.FK_GLCreditVATAccountID, AccountCredit.GLAccountNo);
                                }
                            }
                        }
                        
                        
                    }
                }
            }
            foreach (int key in lstDebits.Keys)
            {
                if (strDebitNo == "")
                {
                    strDebitNo +=  lstDebits[key];
                }
                else
                strDebitNo += ","+ lstDebits[key];
            }
            foreach (int key in lstCredits.Keys)
            {
                if (strCreditNo == "")
                {
                    strCreditNo += lstCredits[key];
                }
                else
                    strCreditNo += ","+lstCredits[key];
            }
            ViewGLVoucher.ViewGLAccountNoCredit= strCreditNo;
            ViewGLVoucher.ViewGLAccountNoDebit = strDebitNo;
            if (ViewGLVoucher.ViewGLVoucherID==0)
            {
                ViewGLVoucherCtrl.CreateObject(ViewGLVoucher);
            } 
            else
            {
                ViewGLVoucherCtrl.UpdateObject(ViewGLVoucher);
            }
        }
	}
	#endregion
}