using System;
using System.Data;
using System.Text;
using System.Collections.Generic;
using ExpertWebLib;
namespace ExpertERP.BusinessEntities
{
	#region ViewSaleMonitors
	//-----------------------------------------------------------
	//Generated By: GMC Studio
	//Class:ViewSaleMonitorsController
	//Created Date:Saturday, August 22, 2015
	//-----------------------------------------------------------
	
	public class ViewSaleMonitorsController:BaseBusinessController
	{
		public ViewSaleMonitorsController()
		{
			dal= new DALBaseProvider("ViewSaleMonitors",typeof(ViewSaleMonitorsInfo));
		}

        public DataSet GetAllObjectByConditionID(String strCondition, int iARSOItemID)
        {
            String strQuery = String.Format(@" Select *
                                               From ARInvoiceItems
                                               Where AAStatus = 'Alive' AND {0} = {1}   
                                            ", strCondition, iARSOItemID);
            return GetDataSet(strQuery);
        }

        public string QuerySaleMonitor(int type = -1, string iObjectID = "0", string compare = "=")
        {
            string strWhereSO = string.Empty;
            string strWhereShpPlan = string.Empty;
            string strWherePkgOrder = string.Empty;
            string strWhereShipment = string.Empty;
            string strWhereInvoice = string.Empty;
            if (type == 0) strWhereSO = string.Format("WHERE ARSOItemID {0} {1}", compare, iObjectID);
            else if (type == 1) strWhereShpPlan = string.Format("WHERE ARShpPlanItemID {0} {1}", compare, iObjectID);
            else if (type == 2) strWherePkgOrder = string.Format("WHERE PPPkgOrderItemID {0} {1}", compare, iObjectID);
            else if (type == 3) strWhereShipment = string.Format("WHERE ICShipmentItemID {0} {1}", compare, iObjectID);
            else if (type == 4) strWhereInvoice = string.Format("WHERE ARInvoiceItemID {0} {1}", compare, iObjectID);
            string strQuery = @"
                    IF OBJECT_ID('tempdb..#ViewSO') IS NOT NULL
	                    DROP TABLE #ViewSO
                    SELECT  b.FK_ARSOID,ARSOItemID,b.FK_ICProductID,b.FK_ICUOMID,ARCustomerNo,ARCustomerName,
                            ARSOItemQty,ARSOItemRQty,ARSODate,ARSOItemShpDate
                    INTO    #ViewSO
                    FROM    ARSOs a 
                        JOIN ARSOItems b ON a.ARSOID = b.FK_ARSOID AND a.AAStatus = 'Alive' AND b.AAStatus = 'Alive'
                        LEFT JOIN ARCustomers cus ON a.FK_ARCustomerID = cus.ARCustomerID AND cus.AAStatus = 'Alive'
                    {0}

                    --ARShpPlanQty By SOItemID
                    IF OBJECT_ID('tempdb..#ViewShpPlan') IS NOT NULL
	                    DROP TABLE #ViewShpPlan
                    SELECT  ARSOItemID,ARShpPlanID,ARShpPlanItemID,ARShpPlanItemQty
                    INTO    #ViewShpPlan
                    FROM    #ViewSO so 
                        JOIN ARShpPlanItems shplan ON FK_ARSOItemID = ARSOItemID AND shplan.FK_ICProductID = so.FK_ICProductID AND shplan.AAStatus = 'Alive'
                        JOIN ARShpPlans plans ON ARShpPlanID = FK_ARShpPlanID AND plans.AAStatus = 'Alive'
                    {1}

                    --PkgOrderQty By  ARShpPlanItemID
                    IF OBJECT_ID('tempdb..#ViewPkgOrder') IS NOT NULL
	                    DROP TABLE #ViewPkgOrder
                    SELECT  ARSOItemID,PPPkgOrderID,PPPkgOrderItemID,PPPkgOrderItemQty
                    INTO    #ViewPkgOrder
                    FROM    #ViewShpPlan shplan
                        JOIN PPPkgOrderItems pporder ON shplan.ARShpPlanItemID = pporder.FK_ARShpPlanItemID AND pporder.AAStatus = 'Alive'
                        JOIN PPPkgOrders orders ON orders.PPPkgOrderID = FK_PPPkgOrderID AND orders.AAStatus = 'Alive'
                    {2}

                    --ICShipemntQty By PPPKgOrderItemID
                    IF OBJECT_ID('tempdb..#ViewShp') IS NOT NULL
	                    DROP TABLE #ViewShp
                    SELECT  ARSOItemID,ICShipmentID,ICShipmentItemID,ICShipmentItemQty
                    INTO    #ViewShp
                    FROM    #ViewPkgOrder pkg 
                        JOIN ICShipmentItems shpItm ON pkg.PPPkgOrderItemID = shpItm.FK_PPPkgOrderItemID AND shpItm.AAStatus = 'Alive'
                        JOIN ICShipments shp ON ICShipmentID = FK_ICShipmentID AND shp.AAStatus = 'Alive'
                    {3}

                    --ARInvoiceQty By ICShipemntItemID
                    IF OBJECT_ID('tempdb..#ViewInv') IS NOT NULL
	                    DROP TABLE #ViewInv
                    SELECT  ARSOItemID,ARInvoiceID,ARInvoiceItemID,ARInvoiceItemQty
                    INTO    #ViewInv
                    FROM    #ViewShp shp 
                        JOIN ARInvoiceItemShipmentItems invShp ON shp.ICShipmentItemID = invShp.FK_ICShipmentItemID AND invShp.AAStatus = 'Alive'
                        JOIN ARInvoiceItems invItm ON invShp.FK_ARInvoiceItemID = invItm.ARInvoiceItemID AND invItm.AAStatus = 'Alive'
                        JOIN ARInvoices inv ON ARInvoiceID = FK_ARInvoiceID AND inv.AAStatus = 'Alive'
                    {4}";
            return string.Format(strQuery, strWhereSO, strWhereShpPlan, strWherePkgOrder, strWhereShipment, strWhereInvoice);
        }

        public DataSet GetAllSaleMonitor(string strTxtNo, DateTime dtFrom, DateTime dtTo)
        {
            string strSearchDate = DALUtil.GenerateBeetween("ARSODate", dtFrom, dtTo);
            string strWhere = string.Format("WHERE {0}", strSearchDate);
            if (!string.IsNullOrEmpty(strTxtNo))
                strWhere = string.Format("AND ARSONo LIKE '%{0}%'", strTxtNo);
            string strQuery = string.Format(@"
                    {0}

                    SELECT  FK_ARSOID,so.ARSOItemID AS FK_ARSOItemID,FK_ICProductID,FK_ICUOMID,
                            ARShpPlanID AS FK_ARShpPlanID,
                            PPPkgOrderID AS FK_PPPkgOrderID,
                            ICShipmentID AS FK_ICShipmentID,
                            ARInvoiceID AS FK_ARInvoiceID,
                            ARCustomerNo AS ViewSaleMonitorObjectNo,
                            ARCustomerName AS ViewSaleMonitorObjectName,
                            'Customer' AS ViewSaleMonitorObjectType,
                            ARSODate AS ViewSaleMonitorToDate,
                            ARSOItemShpDate AS ViewSaleMonitorShpPlanDate,
		                    ISNULL(ARShpPlanItemQty, 0) ViewSaleMonitorShpPlanQty,
		                    ARShpPlanID AS FK_ARShpPlanID,
		                    PPPkgOrderID AS FK_PPPkgOrderID,
		                    ISNULL(PPPkgOrderItemQty, 0) ViewSaleMonitorPkgOrderQty,
		                    ICShipmentID AS FK_ICShipmentID,
		                    ISNULL(ICShipmentItemQty, 0) ViewSaleMonitorShipmentQty,
		                    ARInvoiceID AS FK_ARInvoiceID,
		                    ISNULL(ARInvoiceItemQty, 0) ViewSaleMonitorInvoiceQty,
                            CASE WHEN ISNULL(ARInvoiceItemQty, 0) = ARSOItemQty THEN 'Hoàn thành'
                               ELSE 'Chưa hoàn thành' END ViewSaleMonitorStatus
                    FROM #ViewSO so
                    LEFT JOIN (
	                    SELECT ARSOItemID,MAX(ARShpPlanID) ARShpPlanID,SUM(ARShpPlanItemQty) ARShpPlanItemQty FROM #ViewShpPlan GROUP BY ARSOItemID) shplan 
                    ON shplan.ARSOItemID = so.ARSOItemID
                    LEFT JOIN (
	                    SELECT ARSOItemID,MAX(PPPkgOrderID) PPPkgOrderID,SUM(PPPkgOrderItemQty) PPPkgOrderItemQty FROM #ViewPkgOrder GROUP BY ARSOItemID) pkgorder 
                    ON pkgorder.ARSOItemID = so.ARSOItemID
                    LEFT JOIN (
	                    SELECT ARSOItemID,MAX(ICShipmentID) ICShipmentID,SUM(ICShipmentItemQty) ICShipmentItemQty FROM #ViewShp GROUP BY ARSOItemID) shp 
                    ON shp.ARSOItemID = so.ARSOItemID
                    LEFT JOIN (
	                    SELECT ARSOItemID,MAX(ARInvoiceID) ARInvoiceID,SUM(ARInvoiceItemQty) ARInvoiceItemQty FROM #ViewInv GROUP BY ARSOItemID) inv
                    ON inv.ARSOItemID = so.ARSOItemID
                    {1}
                ", QuerySaleMonitor(), strWhere);
            return GetDataSet(strQuery);
        }
        public DataSet GetAllShpPlan(int iObjectID, int type = 0)
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  ARShpPlanID AS FK_ARShpPlanID,
                                    ARShpPlanItemID AS FK_ARShpPlanItemID,
                                    ARShpPlanItemQty AS ViewSaleMonitorShpPlanQty,
                                    FK_ICProductID, FK_ICUOMID,FK_ARSOID,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType
                            FROM    #ViewShpPlan shpplan
                            JOIN    #ViewSO so ON so.ARSOItemID = shpplan.ARSOItemID
                            ", QuerySaleMonitor(type, iObjectID.ToString()));
            return GetDataSet(strQuery);
        }
        public DataSet GetAllPkgOrder(int iObjectID, int type = 0)
        {
            return GetAllPkgOrder(iObjectID.ToString(), type);
        }
        public DataSet GetAllPkgOrder(string iObjectID, int type = 0, string strCompare = "=")
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  PPPkgOrderID AS FK_PPPkgOrderID,
                                    PPPkgOrderItemID AS FK_PPPkgOrderItemID,
                                    PPPkgOrderItemQty AS ViewSaleMonitorPkgOrderQty,
                                    FK_ICProductID, FK_ICUOMID,
                                    (SELECT MAX(ARShpPlanID) FROM #ViewShpPlan shp WHERE shp.ARSOItemID = pkg.ARSOItemID) AS FK_ARShpPlanID,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType
                            FROM    #ViewPkgOrder pkg
                            JOIN    #ViewSO so ON so.ARSOItemID = pkg.ARSOItemID
                            ", QuerySaleMonitor(type, iObjectID, strCompare));
            return GetDataSet(strQuery);
        }
        public DataSet GetAllShipment(int iObjectID, int type = 0)
        {
            return GetAllShipment(iObjectID.ToString(), type);
        }
        public DataSet GetAllShipment(string iObjectID, int type = 0, string strCompare = "=")
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  ICShipmentID AS FK_ICShipmentID,
                                    ICShipmentItemID AS FK_ICShipmentItemID,
                                    ICShipmentItemQty AS ViewSaleMonitorShipmentQty,
                                    FK_ICProductID, FK_ICUOMID,
                                    (SELECT MAX(PPPkgOrderID) FROM #ViewPkgOrder WHERE ARSOItemID = ship.ARSOItemID) AS FK_PPPkgOrderID,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType
                            FROM    #ViewShp ship
                            JOIN    #ViewSO so ON so.ARSOItemID = ship.ARSOItemID
                            ", QuerySaleMonitor(type, iObjectID.ToString(), strCompare));
            return GetDataSet(strQuery);
        }
        public DataSet GetAllInvoice(int iObjectID, int type = 0)
        {
            return GetAllInvoice(iObjectID.ToString(), type);
        }
        public DataSet GetAllInvoice(string iObjectID, int type = 0, string strCompare = "=")
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  ARInvoiceID AS FK_ARInvoiceID,
                                    ARInvoiceItemID AS FK_ARInvoiceItemID,
                                    ARInvoiceItemQty AS ViewSaleMonitorInvoiceQty,
                                    FK_ICProductID, FK_ICUOMID,
                                    (SELECT MAX(ICShipmentID) FROM #ViewShp WHERE ARSOItemID = inv.ARSOItemID) AS FK_ICShipmentID,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType
                            FROM    #ViewInv inv
                            JOIN    #ViewSO so ON so.ARSOItemID = inv.ARSOItemID
                            ", QuerySaleMonitor(type, iObjectID.ToString(), strCompare));
            return GetDataSet(strQuery);
        }
        public DataSet GetDetailShpPlan(int iShpPlanItemID)
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  c.ARShpPlanID AS FK_ARShpPlanID,
                                    ARShpPlanItemID AS FK_ARShpPlanItemID,
                                    ARShpPlanItemQty AS ViewSaleMonitorShpPlanQty,
                                    FK_ICProductID, FK_ICUOMID,FK_ARSOID,
                                    ARShpPlanDueDate AS ViewSaleMonitorShpPlanDate,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType,
                                    PPPkgOrderItemQty AS ViewSaleMonitorPkgOrderQty,
                                    ICShipmentItemQty AS ViewSaleMonitorShipmentQty,
                                    ARInvoiceItemQty AS ViewSaleMonitorInvoiceQty
                            FROM    #ViewShpPlan shpplan
                            JOIN    #ViewSO so ON so.ARSOItemID = shpplan.ARSOItemID
                            JOIN	ARShpPlans c ON shpplan.ARShpPlanID = c.ARShpPlanID
							--JOIN	ARCustomers d ON so.FK_ARCustomerID = d.ARCustomerID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(PPPkgOrderItemQty) PPPkgOrderItemQty FROM #ViewPkgOrder GROUP BY ARSOItemID) pkgorder 
                                ON pkgorder.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ICShipmentItemQty) ICShipmentItemQty FROM #ViewShp GROUP BY ARSOItemID) shp 
                                ON shp.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ARInvoiceItemQty) ARInvoiceItemQty FROM #ViewInv GROUP BY ARSOItemID) inv
                                ON inv.ARSOItemID = so.ARSOItemID

                            ", QuerySaleMonitor(1, iShpPlanItemID.ToString()));
            return GetDataSet(strQuery);
        }
        public DataSet GetDetailPkgOrder(int iPkgOrderItemID)
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  c.PPPkgOrderID AS FK_PPPkgOrderID,
                                    PPPkgOrderItemID AS FK_PPPkgOrderItemID,
                                    PPPkgOrderItemQty AS ViewSaleMonitorPkgOrderQty,
                                    FK_ICProductID, FK_ICUOMID,FK_ARSOID,
                                    PPPkgOrderDate AS ViewSaleMonitorShpPlanDate,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType,
                                    ARShpPlanItemQty AS ViewSaleMonitorShpPlanQty,
                                    ICShipmentItemQty AS ViewSaleMonitorShipmentQty,
                                    ARInvoiceItemQty AS ViewSaleMonitorInvoiceQty
                            FROM    #ViewPkgOrder pkg
                            JOIN    #ViewSO so ON so.ARSOItemID = pkg.ARSOItemID
                            JOIN	PPPkgOrders c ON pkg.PPPkgOrderID = c.PPPkgOrderID
							--JOIN	ARCustomers d ON so.FK_ARCustomerID = d.ARCustomerID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ARShpPlanItemQty) ARShpPlanItemQty FROM #ViewShpPlan GROUP BY ARSOItemID) shpplan 
                                ON shpplan.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ICShipmentItemQty) ICShipmentItemQty FROM #ViewShp GROUP BY ARSOItemID) shp 
                                ON shp.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ARInvoiceItemQty) ARInvoiceItemQty FROM #ViewInv GROUP BY ARSOItemID) inv
                                ON inv.ARSOItemID = so.ARSOItemID

                            ", QuerySaleMonitor(2, iPkgOrderItemID.ToString()));
            return GetDataSet(strQuery);
        }
        public DataSet GetDetailShipment(int iShipmentItemID)
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  c.ICShipmentID AS FK_ICShipmentID,
                                    ICShipmentItemID AS FK_ICShipmentItemID,
                                    ICShipmentItemQty AS ViewSaleMonitorShipmentQty,
                                    FK_ICProductID, FK_ICUOMID,so.FK_ARSOID,
                                    ICShipmentDate AS ViewSaleMonitorShpPlanDate,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType,
                                    ARShpPlanItemQty AS ViewSaleMonitorShpPlanQty,
                                    PPPkgOrderItemQty AS ViewSaleMonitorPkgOrderQty,
                                    ARInvoiceItemQty AS ViewSaleMonitorInvoiceQty
                            FROM    #ViewShp shp
                            JOIN    #ViewSO so ON so.ARSOItemID = shp.ARSOItemID
                            JOIN	ICShipments c ON shp.ICShipmentID = c.ICShipmentID
							--JOIN	ARCustomers d ON so.FK_ARCustomerID = d.ARCustomerID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ARShpPlanItemQty) ARShpPlanItemQty FROM #ViewShpPlan GROUP BY ARSOItemID) shpplan 
                                ON shpplan.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(PPPkgOrderItemQty) PPPkgOrderItemQty FROM #ViewPkgOrder GROUP BY ARSOItemID) pkg 
                                ON pkg.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ARInvoiceItemQty) ARInvoiceItemQty FROM #ViewInv GROUP BY ARSOItemID) inv
                                ON inv.ARSOItemID = so.ARSOItemID

                            ", QuerySaleMonitor(3, iShipmentItemID.ToString()));
            return GetDataSet(strQuery);
        }
        public DataSet GetDetailInvoice(int iInvoiceItemID)
        {
            string strQuery = string.Format(@"
                            {0}
                            
                            SELECT  c.ARInvoiceID AS FK_ARInvoiceID,
                                    ARInvoiceItemID AS FK_ARInvoiceItemID,
                                    ARInvoiceItemQty AS ViewSaleMonitorInvoiceQty,
                                    FK_ICProductID, FK_ICUOMID,FK_ARSOID,
                                    ARInvoiceDate AS ViewSaleMonitorShpPlanDate,
                                    so.ARCustomerNo AS ViewSaleMonitorObjectNo,
                                    so.ARCustomerName AS ViewSaleMonitorObjectName,
                                    'Customer' AS ViewSaleMonitorObjectType,
                                    ARShpPlanItemQty AS ViewSaleMonitorShpPlanQty,
                                    PPPkgOrderItemQty AS ViewSaleMonitorPkgOrderQty,
                                    ICShipmentItemQty AS ViewSaleMonitorShipmentQty
                            FROM    #ViewInv inv
                            JOIN    #ViewSO so ON so.ARSOItemID = inv.ARSOItemID
                            JOIN	ARInvoices c ON inv.ARInvoiceID = c.ARInvoiceID
							--JOIN	ARCustomers d ON so.FK_ARCustomerID = d.ARCustomerID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ARShpPlanItemQty) ARShpPlanItemQty FROM #ViewShpPlan GROUP BY ARSOItemID) shpplan 
                                ON shpplan.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(ICShipmentItemQty) ICShipmentItemQty FROM #ViewShp GROUP BY ARSOItemID) shp 
                                ON shp.ARSOItemID = so.ARSOItemID
                            LEFT JOIN (
	                                SELECT ARSOItemID,SUM(PPPkgOrderItemQty) PPPkgOrderItemQty FROM #ViewPkgOrder GROUP BY ARSOItemID) pkg
                                ON pkg.ARSOItemID = so.ARSOItemID

                            ", QuerySaleMonitor(4, iInvoiceItemID.ToString()));
            return GetDataSet(strQuery);
        }
    }
	#endregion
}